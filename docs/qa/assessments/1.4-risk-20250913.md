# Risk Profile: Story 1.4

Date: 2025-09-13 (UTC+8)
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 7
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 4
- Low Risks: 2
- Risk Score: 66/100

## Critical Risks Requiring Immediate Attention

- 无（本次未评定为 Critical=9 的风险）。最高为 High=6 的风险，需优先处置。

## Risk Distribution

### By Category

- Performance (PERF): 2 risks (0 critical)
- Technical (TECH): 1 risk (0 critical)
- Security (SEC): 1 risk (0 critical)
- Data (DATA): 1 risk (0 critical)
- Operational (OPS): 1 risk (0 critical)
- Business (BUS): 1 risk (0 critical)

### By Component

- Frontend: 3 risks
- Backend/API: 3 risks
- Infrastructure/Monitoring: 1 risk

## Detailed Risk Register

| ID        | Category   | Title                                                        | Probability | Impact | Score | Priority |
|-----------|------------|--------------------------------------------------------------|-------------|--------|-------|----------|
| PERF-001  | Performance| 首屏摘要 2 秒目标达成风险（接口延迟/包体过大/阻塞渲染）       | High (3)    | Medium (2) | 6   | High     |
| DATA-001  | Data       | 结果未就绪状态处理与占位轮询一致性，导出数据口径不一致       | Medium (2)  | Medium (2) | 4   | Medium   |
| TECH-001  | Technical  | Next.js 路由与懒加载策略集成复杂度导致回退或闪烁            | Medium (2)  | Medium (2) | 4   | Medium   |
| SEC-001   | Security   | `GET /backtests/{id}` 系列鉴权/越权与错误映射信息泄露        | Low (1)     | High (3)   | 3   | Low      |
| OPS-001   | Operational| 缺少对状态/结果接口的监控与报警，问题发现滞后                | Medium (2)  | Low (1)    | 2   | Low      |
| PERF-002  | Performance| 净值曲线渲染性能与导出大数据量（阻塞 UI 或内存峰值）         | Medium (2)  | Medium (2) | 4   | Medium   |
| BUS-001   | Business   | 2 秒不可达时用户感知差，影响留存（缺少降级与明确信号）        | Medium (2)  | Medium (2) | 4   | Medium   |

说明：评分采用 Probability × Impact；表中已按分数与优先级呈现。

## Mitigations & Testing Requirements

### PERF-001 首屏摘要 2 秒目标达成风险（Score 6）
- Strategy: preventive + detective
- Actions:
  - 按“摘要先行 → 曲线 → 明细”的加载顺序，确保 `summary-cards` SSR/早期渲染；曲线懒加载并关闭 SSR。
  - 使用 SWR/Query 轮询状态，结果就绪后再请求 `result`；并对 `status` 与 `result` 并行优化。
  - 限制首屏 JS 体积（动态导入图表、去除非首屏依赖）。
  - 合理超时/占位骨架与 `aria-live="polite"`，保证可用性与可达性反馈。
- Testing Requirements:
  - 单测与集成：虚拟时钟断言 2 秒内 `data-testid="summary-cards"` 可见；接口成功/失败/429/5xx 分支。
  - E2E：拦截结果接口返回固定片段，稳定 2 秒断言。
- Residual Risk: Low
- Owner: FE
- Timeline: Before merge to main

### DATA-001 结果未就绪/导出口径一致性（Score 4）
- Strategy: preventive
- Actions:
  - `packages/shared/src/backtest.ts` 定义 `ResultSummary/BacktestStatusResponse` 单一真源；前后端共享。
  - 导出 `toCSV/toJSON` 统一字段与顺序，错误回退明确。
- Testing Requirements:
  - 导出函数成功/失败分支单测；接口空态与错误映射覆盖。
- Residual Risk: Low
- Owner: FE/BE
- Timeline: Before release

### TECH-001 路由与懒加载集成复杂度（Score 4）
- Strategy: preventive
- Actions:
  - 在 `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx` 明确加载顺序与状态机；拆分 `SummaryCards` 与图表组件。
  - 关闭图表 SSR，使用 `dynamic(() => import(...), { ssr: false })`。
- Testing Requirements:
  - 组件级渲染与状态流单测；页面集成测试验证闪烁/回退路径。
- Residual Risk: Low
- Owner: FE
- Timeline: Before merge

### SEC-001 鉴权/错误映射泄露（Score 3）
- Strategy: preventive + detective
- Actions:
  - API 解析 Supabase JWT 并以 `ownerId` 过滤；统一 `ApiError` 映射，避免泄露内部信息。
- Testing Requirements:
  - API 集成测试覆盖 401/403/404；前端错误提示可读性验证。
- Residual Risk: Low
- Owner: BE
- Timeline: Before release

### OPS-001 监控与报警缺失（Score 2）
- Strategy: detective
- Actions:
  - 为 `GET /status` 与 `GET /result` 建立延迟/错误率指标与阈值报警；前端埋点 TTI/首屏摘要出现时间。
- Testing Requirements:
  - 验证报警阈值生效与告警通道。
- Residual Risk: Low
- Owner: DevOps/BE
- Timeline: Before GA

### PERF-002 曲线渲染与导出性能（Score 4）
- Strategy: preventive
- Actions:
  - 曲线数据分页/降采样；导出使用流式或分块处理，避免主线程阻塞。
- Testing Requirements:
  - 大数据量下渲染与导出性能基准；内存峰值监控。
- Residual Risk: Low
- Owner: FE
- Timeline: After beta

### BUS-001 2 秒不可达的用户感知（Score 4）
- Strategy: preventive
- Actions:
  - 显式显示“正在准备结果”，提供返回/重试；设置超时降级说明，维持期望管理。
- Testing Requirements:
  - 可用性测试与文案 A/B；无障碍读屏验证。
- Residual Risk: Low
- Owner: FE/PM
- Timeline: Before release

## Risk-Based Testing Strategy

- Priority 1 (High=6): 保障 2 秒摘要可见的端到端链路，含网络抖动与后端慢查询模拟。
- Priority 2 (Medium=4): 数据口径一致性、懒加载闪烁、曲线性能与导出。
- Priority 3 (Low=2-3): 监控/报警与安全错误映射。

## Risk Acceptance Criteria

- Must fix before production: 任意 Critical（9）与涉及安全/数据的 High（≥6）
- Can deploy with mitigation: Medium（4）具备补偿控制
- Accepted risks: 记录在 Gate 文件并获相应责任人签署

## Monitoring Requirements

- 后端：状态与结果接口 P95 延迟、错误率；
- 前端：首屏摘要出现时间、导出失败率；
- 安全：鉴权失败率异常攀升报警。

## Review Triggers

- 架构/API 变更、新增集成、发现性能/安全问题、合规要求变化时，更新本风险画像。
