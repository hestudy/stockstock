# Risk Profile: Story 1.3

Date: 2025-09-12
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 3
- Low Risks: 2
- Risk Score: 71/100

## Critical Risks Requiring Immediate Attention

无“Critical (9)”级别风险。最高风险为“High (6)”，详见下文 SEC-001。

## Risk Distribution

### By Category
- Security: 1 risks (0 critical, 1 high)
- Performance: 1 risks (0 critical)
- Data: 1 risks (0 critical)
- Business: 1 risks (0 critical)
- Operational: 1 risks (0 critical)
- Technical: 1 risks (0 critical)

### By Component
- Frontend: 3 risks (UX 提交流程、前端服务层、错误反馈)
- Backend/API: 3 risks (JWT 鉴权、速率限制与幂等、日志/追踪)
- Infrastructure: 1 risks（监控/限流配置）

## Detailed Risk Register

| Risk ID   | Category   | Title                                                         | Prob | Impact | Score | Priority |
|---------- |------------|---------------------------------------------------------------|------|--------|-------|----------|
| SEC-001   | Security   | JWT/Authorization 处理与受保护路由的一致性                   | 2    | 3      | 6     | High     |
| TECH-001  | Technical  | 共享类型契约与服务层 `buildSubmitPayload`/`submitBacktest` 对齐 | 2    | 2      | 4     | Medium   |
| OPS-001   | Operational| 幂等键 `clientRequestId` 透传与可观测性/追踪缺失             | 2    | 2      | 4     | Medium   |
| PERF-001  | Performance| 速率限制配置不当导致 429/重试风暴                            | 2    | 2      | 4     | Medium   |
| DATA-001  | Data       | 提交参数/错误日志可能包含敏感信息（泄露于日志/前端提示）      | 1    | 3      | 3     | Low      |
| BUS-001   | Business   | 成功反馈与导航不足导致重复提交/误操作                         | 2    | 1      | 2     | Low      |

### SEC-001: JWT/Authorization 处理与受保护路由的一致性
- Score: 6 (High)
- Probability: Medium (2) — 需在 Next.js App Router 与 API 层间正确解析/注入身份；本故事涉及受保护路由与服务层调用，易遗漏边界。
- Impact: High (3) — 身份处理不当可能导致越权访问、匿名请求被接受或拒绝合法请求。
- Mitigation:
  - 仅在服务器侧解析 JWT（参考 `docs/architecture/05-api-spec.md#L5`），前端不得持久化或拼接敏感头。
  - API 路由统一鉴权中间件（可与 Supabase/Sessions 集成），拒绝匿名访问；对角色/租户做细化校验。
  - 确保 `(dashboard)/backtests` 的受保护路由策略与 API 层一致，避免“前端保护、后端未校验”的缺口。
  - 针对 401/403 做分支处理与可读反馈，避免泄露内部细节。
- Testing Focus:
  - 集成测试：登录/未登录/权限不足 3 条路径；401/403 文案与重定向。
  - 安全测试：模拟令牌过期/伪造/撤销；确保都不可通过。

### TECH-001: 共享类型契约与服务层对齐
- Score: 4 (Medium)
- Probability: Medium (2) — `packages/shared` 与前端服务层常见出现类型/字段漂移。
- Impact: Medium (2) — 导致请求体不正确、后端解析失败或返回结构不符。
- Mitigation:
  - 在 `packages/shared/src/backtest.ts` 明确定义 `BacktestSubmitRequest/Response`；服务层与之单一来源对齐。
  - `buildSubmitPayload(draft)` 增加类型守卫/断言；单测覆盖空草稿/非法参数分支。
  - 在 CI 中加 `tsc --noEmit` 严格检查与 API 合约测试。
- Testing Focus:
  - Unit：payload 构造正确性与异常分支。
  - Integration：fetch mock 断言请求/响应结构。

### OPS-001: 幂等键透传与可观测性
- Score: 4 (Medium)
- Probability: Medium (2)
- Impact: Medium (2) — 幂等窗口不当或缺少追踪字段会造成重复入队或难以定位问题。
- Mitigation:
  - 前端服务层生成 UUID v4 `clientRequestId` 并随 `POST /api/v1/backtests` 发送；后端透传至队列与日志。
  - 将 `clientRequestId` 纳入结构化日志/Tracing（OpenTelemetry）与告警维度。
  - 在 5 分钟幂等窗口内返回同一 `id` 与语义化状态。
- Testing Focus:
  - Integration：重复提交返回相同 `id` 的幂等行为；日志含 requestId。

### PERF-001: 速率限制与重试风暴
- Score: 4 (Medium)
- Probability: Medium (2)
- Impact: Medium (2)
- Mitigation:
  - 服务端启用基于 IP/用户的令牌桶/漏桶限流；对提交接口设置合理阈值。
  - 前端对 429 实施退避（指数回退 + 抖动），并展示清晰节流提示，避免“疯狂重试”。
  - CI/E2E 中限制触发频率并在测试环境下放宽阈值。
- Testing Focus:
  - Integration：429 的退避与文案断言；多次提交后不应触发级联错误。

### DATA-001: 日志/提示中的敏感信息
- Score: 3 (Low)
- Probability: Low (1)
- Impact: High (3)
- Mitigation:
  - 前端错误提示走用户可读映射，避免直接展示后端 error.message/stack。
  - 服务器日志打红/脱敏策略（过滤 tokens、PII-like 参数）。
  - 在 `errors.ts` 建立错误码到友好文案的映射表。
- Testing Focus:
  - Unit：错误映射覆盖。
  - Security：确认日志不含敏感内容。

### BUS-001: 反馈与导航不足导致重复提交
- Score: 2 (Low)
- Probability: Medium (2)
- Impact: Low (1)
- Mitigation:
  - 成功后将 `id` 写入 store 并展示清晰的“查看状态”入口；禁用提交按钮短暂窗口；支持复制链接。
  - 禁用前置条件不足时的提交按钮，并提供可达性提示（aria-disabled/aria-live）。
- Testing Focus:
  - Unit：按钮状态切换与可达性。
  - E2E：提交后跳转与避免二次提交。

## Risk-Based Testing Strategy

### Priority 1: 针对 High 风险（SEC-001）
- 安全/鉴权相关：登录态/权限矩阵测试；令牌过期/伪造/撤销；API 路由中间件。
- E2E 钩子：登录→提交→返回 202 与 id→状态页入口。

### Priority 2: 针对 Medium 风险（TECH-001/OPS-001/ PERF-001）
- 合约对齐：ts 类型与契约测试；payload/response 集成断言。
- 幂等与追踪：重复提交行为验证；`clientRequestId` 贯穿日志与响应。
- 限流/退避：429 提示与指数回退。

### Priority 3: 针对 Low 风险（DATA-001/BUS-001）
- 错误文案映射覆盖；前端提示不泄露敏感信息。
- UX：按钮禁用、无障碍属性与导航动线。

## Risk Acceptance Criteria
- 必须修复：任意 Critical（9）；Security 相关的 High（6）需在合并前关闭或设严格补偿控制。
- 可带缓解发布：Medium（4）配套监控/告警与补偿措施。
- 可接受：Low（2-3）记录并纳入监控。

## Monitoring Requirements
- 安全：401/403 突增、匿名访问被拒绝率；Auth 中间件错误率。
- 性能/稳定性：429 比率、队列入队成功率、后端 5xx。
- 可观测性：`clientRequestId` 贯穿 traces/logs；面板中建立“提交成功率、重复提交、平均 TTFB”。

## Risk Review Triggers
- 架构调整（路由、鉴权、队列）
- 新增集成（策略模板、结果汇总）
- 新披露安全漏洞或依赖升级（Next.js、Supabase）
- 性能/错误指标异常

---

## Gate Paste: risk_summary (YAML)
```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 3
    low: 2
  highest:
    id: SEC-001
    score: 6
    title: 'JWT/Authorization handling on submit API'
  recommendations:
    must_fix:
      - 'Server-side JWT validation and consistent protected route enforcement'
      - 'Unify shared contract and service payload validation'
    monitor:
      - 'Alert on spikes in 401/403/429 and 5xx'
      - 'Trace submissions by clientRequestId across API/queue/logs'
```

## Story Hook Line
```
Risk profile: qa.qaLocation/assessments/1.3-risk-20250912.md
```
