# Requirements Traceability Matrix

## Story: 1.4 - Status & Basic Result

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 1 (14%)
- Partially Covered: 3 (43%)
- Not Covered: 3 (43%)

### Requirement Mappings

#### AC1: 状态查询入口（加载时请求 GET /api/v1/backtests/{id}/status 并展示基础信息/失败可重试）

Coverage: PARTIAL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts::summary visible within 2s`
  - Given: 详情页对 `status` 与 `result` 接口进行拦截，返回成功数据
  - When: 用户访问 `(dashboard)/backtests/{id}`
  - Then: 页面按流程触发状态与结果获取，进入可渲染态（未显式断言“status/progress/重试入口”文案）

Gaps:
- 未对“status/progress/重试入口/失败提示”进行显式断言（需 integration/unit 补充 UI 与错误映射）

---

#### AC2: 摘要首屏（2 秒）在 2 秒内渲染“结果概要卡”，结果未就绪时占位+轮询

Coverage: FULL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts::summary visible within 2s`
  - Given: 结果接口返回包含 `metrics` 的成功响应
  - When: 访问详情页并等待渲染
  - Then: `data-testid="summary-cards"` 在 2 秒内可见，且“夏普”文案出现

Notes:
- 轮询未就绪占位路径未在 E2E 中模拟（可加补充用例覆盖 pending → ready 流转）

---

#### AC3: 净值曲线（懒加载、缩放、tooltip，数据可导出）

Coverage: PARTIAL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts`
  - Given: `result` 返回包含 `equity` 数据
  - When: 页面加载
  - Then: 未显式断言图表渲染/缩放/tooltip（仅数据返回）

Gaps:
- 缺少对 `charts/EquityCurve` 渲染与交互（缩放/tooltip）的断言
- 缺少对懒加载完成态的断言

---

#### AC4: 结果导出（摘要与曲线数据导出 CSV/JSON 至少一种，失败提示）

Coverage: NONE

Gaps:
- 缺少针对导出按钮与 `toCSV/toJSON` 成功/失败分支的单测与集成测试
- 缺少用户可读失败提示的断言

---

#### AC5: 错误与空态（failed/early-stopped/canceled 与结果缺失的统一文案与入口）

Coverage: NONE

Gaps:
- 未覆盖失败/取消/空结果分支的 UI 文案映射与返回/重试入口
- 建议通过 integration + E2E 分别断言错误映射与可操作入口

---

#### AC6: 可达性（A11y：语义化、aria-live、按钮 aria-label、图表替代文本/空态说明）

Coverage: NONE

Gaps:
- 未对 `role="status"` + `aria-live="polite"`、按钮 `aria-label`、图表替代文本进行断言
- 建议：添加基于 Testing Library 的无障碍属性断言与 Playwright 可视回退文案检查

---

#### AC7: 测试覆盖（单元/集成覆盖状态轮询、2s 断言、错误/空态与导出；E2E 钩子）

Coverage: PARTIAL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts` 覆盖 2 秒摘要可见
- E2E: `apps/web/e2e/backtests.spec.ts` 覆盖提交回测后跳转状态页的基本流（Story 1.3 承接）

Gaps:
- 缺少单测/集成用例：状态轮询、导出、错误/空态

### Critical Gaps

1. 导出能力（AC4）
   - Gap: 无任何测试覆盖
   - Severity: High
   - Action: 为 `apps/web/src/utils/export.ts` 和详情页/曲线组件添加单测与集成；E2E 添加导出成功与失败提示断言

2. 错误与空态（AC5）
   - Gap: 无覆盖
   - Severity: High
   - Action: Integration：模拟 `failed/early-stopped/canceled/空结果`；E2E：验证统一文案与“返回/重试”入口

3. 可达性（AC6）
   - Gap: 无覆盖
   - Severity: Medium
   - Action: 单测/集成：断言 `role/aria-*`；E2E：替代文本存在性

### Test Design Recommendations

1. 增补 `apps/web/src/components/summary/SummaryCards.tsx` 与 `charts/EquityCurve.tsx` 的渲染/交互单测
2. `apps/web/src/services/backtests.ts` 集成测试：status/result 成功/429/5xx/空结果
3. `apps/web/src/utils/export.ts` 单测：CSV/JSON 成功/失败分支（抛错与提示）
4. Playwright E2E：
   - 结果未就绪 → 轮询 → 就绪渲染
   - 错误与空态统一文案与返回/重试
   - 导出按钮成功/失败提示
   - 图表可视与 tooltip 文案

### Risk Assessment

- High Risk: AC4、AC5 未覆盖
- Medium Risk: AC3、AC6 仅部分或未覆盖
- Low Risk: AC2 已有稳定 E2E 覆盖

### Output 1: Gate YAML Block (for gate file under `trace`)

```yaml
trace:
  totals:
    requirements: 7
    full: 1
    partial: 3
    none: 3
  planning_ref: "docs/qa/assessments/1.4-test-design-20250918.md"
  uncovered:
    - ac: "AC4"
      reason: "No tests for export success/failure user feedback"
    - ac: "AC5"
      reason: "No tests for error/empty states mapping and actions"
    - ac: "AC6"
      reason: "No a11y assertions on aria roles/labels and alt text"
  notes: "See docs/qa/assessments/1.4-trace-20250918.md"
```

### Story Hook Line

Trace matrix: docs/qa/assessments/1.4-trace-20250918.md
