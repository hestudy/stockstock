# Requirements Traceability Matrix

## Story: 1.4 - Status & Basic Result

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 1 (14%)
- Partially Covered: 6 (86%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: 状态查询入口（加载时请求 GET /api/v1/backtests/{id}/status 并展示基础信息/失败可重试）

Coverage: PARTIAL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts::summary visible within 2s`
  - Given: 详情页对 `status` 与 `result` 接口进行拦截，返回成功数据
  - When: 用户访问 `(dashboard)/backtests/{id}`
  - Then: 页面按流程触发状态与结果获取，进入可渲染态（未显式断言“status/progress/重试入口”文案）

Gaps:
- 未对“status/progress/重试入口/失败提示”进行显式断言（需 integration/unit 补充 UI 与错误映射）

Artifacts:
- Code: `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`（页面加载时触发状态获取与 UI 呈现）
- Code: `apps/web/src/services/backtests.ts`（`getBacktestStatus` 服务封装）
- API: `apps/web/src/app/api/v1/backtests/[id]/status/route.ts`（状态 API 路由，实现与错误返回）
- Types: `packages/shared/src/backtest.ts`（`BacktestStatusResponse/JobStatus`）
- Error Mapping: `apps/web/src/utils/errorMapping.ts`
- Auth: `apps/web/src/app/api/_lib/auth.ts`（JWT 解析与 owner 过滤）

---

#### AC2: 摘要首屏（2 秒）在 2 秒内渲染“结果概要卡”，结果未就绪时占位+轮询

Coverage: FULL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts::summary visible within 2s`
  - Given: 结果接口返回包含 `metrics` 的成功响应
  - When: 访问详情页并等待渲染
  - Then: `data-testid="summary-cards"` 在 2 秒内可见，且“夏普”文案出现

Notes:
- 轮询未就绪占位路径未在 E2E 中模拟（可加补充用例覆盖 pending → ready 流转）

Artifacts:
- UI: `apps/web/src/components/summary/SummaryCards.tsx`（摘要卡组件，2s 首屏目标）
- Page: `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`（轮询策略与渲染时序）
- Service: `apps/web/src/services/backtests.ts`（`getBacktestResult`）
- Tests: `apps/web/src/components/summary/__tests__/SummaryCards.test.tsx`（应包含占位/就绪断言）
- E2E: `e2e/backtests-detail.spec.ts`

---

#### AC3: 净值曲线（懒加载、缩放、tooltip，数据可导出）

Coverage: PARTIAL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts`
  - Given: `result` 返回包含 `equity` 数据
  - When: 页面加载
  - Then: 未显式断言图表渲染/缩放/tooltip（仅数据返回）

Gaps:
- 缺少对 `charts/EquityCurve` 渲染与交互（缩放/tooltip）的断言
- 缺少对懒加载完成态的断言

Artifacts:
- UI: `apps/web/src/components/charts/EquityCurve.tsx`（净值曲线组件，SSR 关闭、懒加载）
- Tests: `apps/web/src/components/charts/__tests__/EquityCurve.test.tsx`（应覆盖渲染与交互）
- Page: `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`（懒加载触发与容器）
- Data: `apps/web/src/services/backtests.ts`（`getBacktestResult` 提供 `equity`）

---

#### AC4: 结果导出（摘要与曲线数据导出 CSV/JSON 至少一种，失败提示）

Coverage: PARTIAL

Given-When-Then Mappings:
- Unit: `apps/web/src/utils/__tests__/export.test.ts` 覆盖 `toCSV/toJSON` 成功/失败分支
- Unit: `apps/web/src/components/summary/__tests__/SummaryCards.test.tsx` 断言导出失败触发用户可读提示
- Integration: `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx` 覆盖导出入口存在与失败提示

Gaps:
- E2E 未覆盖导出成功/失败路径（建议补充拦截与断言）

Artifacts:
- Utils: `apps/web/src/utils/export.ts`（`toCSV/toJSON`）
- UI: `apps/web/src/components/charts/EquityCurve.tsx` 或详情页按钮（导出触发点）
- Tests: `apps/web/src/utils/__tests__/export.test.ts`
- Tests: `apps/web/src/components/summary/__tests__/SummaryCards.test.tsx`
- Integration: `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx`

---

#### AC5: 错误与空态（failed/early-stopped/canceled 与结果缺失的统一文案与入口）

Coverage: PARTIAL

Given-When-Then Mappings:
- Integration: `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx`
  - Given: API 返回 `failed/early-stopped/canceled` 或 `result` 缺失
  - When: 渲染详情页
  - Then: 显示统一错误映射文案，并提供“返回列表/重试”入口

Gaps:
- E2E 未覆盖失败/取消/空结果路径（建议在 Playwright 中补充）

Artifacts:
- Error Mapping: `apps/web/src/utils/errorMapping.ts`（统一文案映射）
- Page/UI: `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`（错误/空态展示与“返回/重试”入口）
- API: `apps/web/src/app/api/v1/backtests/[id]/status/route.ts`、`apps/web/src/app/api/v1/backtests/[id]/result/route.ts`（错误结构 `ApiError`）
- Types: `packages/shared/src/backtest.ts`（错误结构/可空字段）
- Tests: `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx`

---

#### AC6: 可达性（A11y：语义化、aria-live、按钮 aria-label、图表替代文本/空态说明）

Coverage: PARTIAL

Given-When-Then Mappings:
- Integration: `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx`
  - Given: 页面渲染完成
  - Then: 摘要区块具有 `role="status"` + `aria-live="polite"`；按钮具备 `aria-label`；图表容器提供替代文本/空态说明
- Unit: `apps/web/src/components/summary/__tests__/SummaryCards.test.tsx` 断言 `role` 与 `aria-live`

Gaps:
- E2E 尚未检查替代文本与可达性属性（建议补充）

Artifacts:
- A11y: `apps/web/src/components/summary/SummaryCards.tsx`（`role="status"` + `aria-live="polite"`）
- A11y: `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`（按钮 `aria-label` 与可键盘操作）
- A11y: `apps/web/src/components/charts/EquityCurve.tsx`（替代文本/空态说明）
- Tests: `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx`
- Tests: `apps/web/src/components/summary/__tests__/SummaryCards.test.tsx`

---

#### AC7: 测试覆盖（单元/集成覆盖状态轮询、2s 断言、错误/空态与导出；E2E 钩子）

Coverage: PARTIAL

Given-When-Then Mappings:

- E2E: `apps/web/e2e/backtests-detail.spec.ts` 覆盖 2 秒摘要可见
- E2E: `apps/web/e2e/backtests.spec.ts` 覆盖提交回测后跳转状态页的基本流（Story 1.3 承接）

Gaps:
- 缺少单测/集成用例：状态轮询、导出、错误/空态

Artifacts:
- Unit: `apps/web/src/components/summary/__tests__/SummaryCards.test.tsx`
- Unit: `apps/web/src/components/charts/__tests__/EquityCurve.test.tsx`
- Integration: `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx`
- Service Tests: `apps/web/src/__tests__/backtests.result.service.test.ts`
- E2E: `e2e/backtests-detail.spec.ts`, `e2e/backtests.spec.ts`
- Strategy Ref: `docs/architecture/11-testing-strategy.md`

### Critical Gaps

1. 导出能力（AC4）
   - Gap: 局部覆盖到位（单测/集成），E2E 仍缺
   - Severity: Medium
   - Action: 在 Playwright 中补充导出成功/失败提示的拦截与断言

2. 错误与空态（AC5）
   - Gap: 集成覆盖已补充，E2E 仍缺
   - Severity: Medium
   - Action: E2E：验证统一文案与“返回/重试”入口

3. 可达性（AC6）
   - Gap: 单测/集成覆盖已补充，E2E 仍缺
   - Severity: Low
   - Action: E2E：替代文本与无障碍属性检查

### Test Design Recommendations

1. 增补 `apps/web/src/components/summary/SummaryCards.tsx` 与 `charts/EquityCurve.tsx` 的渲染/交互单测
2. `apps/web/src/services/backtests.ts` 集成测试：status/result 成功/429/5xx/空结果
3. `apps/web/src/utils/export.ts` 单测：CSV/JSON 成功/失败分支（抛错与提示）
4. Playwright E2E：
   - 结果未就绪 → 轮询 → 就绪渲染
   - 错误与空态统一文案与返回/重试
   - 导出按钮成功/失败提示
   - 图表可视与 tooltip 文案

### Risk Assessment

- Medium Risk: AC4、AC5 E2E 未覆盖
- Medium Risk: AC3 仍为部分覆盖
- Low Risk: AC2 已有稳定 E2E 覆盖；AC6 单测/集成已补充

### Output 1: Gate YAML Block (for gate file under `trace`)

```yaml
trace:
  totals:
    requirements: 7
    full: 1
    partial: 6
    none: 0
  planning_ref: "docs/qa/assessments/1.4-test-design-20250918.md"
  uncovered: []
  notes: "See docs/qa/assessments/1.4-trace-20250918.md"
```

### Story Hook Line

Trace matrix: docs/qa/assessments/1.4-trace-20250918.md
