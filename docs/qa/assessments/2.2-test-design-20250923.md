# Test Design: Story 2.2

Date: 2025-09-23
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 4 (36%)
- Integration tests: 5 (45%)
- E2E tests: 2 (18%)
- Priority distribution: P0: 6, P1: 5, P2: 0, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: 父作业拆分与子任务入队

| ID             | Level       | Priority | Test | Justification | Mitigates Risks |
| -------------- | ----------- | -------- | ---- | ------------- | ---------------- |
| 2.2-UNIT-001   | unit        | P0       | 验证 `OptimizationJob` → `optimization_tasks` 拆分逻辑，确保参数归一化、ID 唯一性与 owner 继承 | 核心纯逻辑，需快速发现拆分退化 | ["PERF-210"] |
| 2.2-INT-001    | integration | P0       | `POST /api/v1/optimizations` 创建父作业后检查 Redis/DB 中的任务记录与入队顺序 | 需验证 API、数据库、队列协同 | ["PERF-210"] |

### AC2: 并发闸门与排队限制

| ID             | Level       | Priority | Test | Justification | Mitigates Risks |
| -------------- | ----------- | -------- | ---- | ------------- | ---------------- |
| 2.2-UNIT-002   | unit        | P0       | Orchestrator 并发计数与闸门决策函数，覆盖边界值（=limit、limit-1、limit+1） | 纯函数逻辑，需快速验证上限计算 | ["TECH-301"] |
| 2.2-INT-002    | integration | P0       | 多实例 Orchestrator 并发竞争：模拟 2 个实例同时入队，验证 active/queued 列表一致 | 跨进程一致性需集成层验证 | ["TECH-301","PERF-210"] |
| 2.2-E2E-001    | e2e         | P1       | 压测提交超限作业，确认响应携带 `x-queue-throttled`、作业节流状态可见 | 端到端保障用户反馈与节流体验 | ["PERF-210"] |

### AC3: 重试与指数退避

| ID             | Level       | Priority | Test | Justification | Mitigates Risks |
| -------------- | ----------- | -------- | ---- | ------------- | ---------------- |
| 2.2-UNIT-003   | unit        | P0       | 根据错误类型计算退避时间（参数/上游/内部），校验最大重试阈值与回退策略 | 纯算法逻辑易在单元层校验 | ["PERF-210"] |
| 2.2-INT-003    | integration | P0       | 模拟任务连续失败，验证重试计数、`nextRunAt`、最终熔断状态及错误记录 | 需验证 Orchestrator 与存储/队列交互 | ["PERF-210","OPS-125"] |

### AC4: 进度聚合与 Top-N

| ID             | Level       | Priority | Test | Justification | Mitigates Risks |
| -------------- | ----------- | -------- | ---- | ------------- | ---------------- |
| 2.2-UNIT-004   | unit        | P1       | Summary 聚合器：输入多种任务状态与得分，验证 `finished/running/throttled/topN` 更新与排序稳定 | 核心聚合逻辑适合单测覆盖 | ["DATA-140"] |
| 2.2-INT-004    | integration | P1       | `GET /api/v1/optimizations/{id}/status` 在多租户上下文下返回实时 Summary/Top-N，并校验 owner 过滤与缓存失效 | 需验证 API、防穿透与数据一致性 | ["DATA-140","SEC-130"] |
| 2.2-E2E-002    | e2e         | P1       | Web UI 作业详情页实时刷新进度与 Top-N，验证节流提示与多租户隔离显示 | 用户旅程验证输出体验 | ["DATA-140"] |

### AC5: 测试与质量门挂钩

| ID             | Level       | Priority | Test | Justification | Mitigates Risks |
| -------------- | ----------- | -------- | ---- | ------------- | ---------------- |
| 2.2-INT-005    | integration | P1       | CI/CD 流水线执行 orchestrator Pytest、API 集成测试并上报排队/退避指标，验证失败即阻断发布及指标写入 | 通过管线验证测试与监控钩子生效 | ["OPS-125"] |

## Risk Coverage

| Risk ID  | Covered By |
| -------- | ---------- |
| TECH-301 | 2.2-UNIT-002, 2.2-INT-002 |
| PERF-210 | 2.2-UNIT-001, 2.2-INT-001, 2.2-E2E-001, 2.2-UNIT-003, 2.2-INT-003 |
| DATA-140 | 2.2-UNIT-004, 2.2-INT-004, 2.2-E2E-002 |
| SEC-130  | 2.2-INT-004 |
| OPS-125  | 2.2-INT-003, 2.2-INT-005 |

## Recommended Execution Order

1. P0 单元测试：2.2-UNIT-001, 2.2-UNIT-002, 2.2-UNIT-003
2. P0 集成测试：2.2-INT-001, 2.2-INT-002, 2.2-INT-003
3. P1 集成/端到端：2.2-INT-004, 2.2-INT-005, 2.2-E2E-001, 2.2-E2E-002
4. P1 单元测试：2.2-UNIT-004（可与 P0 单测并行）

## Quality Checklist

- [x] 每个 AC 至少一个场景
- [x] 测试层级符合决策矩阵
- [x] 无冗余重复覆盖
- [x] 优先级与业务风险匹配
- [x] 测试 ID 符合命名规范
- [x] 场景原子化且可独立执行
