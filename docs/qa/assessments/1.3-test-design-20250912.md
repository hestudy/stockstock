# Test Design: Story 1.3

Date: 2025-09-12
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 18
- Unit tests: 6 (33%)
- Integration tests: 8 (44%)
- E2E tests: 4 (22%)
- Priority distribution: P0: 7, P1: 7, P2: 4

## Test Scenarios by Acceptance Criteria

### AC1: 提交入口

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification                                       |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 1.3-UNIT-001  | Unit        | P2       | 提交按钮禁用/启用逻辑（空草稿/非法参数时禁用；aria-disabled 提示）                | 纯前端状态与可达性逻辑，单元即可                           |
| 1.3-INT-001   | Integration | P1       | 点击“提交回测”触发服务层 `submitBacktest`，成功回传 `id` 写入 store             | 组件与服务交互、状态写入，需要集成验证                       |
| 1.3-E2E-001   | E2E         | P1       | 登录→(dashboard)/backtests→点击提交（拦截网络）→显示成功提示与“查看状态”入口     | 关键用户旅程验证                                         |
| 1.3-INT-002   | Integration | P2       | 未登录访问 `(dashboard)/backtests` 被重定向至 `/login`                         | 受保护路由与中间件一致性（与 SEC-001 风险相关）                |

Mitigates: [SEC-001, BUS-001]

---

### AC2: Payload 契约

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification                                       |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 1.3-UNIT-002  | Unit        | P0       | `buildSubmitPayload(draft)` 生成 `{ versionId, params }` 的正确结构与类型守卫      | 纯函数逻辑与类型校验                                       |
| 1.3-UNIT-003  | Unit        | P0       | `buildSubmitPayload` 空草稿/非法参数抛错分支覆盖                           | 失败分支防回归                                           |
| 1.3-INT-003   | Integration | P0       | `submitBacktest(payload)` 发起 `POST /api/v1/backtests`，断言请求体/响应结构       | 服务与 API 合同对齐（TECH-001）                             |
| 1.3-INT-004   | Integration | P1       | 服务层不拼接敏感头；JWT 仅服务器侧解析（如 Next.js Route Handler 注入）           | 安全边界验证（SEC-001）                                    |

Mitigates: [TECH-001, SEC-001, DATA-001]

---

### AC3: 成功反馈

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification                                       |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 1.3-INT-005   | Integration | P1       | `202 Accepted` 响应 `{ id, status }` 被前端正确接收与渲染 toast/inline 成功提示     | 组件-服务-UI 交互                                       |
| 1.3-INT-006   | Integration | P1       | 将 `id` 写入 store，并渲染“查看状态”按钮（可跳转 `/backtests/{id}`）             | 关键路径数据贯通                                         |
| 1.3-E2E-002   | E2E         | P1       | 成功提交后用户可点击跳转至 `/backtests/{id}`（或可选自动跳转）                   | 端到端验证用户可达性与导航                                 |

Mitigates: [BUS-001]

---

### AC4: 失败处理

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification                                       |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 1.3-UNIT-004  | Unit        | P1       | 错误映射模块：将 4xx/5xx/超时/网络错误映射为用户可读文案（不泄露敏感信息）          | 纯映射逻辑，适合单测                                       |
| 1.3-INT-007   | Integration | P0       | 失败路径：429/4xx/5xx/超时 分别断言提示与退避提示（对 429 启用指数回退+抖动）      | 涉及服务与 UI，需集成验证（PERF-001）                        |
| 1.3-E2E-003   | E2E         | P2       | 拦截网络返回 500，页面展示友好错误提示，不显示技术细节                          | 用户旅程在异常下的稳健性                                     |

Mitigates: [PERF-001, DATA-001]

---

### AC5: 速率与幂等

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification                                       |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 1.3-UNIT-005  | Unit        | P1       | 生成 UUID v4 `clientRequestId` 的工具函数正确性                           | 纯逻辑校验                                             |
| 1.3-INT-008   | Integration | P0       | 重复提交（相同 `clientRequestId`）返回相同 `id` 的幂等行为断言                 | 合同与后端行为验证（OPS-001）                               |
| 1.3-INT-009   | Integration | P1       | 429 场景：实施退避策略（指数回退+抖动）与 UI 节流提示                         | 限流/退避策略验证（PERF-001）                                |

Mitigates: [OPS-001, PERF-001]

---

### AC6: 测试覆盖钩子

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification                                       |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 1.3-UNIT-006  | Unit        | P2       | 单测：`buildSubmitPayload` 与按钮可达性断言覆盖率基线                         | 单元维度基线                                             |
| 1.3-INT-010   | Integration | P1       | 集成：`submitBacktest` 成功/失败分支与 store 写入、错误提示                     | 关键分支覆盖                                             |
| 1.3-E2E-004   | E2E         | P2       | 登录→提交→拦截 `POST`→成功提示→“查看状态”按钮可用                          | 端到端钩子                                               |

Mitigates: [TECH-001, BUS-001]

---

### AC7: 幂等与请求标识

#### Scenarios

| ID            | Level       | Priority | Test                                                                 | Justification                                       |
| ------------- | ----------- | -------- | -------------------------------------------------------------------- | --------------------------------------------------- |
| 1.3-INT-011   | Integration | P0       | 服务层随请求附带 `clientRequestId`，响应/日志中可关联（透传到队列/日志上下文）      | 端到端可观测性与一致性（OPS-001）                             |
| 1.3-INT-012   | Integration | P1       | 在 5 分钟幂等窗口内重复提交返回同一 `id` 与语义化状态                         | 幂等窗口与语义保证（OPS-001）                                 |

Mitigates: [OPS-001]

## Risk Coverage

- SEC-001: 通过 `1.3-INT-004`, `1.3-INT-002` 验证受保护路由一致性与服务器侧 JWT 解析。
- TECH-001: 通过 `1.3-UNIT-002`, `1.3-UNIT-003`, `1.3-INT-003`, `1.3-INT-010` 保证共享契约与服务层一致。
- OPS-001: 通过 `1.3-UNIT-005`, `1.3-INT-008`, `1.3-INT-011`, `1.3-INT-012` 验证幂等键与透传。
- PERF-001: 通过 `1.3-INT-007`, `1.3-INT-009` 验证 429 限流与退避策略。
- DATA-001: 通过 `1.3-UNIT-004`, `1.3-E2E-003` 保证错误提示脱敏与日志不泄露。
- BUS-001: 通过 `1.3-INT-005`, `1.3-INT-006`, `1.3-E2E-002` 确保成功反馈与导航，避免重复提交。

## Recommended Execution Order

1. P0 Unit tests（fail fast）
2. P0 Integration tests
3. P0 E2E tests
4. P1 测试按级别顺序
5. P2 测试在时间允许时补全

## Gate Paste: test_design (YAML)

```yaml
test_design:
  scenarios_total: 18
  by_level:
    unit: 6
    integration: 8
    e2e: 4
  by_priority:
    p0: 7
    p1: 7
    p2: 4
  coverage_gaps: []
```

## Trace References

```
Test design matrix: qa.qaLocation/assessments/1.3-test-design-20250912.md
P0 tests identified: 7
```
