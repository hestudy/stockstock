# Test Design: Story 1.5 — Minimal Observability

Date: 2025-09-19
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 6 (40%)
- Integration tests: 6 (40%)
- E2E tests: 3 (20%)
- Priority distribution: P0: 8, P1: 6, P2: 1

Rationale:
- Shift-left，单测覆盖纯逻辑与封装；集成聚焦 API 路由与 Workers 关键交互；E2E 仅验证关键用户旅程与 2s 首屏目标的埋点触发。
- 风险驱动，优先覆盖 OPS-001、SEC-001、DATA-001、OPS-002。

## Test Scenarios by Acceptance Criteria

### AC1: 结构化日志（前端/后端/Workers）

#### Scenarios

| ID               | Level       | Priority | Test                                                                             | Justification                               | mitigates_risks           |
| ---------------- | ----------- | -------- | -------------------------------------------------------------------------------- | ------------------------------------------- | ------------------------- |
| 1.5-UNIT-001     | Unit        | P1       | FE 错误映射函数：将错误码映射为用户可读提示                                      | 纯映射逻辑，易于单测                         | SEC-001, BUS-001          |
| 1.5-UNIT-002     | Unit        | P1       | FE `observability.trackError` 序列化与标签（路由/会话）                          | 纯封装/序列化逻辑                            | OPS-001                   |
| 1.5-INT-001      | Integration | P0       | API `wrap()` 输出统一 `ApiError` 结构并记录路由/状态码（成功/4xx/5xx）          | 多组件交互（路由处理、错误包装、日志/指标）  | SEC-001, OPS-001, OPS-002 |
| 1.5-INT-002      | Integration | P0       | API 失败路径（4xx/5xx）写结构化错误日志且不泄露内部字段                         | 合规/安全关键                                | SEC-001                   |
| 1.5-INT-003      | Integration | P1       | Workers 异常分类码（参数/上游/内部）写入结构化日志，字段完整（jobId/ownerId 等） | 组件与日志后端/控制台交互                     | OPS-001                   |
| 1.5-UNIT-003     | Unit        | P0       | Workers 日志脱敏 helper：对 PII（邮箱/手机号）做掩码                             | 安全关键逻辑                                 | DATA-001, SEC-001         |

### AC2: 时延与性能指标（最小集）

#### Scenarios

| ID               | Level       | Priority | Test                                                                                 | Justification                              | mitigates_risks |
| ---------------- | ----------- | -------- | ------------------------------------------------------------------------------------ | ------------------------------------------ | --------------- |
| 1.5-INT-004      | Integration | P0       | `GET /api/v1/backtests/{id}/status` 记录直方图与计数（含路由/状态码 label）        | 指标与路由层交互关键                         | OPS-001, OPS-002 |
| 1.5-INT-005      | Integration | P0       | `GET /api/v1/backtests/{id}/result` 记录直方图与计数（成功/失败分支）               | 同上                                         | OPS-001, OPS-002 |
| 1.5-UNIT-004     | Unit        | P1       | FE `trackSummaryRendered(ms)` 正确生成事件负载（ms、路由、会话标签）                | 纯封装/数据校验                              | PERF-001        |
| 1.5-E2E-001      | E2E         | P1       | 回测详情页加载流程触发“摘要渲染耗时”埋点（可通过拦截/SDK mock 验证）              | 关键用户旅程与观测点                         | PERF-001, OPS-001 |

### AC3: 统一错误分类与用户提示

#### Scenarios

| ID               | Level       | Priority | Test                                                                 | Justification                | mitigates_risks      |
| ---------------- | ----------- | -------- | -------------------------------------------------------------------- | ---------------------------- | -------------------- |
| 1.5-UNIT-005     | Unit        | P0       | API 层 `ApiError` 序列化仅包含安全字段的函数                          | 安全/合规关键                | SEC-001              |
| 1.5-E2E-002      | E2E         | P1       | 客户端在常见错误（鉴权/参数/频控/上游不可用）显示一致可读提示        | 端到端用户体验                | BUS-001, SEC-001     |
| 1.5-INT-006      | Integration | P1       | FE 与 API 配合：触发 4xx/429/5xx 时，API 返回体符合 `ApiError` Schema | 接口契约与前后端交互          | SEC-001, BUS-001     |

### AC4: 可配置与最小依赖

#### Scenarios

| ID               | Level       | Priority | Test                                                                                   | Justification                  | mitigates_risks |
| ---------------- | ----------- | -------- | -------------------------------------------------------------------------------------- | ------------------------------ | --------------- |
| 1.5-UNIT-006     | Unit        | P1       | 前端/后端 `OBS_ENABLED` 特性开关逻辑（启用/禁用时的分支选择）                         | 纯配置分支逻辑                 | OPS-002          |
| 1.5-E2E-003      | E2E         | P2       | 在禁用观测开关时，关键路径仍可运行（不崩溃、不报错），不产出观测事件                 | 端到端回归与配置有效性         | OPS-002          |

### AC5: 测试闭环（策略保证）

- 通过上述场景确保单测/集成/E2E 的最小闭环已覆盖关键路径，无需额外独立场景。

## Risk Coverage

映射至 `docs/qa/assessments/1.5-risk-20250919.md`：

- OPS-001：1.5-INT-001/002/004/005、1.5-E2E-001
- SEC-001：1.5-UNIT-001、1.5-INT-001/002、1.5-UNIT-005、1.5-INT-006、1.5-E2E-002
- DATA-001：1.5-UNIT-003
- OPS-002：1.5-INT-001/004/005、1.5-UNIT-006、1.5-E2E-003
- PERF-001：1.5-UNIT-004、1.5-E2E-001
- BUS-001：1.5-UNIT-001、1.5-INT-006、1.5-E2E-002

## Recommended Execution Order

1. P0 Unit tests（快速失败）：1.5-UNIT-003、1.5-UNIT-005
2. P0 Integration tests：1.5-INT-001/002/004/005
3. P0 相关 E2E：无（P0 E2E 不设，控制金字塔成本）
4. P1 测试：1.5-UNIT-001/002/004、1.5-INT-003/006、1.5-E2E-001/002
5. P2 测试：1.5-E2E-003

## References to Code Locations (proposed)

- FE 封装：`apps/web/src/utils/observability.ts`
- FE 页面：`apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`
- API 指标封装：`apps/web/src/app/api/_lib/otel.ts`
- API 错误包装：`apps/web/src/app/api/_lib/handler.ts`
- Workers 日志：`services/backtest/app/observability.py`
- E2E：`apps/web/e2e/backtests-detail.spec.ts`（或现有 e2e 目录）
- API 测试：`apps/web/src/app/api/**/__tests__/*.test.ts`
- Workers 测试：`services/backtest/tests/test_observability.py`

## Gate YAML Snippet (test_design)

```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 6
    integration: 6
    e2e: 3
  by_priority:
    p0: 8
    p1: 6
    p2: 1
  coverage_gaps: []
```

## Trace References

```
Test design matrix: docs/qa/assessments/1.5-test-design-20250919.md
P0 tests identified: 8
```

## Quality Checklist

- [x] Every AC has test coverage
- [x] Test levels are appropriate (not over-testing)
- [x] No duplicate coverage across levels
- [x] Priorities align with business risk
- [x] Test IDs follow naming convention
- [x] Scenarios are atomic and independent
