# Risk Profile: Story 2.3

Date: 2025-09-24 (UTC+8)
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 2
- Medium Risks: 3
- Low Risks: 1
- Risk Score: 63/100

## Critical Risks Requiring Immediate Attention

- 无（当前未评定 Critical=9 风险）。存在 2 个 High=6 风险，需要在开发初期纳入重点设计与测试范围。

## Risk Distribution

### By Category

- Technical (TECH): 1 risk (0 critical)
- Data (DATA): 1 risk (0 critical)
- Performance (PERF): 1 risk (0 critical)
- Operational (OPS): 1 risk (0 critical)
- Business (BUS): 1 risk (0 critical)
- Security (SEC): 1 risk (0 critical)

### By Component

- Python Orchestrator & Workers: 4 risks
- API & Auth 层（取消入口）: 1 risk
- Top-N 结果与产品体验: 1 risk

## Detailed Risk Register

| ID        | Category    | Title                                                                       | Probability | Impact | Score | Priority |
|-----------|-------------|-----------------------------------------------------------------------------|-------------|--------|-------|----------|
| TECH-001  | Technical   | 早停阈值比较逻辑错误导致误停或无法停机                                      | Medium (2)  | High (3)   | 6   | High     |
| DATA-001  | Data        | Worker 回写与父作业 summary/Top-N 同步不一致                                | Medium (2)  | High (3)   | 6   | High     |
| PERF-001  | Performance | 早停/取消后 Worker 轮询未及时收敛，导致 CPU 空转与队列压力                 | Medium (2)  | Medium (2) | 4   | Medium   |
| OPS-001   | Operational | 取消/早停状态未传播到运行中任务，产生“僵尸执行”与重复写入                  | Medium (2)  | Medium (2) | 4   | Medium   |
| BUS-001   | Business    | 早停冻结 Top-N 但最佳组合尚未执行完，导致结果质量与用户信任下降            | Medium (2)  | Medium (2) | 4   | Medium   |
| SEC-001   | Security    | 取消入口鉴权/租户隔离缺失导致越权终止他人作业                              | Low (1)     | High (3)   | 3   | Low      |

> 评分标准：Probability × Impact；表格已按分数与优先级排序。

## Mitigations & Testing Requirements

### TECH-001 早停阈值比较逻辑错误（Score 6）
- Strategy: preventive + detective
- Actions:
  - 在 Orchestrator 侧封装 `should_trigger_early_stop(metric_value, policy)` 辅助方法，明确 `mode=min|max` 与阈值比较方向，确保浮点比较包含等号与容差。
  - 在 Job 状态锁内执行早停决策与派发终止操作，避免竞态导致重复判断。
- Testing Requirements:
  - Python 单测覆盖 `min`/`max` 模式、有无阈值、边界等场景。
  - 集成测试：模拟多个任务返回并断言早停后不再出队，状态为 `early-stopped` 且原因记录完整。
- Residual Risk: Low
- Owner: Backend (Python)
- Timeline: Before merge

### DATA-001 Worker 回写与 summary/Top-N 同步不一致（Score 6）
- Strategy: preventive
- Actions:
  - 保证 Worker 完成写入后以单事务更新 `optimization_tasks` 与父作业 summary，引入乐观锁或版本号避免覆盖。
  - `_refresh_summary` 中 top-N 排序与 finished 计数需在持久化后校正，并对失败/重试进行幂等处理。
- Testing Requirements:
  - 单测验证并发完成/失败/重试情况下 summary 与任务表一致。
  - 集成测试断言 UI/API 侧 `summary.total/finished/topN` 与数据库真实值一致。
- Residual Risk: Low
- Owner: Backend (Python + DB)
- Timeline: Before merge

### PERF-001 早停/取消后 Worker 空转（Score 4）
- Strategy: preventive + detective
- Actions:
  - Worker 拉取任务前检查父作业状态，若为 `early-stopped/canceled` 立即 sleep/backoff。
  - 引入 `queue_wait_seconds` 基线与告警阈值监控过量轮询。
- Testing Requirements:
  - 负载测试模拟高频取消/早停，观察 CPU 利用率与队列压力。
  - 单测覆盖 Worker 获取到空队列/停止状态时的退避逻辑。
- Residual Risk: Low
- Owner: Backend (Python)
- Timeline: Before release

### OPS-001 僵尸执行与重复写入（Score 4）
- Strategy: preventive
- Actions:
  - 在取消/早停时向运行中的任务发布终止信号并记录 `lastError`，Worker 需在结果回写前检查父作业状态。
  - 设计去重机制（基于任务版本或完成标记）确保重复写入被拒绝。
- Testing Requirements:
  - 集成测试：运行中的任务在收到取消后提前退出，父作业状态保持一致。
  - Chaos 测试模拟网络抖动或 Worker restart，确认不会重复记账。
- Residual Risk: Low
- Owner: Backend (Python)
- Timeline: Before release

### BUS-001 Top-N 冻结前最佳组合缺失（Score 4）
- Strategy: preventive + detective
- Actions:
  - 结合 early-stop 策略增加“最少完成数”或置信阈值，避免样本不足的情况下早停。
  - 在 UI/API 返回中清晰展示早停原因与完成数量，提示用户剩余潜在收益。
- Testing Requirements:
  - 端到端测试：构造高分任务在阈值后返回，验证 Top-N 仍包含该结果或给出提示。
  - 产品验收：确认用户体验文案与导出数据一致。
- Residual Risk: Medium
- Owner: Product + Backend
- Timeline: Before GA

### SEC-001 取消入口越权风险（Score 3）
- Strategy: preventive
- Actions:
  - API 层强制校验 Supabase/JWT 中的 `ownerId` 与作业 `owner_id` 匹配，返回统一错误码。
  - 使用共享类型 `OptimizationJob` 确保不可见字段不被泄露。
- Testing Requirements:
  - API 集成测试覆盖 401/403/404 分支，验证审计日志记录。
  - 安全扫描：模拟跨租户请求，确保拒绝并无信息泄露。
- Residual Risk: Low
- Owner: Backend (API)
- Timeline: Before release

## Risk-Based Testing Strategy

- Priority 1（High=6）: 早停逻辑与 summary/Top-N 一致性—需要 Python 单测 + Orchestrator 集成测试 + 数据一致性校验脚本。
- Priority 2（Medium=4）: Worker 退避、取消传播、用户体验与监控—覆盖端到端、队列压力与 UI 表现。
- Priority 3（Low=3）: 越权与日志—安全测试与监控告警验证。

## Risk Acceptance Criteria

- Must fix before production: 任意 High（≥6）风险需消除或具备强制性补偿控制。
- Can deploy with mitigation: Medium（4）需提供监控/回滚策略并在 Gate 记录。
- Accepted risks: 需获得产品/技术负责人书面确认并记录在 Gate 文件。

## Monitoring Requirements

- 队列：`queue_wait_seconds`、`active_jobs`、任务重试次数（区分取消/早停路径）。
- 作业生命周期：`job_exec_seconds`、`job_retry_total`、早停/取消原因分布。
- 安全：取消接口的 4xx/5xx 比例与跨租户访问告警。

## Review Triggers

- 早停策略或 Top-N 算法调整。
- Worker 并发/重试策略改变。
- 新增取消入口（UI/CLI）或鉴权方式变化。
- 监控基线或 SLO 阈值更新。

<!-- Risk profile: qa.qaLocation/assessments/2.3-risk-20250924.md -->
