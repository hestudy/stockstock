# Requirements Traceability Matrix

## Story: 1.1 - Auth & Health Canary

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 2 (40%)
- Partially Covered: 3 (60%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: 鉴权可用：基于 Supabase Auth 完成登录/注册与会话管理；未登录访问受保护路由将被重定向至登录页，并展示提示。

Coverage: PARTIAL

Given-When-Then Mappings:

- Unit/Component (route protection logic via layout)
  - Given: 未登录用户尝试访问受保护路由 `(dashboard)`
  - When: 触发会话检查
  - Then: 执行 `redirect("/login")` 并在登录页显示“未登录提示”
  - Reference: `apps/web/src/app/(dashboard)/layout.tsx`
  - Evidence: 存在路由保护实现；当前缺少明确单测用例引用

- E2E（关键路径：登录 → 访问受保护页）
  - Given: 用户位于登录页
  - When: 输入有效凭据完成登录并访问受保护页
  - Then: 成功进入受保护页并看到健康卡片
  - Evidence: 目前 E2E 覆盖未登录重定向（`apps/web/e2e/auth-health.spec.ts`），登录后访问受保护页的流尚未实现

#### AC2: 健康页可见：提供健康/金丝雀端点或页面，至少展示 API、Worker、Queue、Datasource 的状态快照。

Coverage: FULL

Given-When-Then Mappings:

- API Unit: `/api/v1/health`
  - Given: 服务健康信息聚合
  - When: 调用 `GET /api/v1/health`
  - Then: 返回包含 `service/status/details/ts` 的结构化数据
  - Test: `apps/web/src/__tests__/health.api.test.ts`

- Frontend Unit: `HealthCard`
  - Given: 从服务层获得健康数据
  - When: 组件渲染
  - Then: 展示 API/Worker/Queue/Datasource 的状态摘要
  - Test: `apps/web/src/__tests__/healthcard.component.test.tsx`

#### AC3: 状态可视：在健康页或相关 UI 可见队列/服务状态（up/degraded/down），并有最近时间戳。

Coverage: FULL

Given-When-Then Mappings:

- Frontend Unit: `HealthCard` 渲染
  - Given: 带时间戳的健康数据
  - When: 渲染摘要卡片
  - Then: 可见每个服务的状态；时间戳显示最近一次更新时间
  - Evidence: 组件测试覆盖 up/degraded/down 友好文案与时间戳展示（`apps/web/src/__tests__/healthcard.component.test.tsx`）

- Integration Idea
  - Given: API 返回带 `ts` 的健康数据
  - When: 前端服务层拉取并传入组件
  - Then: UI 中存在相对时间/格式化时间显示
  - Suggested Test: 新增集成测试补充时间戳断言

#### AC4: 错误提示：未登录、无权限或服务降级场景下，用户能看到清晰、非技术术语的错误文案。

Coverage: PARTIAL

Given-When-Then Mappings:

- Unit/Component: 统一错误文案服务 `errors.ts`
  - Given: 未登录/无权限/服务降级异常
  - When: 通过服务层返回标准化错误对象
  - Then: UI 展示非技术术语、清晰可理解的提示
  - Evidence: `apps/web/src/__tests__/errors.service.test.ts` 已覆盖 unauthenticated/forbidden/degraded/down/unknown 友好文案
  - Suggested Test: 增加组件/集成级别的文案呈现断言（UI 层）

#### AC5: 路由保护：前端 `(dashboard)` 段需有基于会话的保护逻辑；通过 E2E 验证基本登录 → 访问受保护页 → 跳转/展示正确内容路径。

Coverage: PARTIAL

Given-When-Then Mappings:

- Unit/Infra: 保护逻辑实现
  - Given: 未登录会话
  - When: 访问受保护段
  - Then: 触发重定向至 `/login`
  - Reference: `apps/web/src/app/(dashboard)/layout.tsx`

- E2E（缺失）
  - Given: 用户成功登录
  - When: 访问受保护页
  - Then: 能正常看到健康卡片（首屏不阻塞）
  - Suggested Test: 增加 Playwright/Cypress E2E 场景

### Critical Gaps

1. Performance/SLA（非本故事核心，但建议记录）
   - Gap: 对健康接口/页面的加载延迟与稳健性缺少基准测试
   - Risk: Medium
   - Action: 添加轻量级 Web 性能采样（如 vitest bench 或 Lighthouse CI 占位）

2. Error Copy（AC4）
   - Gap: 缺少 UI 组件/集成层对友好文案的呈现断言（当前仅服务层单测）
   - Risk: Medium
   - Action: 为典型错误态增加组件/集成测试

### Test Design Recommendations

1. 新增集成测试：验证 `ts` 时间戳展示与格式
2. 新增错误文案测试：覆盖未登录/无权限/降级三类
3. 新增 E2E：登录 → 访问受保护页 → 健康卡片可见
4. 使用 fixtures/mocks：稳定健康数据与错误态模拟

### Risk Assessment

- High Risk: 无覆盖（无）
- Medium Risk: 仅部分覆盖（AC1、AC4、AC5）
- Low Risk: 完整覆盖（AC2、AC3）
