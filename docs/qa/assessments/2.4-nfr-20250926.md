# NFR Assessment — Story 2.4 Progress & Aggregation

**Date:** 2025-09-26  
**Reviewed By:** Quinn (QA)  
**Scope:** security, performance, reliability, maintainability

## Summary

| NFR | Status | Notes |
| --- | --- | --- |
| Security | PASS | 导出与复运行路由复用 `resolveOwnerId` 与 orchestrator 所有权校验，集成用例覆盖越权/认证失败，确保仅原始 owner 可操作。 |
| Performance | PASS | 导出/复运行经 `timeHttp` 计时、参数规模预估与阈值限制，Pytest 断言不触发二次回测；UI 轮询采用 SWR/轮询策略验证负载行为。 |
| Reliability | PASS | Top-N/进度/复运行流程有单元、集成、E2E 多层验证，提前停止/取消保持终值且导出降级提示正常工作。 |
| Maintainability | PASS | 金字塔测试涵盖组件、API、后端与 E2E；共享类型与服务层复用确保实现与规范同步，故事文档列出测试命令与变更范围。 |

**Quality Score:** 92

## Evidence

### Security — PASS
- Next.js 导出与复运行路由在处理前解析 owner 并校验参数，确保非法 ID 拒绝：`apps/web/src/app/api/v1/optimizations/[id]/export/route.ts:5`、`apps/web/src/app/api/v1/optimizations/[id]/rerun/route.ts:5`。
- Orchestrator `export_top_n_bundle` 在持锁状态下校验 `owner_id`，越权即返回 `E.FORBIDDEN`：`services/backtest/app/orchestrator.py:624`。对应 Pytest 覆盖 `test_export_top_n_bundle_contains_artifacts` 触发合法路径：`services/backtest/tests/test_orchestrator.py:220`。
- FastAPI 内部接口与 Next.js 提交/状态路由已有认证缺失与越权用例：`services/backtest/tests/test_main_internal_optimizations.py:33`、`apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts:54`、`apps/web/src/app/api/v1/optimizations/__tests__/status.route.int.test.ts:108`，保证共享的 `resolveOwnerId` 守卫可拒绝未授权请求。

### Performance — PASS
- `timeHttp` 包裹导出与复运行端点，为导出耗时与 rerun 延迟提供指标：`apps/web/src/app/api/v1/optimizations/[id]/export/route.ts:6`、`apps/web/src/app/api/v1/optimizations/[id]/rerun/route.ts:6`。
- Rerun 在提交前重新估算参数规模并与 `OPT_PARAM_SPACE_MAX` 比对，防止超限引发队列抖动：`apps/web/src/app/api/v1/optimizations/[id]/rerun/route.ts:18`。集成测试验证超限将返回 `E.PARAM_INVALID`：`apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts:64`。
- Orchestrator 导出复用已有 `summary` 与结果缓存，不重新触发回测，Pytest 断言返回包立即生成：`services/backtest/app/orchestrator.py:630`、`services/backtest/tests/test_orchestrator.py:233`。
- 详情页组件与 Playwright 用例验证轮询刷新与 UI 渲染在早停/取消后停止继续触发昂贵请求：`apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx:59`、`apps/web/e2e/optimizations-detail.spec.ts:92`。

### Reliability — PASS
- 组件测试覆盖进度条、排序提示、导出/复运行交互与通知，确保界面状态与服务响应一致：`apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx:40`-`120`。
- API 集成测试验证导出返回 artifacts、复运行继承原参数并写入 `sourceJobId`：`apps/web/src/app/api/v1/optimizations/__tests__/export.route.int.test.ts:40`、`apps/web/src/app/api/v1/optimizations/__tests__/rerun.route.int.test.ts:40`。
- Playwright 场景覆盖导出/复运行成功与错误降级、早停/取消提示，确认端到端流程稳定：`apps/web/e2e/optimizations-detail.spec.ts:133`、`apps/web/e2e/optimizations-detail.spec.ts:191`。
- 后端总结刷新在导出前重建 `summary` 并补齐结果引用，防止 stale 数据：`services/backtest/app/orchestrator.py:627`。

### Maintainability — PASS
- 测试金字塔完整：Pytest(`services/backtest/tests/test_orchestrator.py`、`test_main_internal_optimizations.py`)、Vitest(`apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx`) 与 Playwright(`apps/web/e2e/optimizations-detail.spec.ts`) 共同覆盖。
- 共享类型与服务层复用同一 orchestrator 客户端，减少重复实现：`apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:320`、`packages/shared/src/optimization.ts:1`。
- 故事文件记录变更范围与测试命令，便于未来维护：`docs/stories/2.4.progress-aggregation.md:232`。

## Recommendations

1. 为导出/复运行补充显式的 401/403 集成测试，验证 `resolveOwnerId` 在无 Cookie 与异主场景下的拒绝路径。
2. 在导出路径增加 bundle 大小指标或日志字段（例如 `items.length`），便于后续排查导出耗时异常。
3. 后续可引入 Top-N 空态与大批量导出的性能回归测试，确保在真实大规模数据下仍满足 SLA。

## Risks

- 导出/复运行仍依赖下游 orchestrator 内存存储；若后端改用远端服务需重新验证指标与权限路径。
- Top-N 空态仅在 E2E 间接覆盖，缺少直接回归测试可能在重构时遗漏 UI 提示。

## Next Steps

- 结合建议 1 的负路径测试与 nightly Playwright 场景，持续监控导出/复运行降级表现。
- 若导出量增大，考虑在 orchestrator 添加异步打包与指标以便容量规划。
