# Requirements Traceability Matrix

## Story: 2.2 - Queue Orchestration

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 3 (60%)
- Partially Covered: 1 (20%)
- Not Covered: 1 (20%)

### Requirement Mappings

#### AC1: 父作业拆分与子任务入队
**Coverage: FULL**
- test_file: `services/backtest/tests/test_orchestrator.py::test_create_job_initializes_summary_and_tasks`
  - Given: 标准参数空间与 owner 信息
  - When: 调用 `create_optimization_job` 拆分任务
  - Then: 生成 6 个 `optimization_tasks`、初始化 summary 并记录 throttled 指标
  - coverage: unit
- test_file: `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`("accepts a valid optimization submission")
  - Given: 版本归属已存在且提供合法参数空间
  - When: 前端 API 提交 `POST /api/v1/optimizations`
  - Then: 请求返回 202、作业入列，`debugListJobs` 中保存 owner/concurrency/参数拆分
  - coverage: integration

#### AC2: 并发闸门与排队限制
**Coverage: FULL**
- test_file: `services/backtest/tests/test_orchestrator.py::test_dequeue_and_concurrency_gate`
  - Given: 并发上限为 2 的父作业
  - When: 连续调用 `dequeue_next`
  - Then: 仅前两个任务进入 running，第三个返回 `None`，保持闸门
  - coverage: unit
- test_file: `services/backtest/tests/test_orchestrator.py::test_thread_safe_dequeue_and_update`
  - Given: 两个线程并发取任务
  - When: 同时调用 `dequeue_next`
  - Then: 返回任务 ID 不重复，summary 统计保持一致
  - coverage: unit
- test_file: `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`("accepts a valid optimization submission")
  - Given: 估算超出并发限流阈值
  - When: 触发排队逻辑
  - Then: 响应头包含 `x-queue-throttled=1`，作业 summary 中 throttled>=1
  - coverage: integration

#### AC3: 重试与指数退避
**Coverage: FULL**
- test_file: `services/backtest/tests/test_orchestrator.py::test_mark_task_failed_applies_retry_backoff`
  - Given: 单线程任务首次失败
  - When: 标记为 `UPSTREAM_ERROR`
  - Then: `nextRunAt` 按指数退避推迟且 retries 递增
  - coverage: unit
- test_file: `services/backtest/tests/test_worker.py::test_worker_retry_then_success`
  - Given: Runner 第一次抛出 upstream 错误
  - When: `process_next` 再次执行
  - Then: 任务成功、得分写入，并记录多次队列等待指标
  - coverage: integration
- test_file: `services/backtest/tests/test_worker.py::test_worker_process_param_error`
  - Given: Runner 抛出参数错误
  - When: 标记失败
  - Then: 任务终止为 failed 且错误码为 `PARAM_ERROR`
  - coverage: integration

#### AC4: 进度聚合与 Top-N
**Coverage: PARTIAL**
- test_file: `services/backtest/tests/test_orchestrator.py::test_top_n_updates_on_completion`
  - Given: 三个子任务完成不同得分
  - When: 顺序调用 `mark_task_succeeded`
  - Then: summary.topN 维持按分数排序的前三项
  - coverage: unit
- test_file: `services/backtest/tests/test_orchestrator.py::test_param_error_marks_failed_and_counts_finished`
  - Given: 参数错误导致任务失败
  - When: 标记失败
  - Then: summary.finished 递增且父作业状态置为 failed
  - coverage: unit
- test_file: `apps/web/src/app/api/v1/optimizations/__tests__/status.route.int.test.ts`("returns aggregated status with summary counts")
  - Given: 6 个子任务、并发限制为 2
  - When: 调用 `GET /api/v1/optimizations/:id/status`
  - Then: 响应包含 total/running/throttled/diagnostics.topN 与 owner 过滤
  - coverage: integration
- gap: 缺少 Playwright 场景覆盖 `/optimizations/{id}` 实时进度与 Top-N 展示，UI 层验证未落地

#### AC5: 测试与质量门
**Coverage: NONE**
- gap: CI 流水线未执行 `python3 -m pytest services/backtest/tests` 或 Orchestrator 集成套件；缺少指标钩子验证、未能阻断失败

### Critical Gaps

1. **AC4 - UI 进度/Top-N**
   - Gap: 缺失状态页端到端验证，无法确保前端展示与 API 聚合同步
   - Risk: 高 - 用户可能看到过期或缺失的进度信息
   - Action: 新增 Playwright 用例模拟节流/完成场景并断言 Top-N

2. **AC5 - 测试钩子**
   - Gap: 未在 CI 中串联 orchestrator Pytest 与 API 集成测试，缺少失败阻断
   - Risk: 高 - 退避或并发回归可能在生产暴露
   - Action: 新增 GitHub Actions Job 执行 `python3 -m pytest services/backtest/tests` 与 vitest 集成脚本，并上传指标

### Test Design Recommendations

1. 为 AC4 引入 `/optimizations/{id}` Playwright 测试，覆盖 Top-N 列表与节流提示刷新逻辑。
2. 在 CI 中新增 Backtest/Orchestrator 测试步骤，收集 queue/退避指标并与质量门集成。
3. 为 summary 合并与 Top-N 排序补充边界单测（空集合、重复得分）。

### Risk Assessment

- **High Risk**: AC4 UI 缺失、AC5 CI 钩子缺失
- **Medium Risk**: 无
- **Low Risk**: AC1-AC3 由单测+集成测试双重覆盖

Trace matrix: docs/qa/assessments/2.2-trace-20250923.md
