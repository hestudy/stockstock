# Risk Profile: Story 1.1

Date: 2025-09-11 (UTC+8)
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 1
- Medium Risks: 3
- Low Risks: 2
- Risk Score: 76/100

## Risk Matrix

| Risk ID  | Description                                              | Probability | Impact     | Score | Priority |
| -------- | -------------------------------------------------------- | ----------- | ---------- | ----- | -------- |
| SEC-001  | 未登录状态对受保护路由缺乏可靠阻断（绕过/直连）              | Medium (2)  | High (3)   | 6     | High     |
| TECH-001 | Supabase Auth 集成及会话管理不稳定（Token/刷新/边界）       | Medium (2)  | Medium (2) | 4     | Medium   |
| OPS-001  | 健康/金丝雀监控与可观测性不足（缺指标或告警，排障困难）      | Medium (2)  | Medium (2) | 4     | Medium   |
| DATA-001 | 健康端点泄露敏感实现细节（如内部错误堆栈或凭证线索）         | Low (1)     | High (3)   | 3     | Low      |
| PERF-001 | 健康端点/健康卡查询导致首屏延迟或阻塞                       | Low (1)     | Medium (2) | 2     | Low      |
| BUS-001  | 错误文案不清晰导致用户误解（支持成本上升/转化受影响）        | Medium (2)  | Medium (2) | 4     | Medium   |

## Critical Risks Requiring Immediate Attention

- 无（当前未识别到评分为 9 的风险）。

## Risk Distribution

### By Category

- Security: 1 项（0 Critical）
- Performance: 1 项（0 Critical）
- Data: 1 项（0 Critical）
- Business: 1 项（0 Critical）
- Operational: 1 项（0 Critical）
- Technical: 1 项（0 Critical）

### By Component

- Frontend: 3 项（路由保护、错误文案、健康卡加载策略）
- Backend/API: 3 项（健康端点安全/性能、可观测性、Auth 解析）
- Database/Infra: 1 项（可观测性/部署配套）

## Detailed Risk Register

### SEC-001 — 未登录状态对受保护路由缺乏可靠阻断（绕过/直连）
- Score: 6 (High) = P: Medium (2) × I: High (3)
- Context: `apps/web/src/app/(dashboard)/layout.tsx` 需要强制会话校验与 `redirect("/login")`；需防直链与客户端侧绕过。
- Mitigation:
  - 统一服务层鉴权拦截，禁止组件直连后端（参见 `docs/architecture/12-coding-standards.md#Service Layer Only`）。
  - 受保护段服务端组件加入会话校验（middleware/route-handlers 亦校验）。
  - E2E：未登录访问 `(dashboard)` → 重定向 `/login` 并展示提示。
- Testing Requirements:
  - 前端单测覆盖路由保护逻辑。
  - E2E 验证关键路径（登录→受保护页→跳转/内容）。

### TECH-001 — Supabase Auth 集成及会话管理不稳定（Token/刷新/边界）
- Score: 4 (Medium) = P: Medium (2) × I: Medium (2)
- Context: 初期接入存在配置/刷新/多端会话一致性风险。
- Mitigation:
  - 明确会话来源（SSR/CSR）与刷新路径；超时策略与边界处理。
  - 后端解析 JWT 推导 `ownerId`，异常路径统一 `ApiError`。
- Testing Requirements:
  - 单元：Auth 辅助方法与刷新逻辑。
  - 集成：受保护 API 在合法/非法 Token 条件下的行为。

### OPS-001 — 健康/金丝雀监控与可观测性不足（缺指标或告警，排障困难）
- Score: 4 (Medium) = P: Medium (2) × I: Medium (2)
- Context: 初期仅占位，如未配置 Metrics/Logs/Alerts，问题发现滞后。
- Mitigation:
  - 最小指标：API/Worker/Queue/Datasource 可用性与错误率；结构化日志（Pino/structlog）。
  - 基础告警：健康端点异常率、延迟阈值、依赖不可用。
- Testing Requirements:
  - 合成监控或集成测试校验 `/api/v1/health` 结构与边界。

### DATA-001 — 健康端点泄露敏感实现细节（内部错误堆栈或凭证线索）
- Score: 3 (Low) = P: Low (1) × I: High (3)
- Mitigation:
  - 避免返回敏感字段；统一错误掩码；仅暴露必要摘要。
  - 基于角色的可见性（如仅管理员可见更多细节）。
- Testing Requirements:
  - 单元：序列化与掩码；
  - 安全：ZAP/手工探测异常路径是否泄露细节。

### PERF-001 — 健康端点/健康卡查询导致首屏延迟或阻塞
- Score: 2 (Low) = P: Low (1) × I: Medium (2)
- Mitigation:
  - “摘要先行 → 细节懒加载”；前端设置超时与降级文案。
  - 缓存与轻量查询，避免重度依赖链。
- Testing Requirements:
  - 性能基线：TTI/首屏摘要可见时间；
  - 失败时 UI 降级体验验证。

### BUS-001 — 错误文案不清晰导致用户误解（支持成本上升/转化受影响）
- Score: 4 (Medium) = P: Medium (2) × I: Medium (2)
- Mitigation:
  - 文案规范：非技术术语、指向性强；与 `ApiError` 对齐。
  - 常见错误场景（未登录/无权限/降级）提供示例与一致呈现。
- Testing Requirements:
  - UI 回归测试覆盖典型错误与本地化校验。

## Risk-Based Testing Strategy

### Priority 1: High/Critical
- SEC-001：路由保护/E2E；API 鉴权边界；负路径（未登录/会话过期）。

### Priority 2: Medium
- TECH-001：会话刷新/多端一致性；
- OPS-001：监控配置与日志可用性；
- BUS-001：错误文案策略与 A/B 可用性验证。

### Priority 3: Low
- DATA-001：异常路径信息泄露校验；
- PERF-001：健康卡懒加载与超时降级。

## Risk Acceptance Criteria

- Must Fix Before Production:
  - 任意 Critical（9）
  - High 风险涉及安全/数据（本案 SEC-001 需在上线前关闭）
- Can Deploy with Mitigation:
  - Medium 风险具备补偿性控制与监控
- Accepted Risks:
  - 需记录责任人/期限与复审触发条件

## Monitoring Requirements

- 安全：受保护路由/端点鉴权失败率、异常跳转率
- 性能：`/api/v1/health` 延迟与错误率、健康卡加载时间
- 运行：服务可用性、依赖检查、日志异常
- 业务：登录转化、错误提示后的留存/回退

---

# Gate Paste: risk_summary

```yaml
risk_summary:
  totals:
    critical: 0
    high: 1
    medium: 3
    low: 2
  highest:
    id: SEC-001
    score: 6
    title: '未登录访问受保护路由可被绕过的风险'
  recommendations:
    must_fix:
      - '完善受保护段会话校验与重定向，端到端 E2E 覆盖（SEC-001）'
    monitor:
      - '配置健康端点与关键依赖的指标/告警（OPS-001）'
      - '统一错误文案/ApiError 策略并做回归测试（BUS-001）'
```

> Hook: Risk profile: qa.qaLocation/assessments/1.1-risk-20250911.md
