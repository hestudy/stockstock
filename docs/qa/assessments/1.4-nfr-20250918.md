# NFR Assessment: 1.4

Date: 2025-09-18
Reviewer: Quinn

Source story: docs/stories/1.4.status-basic-result.md

## Summary

- Security: CONCERNS - 缺少显式的速率限制与输入校验说明；鉴权/鉴权已通过 Supabase JWT 与 `ownerId` 过滤规划
- Performance: PASS - 首屏摘要 2 秒目标有 E2E 覆盖与前端分步加载策略（摘要先行→曲线懒加载）
- Reliability: PASS - 统一错误映射、轮询与就绪判定、空态处理与重试/返回入口均有设计
- Maintainability: CONCERNS - 覆盖率与断言存在缺口（AC4 导出、AC5 错误/空态、AC6 A11y 的单测/集成/E2E 需补齐）

Quality score: 80/100 (2×CONCERNS)

## Evidence

- 鉴权/鉴权与 API 契约：`apps/web/src/app/api/_lib/auth.ts`、`apps/web/src/app/api/v1/backtests/[id]/status/route.ts`、`apps/web/src/app/api/v1/backtests/[id]/result/route.ts`
- 前端首屏与懒加载：`apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`、`apps/web/src/components/summary/SummaryCards.tsx`、`apps/web/src/components/charts/EquityCurve.tsx`
- 错误映射与导出：`apps/web/src/utils/errorMapping.ts`、`apps/web/src/utils/export.ts`
- 共享类型：`packages/shared/src/backtest.ts`
- 故事与验收标准：`docs/stories/1.4.status-basic-result.md`

## Critical Issues

1. Security - 速率限制缺失
   - 风险：接口被滥用导致资源消耗/撞库风险
   - 建议：对 `GET /api/v1/backtests/{id}/status|result` 增加速率限制（如基于路径和用户的滑动窗口），并记录超限日志

2. Security - 输入/参数校验说明不明确
   - 风险：异常参数导致不必要负载或错误路径
   - 建议：对 `id` 参数做严格校验（格式/长度/归属校验已通过 `ownerId` 过滤，但仍建议参数层校验），失败返回统一 `ApiError`

3. Maintainability - 测试缺口
   - 风险：导出失败分支、错误/空态、A11y 容易回归
   - 建议：补齐 AC4/AC5/AC6 的单测/集成/E2E 断言；对导出函数增加异常分支测试

## Quick Wins

- 为状态/结果接口加上简单速率限制中间件（~1-2h）
- 在 API 路由增加参数校验与错误码映射（~1h）
- 增补导出失败/错误空态/A11y 的测试用例（~3-4h）

## Gate YAML (copy/paste)

```yaml
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: "缺少速率限制与明确的输入参数校验；JWT 鉴权与 ownerId 过滤已规划"
  performance:
    status: PASS
    notes: "2 秒首屏摘要目标有 E2E 覆盖；采用摘要先行+图表懒加载策略"
  reliability:
    status: PASS
    notes: "统一错误映射、轮询就绪、空态与重试路径具备"
  maintainability:
    status: CONCERNS
    notes: "AC4/AC5/AC6 测试断言未完全落地，需补齐单测/集成/E2E"
```

NFR assessment: docs/qa/assessments/1.4-nfr-20250918.md

Gate NFR block ready → paste into qa.qaLocation/gates/1.4-status-basic-result.yml under nfr_validation
