# Risk Profile: Story 1.2

Date: 2025-09-12
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 11
- Critical Risks: 0
- High Risks: 4
- Medium Risks: 4
- Low Risks: 3
- Risk Score: 100 - (0*20 + 4*10 + 4*5 + 3*2) = 100 - (0 + 40 + 20 + 6) = 34 deducted -> 66/100

## Critical Risks Requiring Immediate Attention

- None identified as Critical (score 9). Highest risks are High (score 6). See priorities below.

## Risk Distribution

### By Category

- Security (SEC): 3 risks (0 critical, 2 high, 1 medium)
- Performance (PERF): 2 risks (0 critical, 1 high, 1 medium)
- Data (DATA): 2 risks (0 critical, 0 high, 1 medium, 1 low)
- Business (BUS): 2 risks (0 critical, 0 high, 1 medium, 1 low)
- Operational (OPS): 1 risk (0 critical, 1 high)
- Technical (TECH): 1 risk (0 critical, 0 high, 0 medium, 1 low)

### By Component

- Frontend (Editor/UI/Forms): 6 risks
- Services Layer (strategies.ts): 3 risks
- Shared Types (packages/shared): 1 risk
- Routing/Auth/Infra: 1 risk

## Detailed Risk Register

| Risk ID  | Title | Category | Description | Probability | Impact | Score | Priority |
|---------|-------|----------|-------------|-------------|--------|-------|----------|
| SEC-001 | Requirements 输入导致供应链风险 | Security | 未限制/校验的 `requirements` 允许注入高风险包或版本（Typosquatting/恶意包） | Medium (2) | High (3) | 6 | High |
| OPS-001 | 受保护路由遗漏导致未授权访问 | Operational | `(dashboard)` 保护缺失/配置偏差导致未登录用户可访问编辑器 | Medium (2) | High (3) | 6 | High |
| PERF-001 | Monaco 编辑器资源开销导致交互卡顿 | Performance | 大体积编辑器组件、语法高亮在低端设备造成掉帧/白屏 | Medium (2) | High (3) | 6 | High |
| SEC-002 | XSS/注入（字段渲染/错误文案） | Security | 表单字段（名称/描述/标签）或错误文案未做转义/白名单导致 XSS | Medium (2) | High (3) | 6 | High |
| SEC-003 | 本地草稿泄露 | Security | `localStorage` 持久化草稿含敏感元数据，在共享/公用设备存在泄露风险 | Medium (2) | Medium (2) | 4 | Medium |
| PERF-002 | 不当懒加载策略与长任务 | Performance | 未懒加载或错误切分导致主线程长任务，影响首交互 | Medium (2) | Medium (2) | 4 | Medium |
| DATA-001 | 草稿一致性与损坏 | Data | 本地草稿结构演进与兼容性不足导致读取失败/覆盖 | Medium (2) | Medium (2) | 4 | Medium |
| DATA-002 | 依赖与参数合法性校验不足 | Data | `params` 与 `requirements` 结构/格式校验不足，提交时产生坏数据 | Low (1) | Medium (2) | 2 | Low |
| BUS-001 | 与 1.3 提交流程契约偏差 | Business | `BacktestSubmitRequest` 字段对齐不足，后续集成返工 | Medium (2) | Medium (2) | 4 | Medium |
| BUS-002 | 用户上手成本过高 | Business | 模板与说明不足导致用户不了解如何编辑/提交 | Low (1) | Medium (2) | 2 | Low |
| TECH-001 | 共享类型未落地导致重复定义 | Technical | `packages/shared` 类型未创建或未被前端消费，出现漂移 | Low (1) | Medium (2) | 2 | Low |

## Risk-Based Mitigation and Testing Requirements

### SEC-001 Requirements 输入导致供应链风险 (Score 6)
- Strategy: preventive
- Actions:
  - 依赖编辑器限制包名字符集与长度，禁止范围通配（如 `*`）。
  - 内置允许列表或风险提示（常见包如 `pandas`, `vectorbt`）。
  - 在提交侧做二次校验与规范化（版本前缀 `^`, `~`, `>=` 白名单）。
  - 记录与显示依赖差异（变更审计）。
- Testing:
  - 单元：包名/版本校验函数。
  - 集成：非法输入拦截与错误提示、提交阻断。
  - 安全：常见 Typosquat 用例与恶意字符注入。
- Residual: Medium
- Owner: FE/BE
- Timeline: Before integration with 1.3

### OPS-001 受保护路由遗漏导致未授权访问 (Score 6)
- Strategy: preventive/detective
- Actions:
  - 确保页面位于 `(dashboard)` 并复用会话保护中间件；未登录重定向 `/login`。
  - E2E 场景：未登录访问直接跳转；已登录可见编辑器。
  - 在 CI 添加路由保护快照与 E2E 检查。
- Testing:
  - E2E：`/backtests` 受保护断言。
  - 集成：会话 Hook/Provider 行为。
- Residual: Low
- Owner: FE
- Timeline: Before first deployment

### PERF-001 Monaco 编辑器资源开销 (Score 6)
- Strategy: preventive
- Actions:
  - 动态导入与懒加载；Idle/Visibility-based 载入。
  - 降级方案至 CodeMirror（特性差异留痕）。
  - 代码高亮/校验限流与防抖；分片任务。
- Testing:
  - 性能预算：LCP/INP 指标对比；低端设备仿真。
  - 单元：懒加载逻辑与占位渲染。
- Residual: Medium
- Owner: FE
- Timeline: Sprint

### SEC-002 XSS/注入（字段/错误文案）(Score 6)
- Strategy: preventive
- Actions:
  - 对用户可见渲染统一 `escapeHTML`；白名单标签（如完全禁止富文本）。
  - 错误消息来自受控字典，不拼接用户输入；日志与 UI 隔离。
- Testing:
  - 单元：转义函数与渲染分支。
  - 安全：OWASP ZAP 基线扫描。
- Residual: Low
- Owner: FE
- Timeline: Sprint

### DATA-001 草稿一致性与损坏 (Score 4)
- Strategy: preventive/corrective
- Actions:
  - 版本化 `strategy-editor:draft` 结构与迁移函数。
  - 写入前 Schema 校验（Zod/自定义）。
  - 写失败与恢复策略（回退默认模板）。
- Testing:
  - 单元：迁移/校验。
  - 集成：读写与降级路径。
- Residual: Low

### BUS-001 与 1.3 契约偏差 (Score 4)
- Strategy: preventive
- Actions:
  - 定义共享类型 `BacktestSubmitRequest` 与 1.3 对齐；
  - 在服务层集中构造 payload；添加契约测试。
- Testing:
  - 集成：payload 生成与断言。
- Residual: Low

### 其它中低风险（概要）
- PERF-002：优化懒加载策略与切片；监控主线程长任务。
- DATA-002：对 `params`/`requirements` 做 JSON Schema/Zod 校验。
- BUS-002：完善模板注释与“从模板加载/重置”UX，引导首次上手。
- TECH-001：创建 `packages/shared/src/strategy.ts` 并在前端消费。

## Risk-Based Testing Strategy

### Priority 1: High Risk Tests
- 受保护路由 E2E（未登录重定向、已登录渲染）。
- 依赖输入校验（单元/集成），恶意用例与提交流程阻断。
- 编辑器懒加载与性能预算（性能回归测试/对比）。
- XSS 渲染与错误文案基线扫描。

### Priority 2: Medium Risk Tests
- 本地草稿版本迁移与回退路径。
- 1.3 提交流程契约测试（payload 构造）。

### Priority 3: Low Risk Tests
- `params`/`requirements` JSON 校验。
- UX 引导与模板操作可用性测试。
- 共享类型存在性与消费检查。

## Risk Acceptance Criteria

- Must Fix Before Production:
  - 所有 High 风险（Score 6）
- Can Deploy with Mitigation:
  - Medium 风险具备补偿控制
- Accepted Risks:
  - Low 风险可随路线图跟进，需记录责任人与时间

## Monitoring Requirements

- 性能指标（LCP/INP/FID）、长任务与内存占用监控。
- 安全告警：输入异常频率、包名黑名单触发。
- 错误率：表单提交失败与草稿读写失败比例。
- 业务 KPI：模板使用率、提交尝试到成功率。

## Risk Review Triggers

- 路由/认证策略变更
- 编辑器实现或懒加载策略调整
- 与 Story 1.3/1.4 的契约或接口变化
- 引入新的第三方依赖或升级重大版本
