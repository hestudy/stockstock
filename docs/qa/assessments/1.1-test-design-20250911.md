# Test Design: Story 1.1

Date: 2025-09-11
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 15
- Unit tests: 5 (33%)
- Integration tests: 5 (33%)
- E2E tests: 5 (33%)
- Priority distribution: P0: 6, P1: 8, P2: 1, P3: 0

Rationale:
- Shift-left emphasized: unit and integration first for fast, stable feedback; E2E limited到关键路径。
- 防重复覆盖：同一需求不同层强调不同关注点（逻辑/交互/体验）。

## Test Scenarios by Acceptance Criteria

### AC1: 鉴权可用（登录/注册，会话管理；未登录访问受保护路由将重定向登录并提示）

#### Scenarios

| ID            | Level       | Priority | Test                                               | Justification                                  |
| ------------- | ----------- | -------- | -------------------------------------------------- | ---------------------------------------------- |
| 1.1-UNIT-001  | Unit        | P0       | 会话检查/重定向判定纯函数（已登录/未登录分支）     | 纯逻辑与分支覆盖，快速反馈                      |
| 1.1-INT-001   | Integration | P0       | Auth 中间件解析 JWT 并推导 ownerId                 | 组件边界：中间件与会话/请求对象交互             |
| 1.1-E2E-001   | E2E         | P1       | 未登录访问受保护页→被重定向至登录并展示提示       | 关键用户体验路径（未认证态）                    |

### AC2: 健康页/端点可见（API、Worker、Queue、Datasource 状态快照）

#### Scenarios

| ID            | Level       | Priority | Test                                               | Justification                                  |
| ------------- | ----------- | -------- | -------------------------------------------------- | ---------------------------------------------- |
| 1.1-UNIT-002  | Unit        | P1       | 健康数据序列化/映射函数：status 与 details 组装    | 纯数据转换与映射                               |
| 1.1-INT-002   | Integration | P0       | GET /api/v1/health 返回 200 且结构包含四大类       | API 合同与聚合边界验证                          |
| 1.1-E2E-002   | E2E         | P1       | 健康页展示 API/Worker/Queue/Datasource 摘要        | 用户可见结果正确性                              |

### AC3: 状态可视（up/degraded/down）且带最近时间戳

#### Scenarios

| ID            | Level       | Priority | Test                                               | Justification                                  |
| ------------- | ----------- | -------- | -------------------------------------------------- | ---------------------------------------------- |
| 1.1-UNIT-003  | Unit        | P2       | 时间戳格式化与"最近"阈值判断                       | 纯函数，边界值校验                              |
| 1.1-INT-003   | Integration | P1       | 数据源状态聚合服务：缺项/降级时的回退策略          | 组件交互与回退策略                              |
| 1.1-E2E-003   | E2E         | P1       | UI 展示 up/degraded/down 与最近时间戳               | 端到端呈现的正确性                              |

### AC4: 错误提示清晰，避免技术术语

#### Scenarios

| ID            | Level       | Priority | Test                                               | Justification                                  |
| ------------- | ----------- | -------- | -------------------------------------------------- | ---------------------------------------------- |
| 1.1-UNIT-004  | Unit        | P0       | 错误码→用户友好文案映射表（未登录/无权限/降级）    | 逻辑映射易回归，需稳定覆盖                      |
| 1.1-INT-004   | Integration | P0       | 未授权/权限不足响应统一使用 ApiError 结构          | API 合同一致性与错误规范                        |
| 1.1-E2E-004   | E2E         | P1       | 失败场景展示非技术术语提示                         | 用户体验与可理解性                              |

### AC5: 路由保护（App Router (dashboard) 会话保护；E2E 验证登录→受保护页→正确内容）

#### Scenarios

| ID            | Level       | Priority | Test                                               | Justification                                  |
| ------------- | ----------- | -------- | -------------------------------------------------- | ---------------------------------------------- |
| 1.1-UNIT-005  | Unit        | P0       | (dashboard)/layout 守卫逻辑：已登录通过/未登录阻止 | 纯逻辑与条件路由                               |
| 1.1-INT-005   | Integration | P1       | 守卫与会话提供器/路由器交互（mock session provider)| 组件边界交互                                   |
| 1.1-E2E-005   | E2E         | P1       | 登录后访问受保护页得到期望内容                     | 关键路径（已认证态）                            |

## Risk Coverage

- 安全/鉴权相关（P0）：1.1-UNIT-001, 1.1-INT-001, 1.1-INT-004, 1.1-UNIT-004, 1.1-UNIT-005
- 对外合同/API 稳定性（P0）：1.1-INT-002, 1.1-INT-004
- 关键用户路径（P1）：1.1-E2E-001, 1.1-E2E-002, 1.1-E2E-003, 1.1-E2E-004, 1.1-E2E-005

## Recommended Execution Order

1. P0 Unit tests（fail fast）
2. P0 Integration tests
3. P0 E2E tests
4. P1 tests in order
5. P2+ as time permits

## Gate YAML Block (for qa-gate)

test_design:
  scenarios_total: 15
  by_level:
    unit: 5
    integration: 5
    e2e: 5
  by_priority:
    p0: 6
    p1: 8
    p2: 1
    p3: 0
  coverage_gaps: []

## Trace References

Test design matrix: docs/qa/assessments/1.1-test-design-20250911.md
P0 tests identified: 6
