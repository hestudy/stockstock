# Risk Profile: Story 2.4

Date: 2025-09-25 (UTC+8)
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 0
- High Risks: 3
- Medium Risks: 2
- Low Risks: 1
- Risk Score: 58/100

## Critical Risks Requiring Immediate Attention

- 无（当前未评定 Critical=9 风险）。但存在 3 个 High=6 风险，需在开发早期即落实防护与测试计划。

## Risk Distribution

### By Category

- Technical (TECH): 1 risk (0 critical)
- Data (DATA): 1 risk (0 critical)
- Performance (PERF): 1 risk (0 critical)
- Operational (OPS): 1 risk (0 critical)
- Business (BUS): 1 risk (0 critical)
- Security (SEC): 1 risk (0 critical)

### By Component

- Progress 轮询服务层 & UI：2 risks
- 导出与复运行后端（Python/API）：3 risks
- 共享类型与 ResultSummary 数据模型：1 risk

## Detailed Risk Register

| ID        | Category    | Title                                                                 | Probability | Impact      | Score | Priority |
|-----------|-------------|-----------------------------------------------------------------------|-------------|-------------|-------|----------|
| TECH-001  | Technical   | 早停/取消后 summary 未冻结导致进度面板持续刷新异常                    | Medium (2)  | High (3)    | 6     | High     |
| DATA-001  | Data        | Top-N 排序方向或汇总内容错误导致导出包缺少最佳参数                    | Medium (2)  | High (3)    | 6     | High     |
| OPS-001   | Operational | 导出流程误触发完整回测或重复生成 artifact 造成资源浪费                | Medium (2)  | High (3)    | 6     | High     |
| PERF-001  | Performance | 轮询频率与 SWR/Query 配置不当，引发 API 压力与前端渲染抖动            | Medium (2)  | Medium (2)  | 4     | Medium   |
| BUS-001   | Business    | 复运行入口引导不足，导致用户误复运行旧参数或忽视早停背景              | Medium (2)  | Medium (2)  | 4     | Medium   |
| SEC-001   | Security    | 复运行 API 缺乏租户校验或字段过滤，可能越权复制他人参数空间          | Low (1)     | High (3)    | 3     | Low      |

> 评分依据：Probability × Impact；表格按分数与优先级排序。

## Mitigations & Testing Requirements

### TECH-001 早停/取消后 summary 未冻结（Score 6）
- Strategy: preventive + detective
- Actions:
  - 在服务层封装 `useOptimizationStatus` 时加上终态 (`early-stopped`/`canceled`/`succeeded`) 判断，落盘 `summary` 后停止刷新并展示停机提示。
  - API 层提供 `summary.version` 或 `updatedAt`，前端根据版本锁定最终值，避免 SWR 重置。
  - 记录停机事件到监控，核对 `summary.finished` 与数据库指标。
- Testing Requirements:
  - Playwright 用例覆盖早停后轮询停止与提示文案。
  - API 集成测试验证终态返回保持稳定且不会回退。
  - 前端单测断言 hook 在终态下不再触发 `refetch`。
- Residual Risk: Low
- Owner: Frontend + API
- Timeline: Before merge

### DATA-001 Top-N 排序/导出错误（Score 6）
- Strategy: preventive
- Actions:
  - 在共享类型中显式声明 `earlyStopPolicy.mode` 与排序方向，服务层统一将 `score` 映射为 Asc/Desc。
  - 导出逻辑与 UI 共用一处排序函数，并在生成包时包含 `taskId`、`score`、`metrics`、`artifacts` 完整结构。
  - 引入快照测试确保 Top-N 与导出内容一致。
- Testing Requirements:
  - Python 单测：模拟多种排序模式与并列分数。
  - API 集成测试：验证导出包字段齐全且未丢失最佳组合。
  - 前端 Vitest：Top-N 渲染与排序提示覆盖空态、早停态。
- Residual Risk: Low
- Owner: Backend (Python/API) + Frontend
- Timeline: Before release

### OPS-001 导出误触发回测（Score 6）
- Strategy: preventive + detective
- Actions:
  - 导出端点仅从 `ResultSummary.artifacts` 取数据，禁止调用回测队列；为安全起见在代码中加显式断言/feature flag。
  - 增加速率限制与幂等校验（缓存最新导出结果，短时重复请求直接返回）。
  - 记录导出操作监控指标：成功/失败计数、耗时与触发人。
- Testing Requirements:
  - Python/后端单测：确保导出不调用回测任务（可注入 mock 阻止）。
  - API 集成测试：并发导出、失败重试场景验证幂等。
  - Observability：配置导出耗时与异常告警。
- Residual Risk: Medium
- Owner: Backend (Python/API)
- Timeline: Before release

### PERF-001 轮询导致性能压力（Score 4）
- Strategy: preventive
- Actions:
  - 依据 `summary.total` 大小设置自适应轮询间隔（运行中与终态分离），并使用 SWR 去抖/聚合请求。
  - 后端开启响应缓存或利用 ETag，减轻高频拉取。
  - UI 层避免非必要重渲染（memo Top-N 列表、虚拟滚动）。
- Testing Requirements:
  - 前端性能基准：模拟 100+ Top-N 项目，测量 fps 与渲染时间。
  - 负载测试：并发 50 个客户端轮询，观察 API QPS 与响应时间。
  - 浏览器性能分析确保轮询间隔调整生效。
- Residual Risk: Low
- Owner: Frontend + API
- Timeline: Before GA

### BUS-001 复运行体验偏差（Score 4）
- Strategy: preventive + detective
- Actions:
  - 复运行对话框显示原作业 status、执行时间与早停原因，提醒用户确认参数是否仍适用。
  - 历史列表标记新作业与来源作业，支持快速对比指标。
  - 产品团队定义导出包内的 README/metadata，说明结果适用场景。
- Testing Requirements:
  - UX 走查：确认提示文案符合 PRD 要求。
  - E2E 测试：复运行 → 历史写入 → 跳转流程完整。
  - 分析事件：埋点复运行成功/取消率。
- Residual Risk: Medium
- Owner: Product + Frontend
- Timeline: Before GA

### SEC-001 复运行越权风险（Score 3）
- Strategy: preventive
- Actions:
  - API 校验 `sourceJobId` 所属与 JWT `ownerId` 一致，拒绝跨租户复运行并记录审计日志。
  - 避免在响应中返回原作业敏感字段（成本、内部指标）。
  - 定期安全扫描覆盖该端点。
- Testing Requirements:
  - API 集成测试：未登录、跨租户、字段缺失等分支。
  - 安全测试：OWASP 工具验证参数注入/越权。
- Residual Risk: Low
- Owner: Backend (API)
- Timeline: Before release

## Risk-Based Testing Strategy

- Priority 1（High/Score 6）
  - 端到端验证早停冻结、导出幂等、Top-N 排序正确性。
  - 后端单测/集成测试覆盖导出与回测隔离、排序逻辑、终态快照。
  - Playwright 场景：早停后查看详情、导出、复运行。
- Priority 2（Medium/Score 4）
  - 性能基准与轮询节流验证。
  - 复运行体验与文案的一致性测试。
- Priority 3（Low/Score ≤3）
  - 安全扫描与越权测试可按回归节奏执行，但需在发布前完结。

## Risk Acceptance Criteria

- Must Fix Before Production: 所有 Score 6 风险需落实代码改进与验证。
- Can Deploy with Mitigation: Score 4 风险在测试完成并配置监控后可随发布上线。
- Accepted Risks: 当前仅 Score 3（SEC-001）保留监控；需在发布前通过安全测试确认无新增漏洞。

## Monitoring Requirements

- 轮询请求 QPS、API 响应时间、Top-N 数据更新延迟。
- 导出操作成功率、耗时、失败原因聚合，并接入告警。
- 复运行触发量、跨租户拒绝计数、审计日志完整性。

## Risk Review Triggers

- Orchestrator 或 ResultSummary 数据结构变更。
- 轮询策略或 SWR 配置调整。
- 新增导出格式/并发写入策略。
- 复运行支持更多作业类型或开放公用历史列表。

---

Risk profile: docs/qa/assessments/2.4-risk-20250925.md
