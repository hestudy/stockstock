# Requirements Traceability Matrix

## Story: 1.5 - Minimal Observability

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 0 (0%)
- Partially Covered: 4 (80%)
- Not Covered: 1 (20%)

### Requirement Mappings

#### AC1: 结构化日志（前端/后端/Workers）

Coverage: PARTIAL

Given-When-Then Mappings:

- Unit Test: `apps/web/src/utils/__tests__/observability.test.ts::should emit summary_rendered event with ms`
  - Given: NEXT_PUBLIC_OBS_ENABLED 为 true，测试环境
  - When: 调用 `observability.trackSummaryRendered(123, { id: "abc" })`
  - Then: 控制台结构化输出包含 `{ evt: "summary_rendered", ms: 123, sid }`

- Unit Test: `apps/web/src/utils/__tests__/observability.test.ts::should emit error event with safe message`
  - Given: 可观测封装已启用
  - When: 调用 `observability.trackError(Error("boom"))`
  - Then: 控制台结构化输出包含 `{ evt: "error", error: { message: "boom", name: "Error" } }`

- Unit Test: `apps/web/src/app/api/_lib/__tests__/handler.test.ts::wraps thrown error into ApiError JSON`
  - Given: API Route handler 使用 `wrap()`
  - When: 内部抛出带 `status=429` 的错误
  - Then: 响应状态 429，返回体符合 `ApiError` 结构且包含 `requestId`

- Gap: Workers 侧结构化日志（`services/backtest/app/observability.py`）无实现/测试文件

#### AC2: 时延与性能指标（status/result 路由；摘要首屏埋点）

Coverage: PARTIAL

- Unit Test: `apps/web/src/app/api/_lib/__tests__/otel.test.ts::records duration and status on success`
  - Given: `OBS_ENABLED=true`
  - When: `timeHttp("/api/v1/demo","GET", fn)` 成功返回 200
  - Then: 记录 `{ kind: "http_server", route: "/api/v1/demo", method: "GET", status: 200, duration_ms }`

- Unit Test: `apps/web/src/app/api/_lib/__tests__/otel.test.ts::records failure status on error`
  - Given: `OBS_ENABLED=true`
  - When: `timeHttp` 执行期间抛出带 `status=503` 的错误
  - Then: 记录 `{ status: 503 }`，并传播异常

- E2E: `apps/web/e2e/backtests-detail.spec.ts::summary visible within 2s`
  - Given: status/result 接口被拦截为成功
  - When: 访问 `/backtests/{id}`
  - Then: 摘要区域在 2 秒内可见

- E2E: `apps/web/e2e/backtests-detail.spec.ts::emits summary_rendered observability event`
  - Given: 浏览器端收集 hook `window.__OBS_EVENTS__`
  - When: 页面成功渲染摘要
  - Then: 事件数组包含 `{ evt: "summary_rendered", id: jobId }`

- Gap: API 路由在集成测试中未直接断言 `timeHttp` 指标输出（仅通过库单测验证）

#### AC3: 统一错误分类与用户提示

Coverage: PARTIAL

- Route Tests: `status` 与 `result` 路由测试（多分支）
  - Files:
    - `apps/web/src/app/api/v1/backtests/[id]/status/__tests__/route.test.ts`
    - `apps/web/src/app/api/v1/backtests/[id]/result/__tests__/route.test.ts`
  - Given: 通过 mocks 控制鉴权、限流、参数校验
  - When: 触发 INVALID_ID / UNAUTHENTICATED / RATE_LIMITED / 内部错误
  - Then: HTTP 状态码分别为 400/401/429/500，返回体为统一 `ApiError` 结构

- E2E: `apps/web/e2e/backtests-detail.spec.ts::failed status shows error message and actions`
  - Given: 状态接口返回 failed、结果接口返回 404
  - When: 打开回测详情页
  - Then: UI 显示用户可读错误提示与重试/返回操作

- Gap: 未覆盖完整错误分类（如上游不可用等）在前端映射的断言清单

#### AC4: 可配置与最小依赖（环境变量切换，不引入 Prometheus 自托管）

Coverage: NONE

- Gap: 缺少针对 `OBS_ENABLED`/`SENTRY_DSN`/`OTEL_EXPORTER_OTLP_ENDPOINT` 等配置切换的集成测试或配置验证测试

#### AC5: 测试闭环（单测/集成/E2E）

Coverage: PARTIAL

- Unit: FE 可观测封装、API `timeHttp`、API `wrap` 已覆盖
- Integration: API 路由 happy/错误路径已覆盖（偏向 handler 层面）
- E2E: 摘要 2 秒、事件上报、错误与空态、导出与交互均有覆盖
- Gap: Workers 侧 Pytests 缺失；API 指标在路由层的集成断言缺失

### Critical Gaps

1) Workers 可观测性实现与测试缺失
- Risk: 中 — 生产问题定位可能缺少关键信息
- Action: 实现 `services/backtest/app/observability.py` 与 `services/backtest/tests/test_observability.py`

2) 配置项可切换的验证缺失（AC4）
- Risk: 中 — 环境配置差异可能导致观测失效
- Action: 增加针对 `OBS_ENABLED`/`OTEL_*` 的启用/禁用与导出通路验证

3) API 路由层指标记录的集成断言缺失（依赖 `timeHttp` 接入）
- Risk: 低-中 — 指标收集回归风险
- Action: 在路由测试中 spy/拦截指标输出或注入可观测导出器 mock 进行断言

### Test Design Recommendations

1. 在 API 路由测试中注入指标导出 mock，断言 route/status 标签与 duration 分布
2. 为前端错误映射补充参数错误/鉴权错误/上游不可用等用户提示断言
3. 完成 Workers 结构化日志实现与对应 Pytest，覆盖入队/开始/结束/异常路径
4. 增加配置切换用例（env matrix）验证启用/禁用路径

### Risk Assessment

- High Risk: AC4（无覆盖）；Workers 可观测性（无实现/测试）
- Medium Risk: API 指标集成断言缺失；错误映射断言不完整
- Low Risk: 已有 FE/路由 happy-path 与 E2E 正向覆盖

### Gate YAML Block (for paste under `trace` of gate file)

```yaml
trace:
  totals:
    requirements: 5
    full: 0
    partial: 4
    none: 1
  planning_ref: "docs/qa/assessments/1.5-test-design-20250919.md"
  uncovered:
    - ac: "AC4"
      reason: "No tests for config toggles and minimal dependency behavior"
    - ac: "AC1/AC5 (Workers)"
      reason: "Workers observability implementation and tests missing"
  notes: "See docs/qa/assessments/1.5-trace-20250919.md"
```

### Hook Line

Trace matrix: docs/qa/assessments/1.5-trace-20250919.md
