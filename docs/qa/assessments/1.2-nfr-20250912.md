# Story 1.2 — NFR Assessment (Non-Functional Requirements)

- Story: `docs/stories/1.2.strategy-template-editor.md`
- Date (UTC+8): 2025-09-12
- Assessor: Quinn (Test Architect)
- Scope: 前端策略模板与编辑器（`(dashboard)/backtests` 页面）、模板加载/重置、依赖与元数据编辑、草稿存取与提交占位对接

---

## 1. 方法与基线
- 依据：
  - `docs/architecture/03-tech-stack.md`、`07-frontend-architecture.md`、`12-coding-standards.md`、`11-testing-strategy.md`
  - Story 1.2 的 AC、任务与“Project Structure Notes/Assumptions & Edge Cases”
  - 现有测试设计与风险文档：
    - `docs/qa/assessments/1.2-test-design-20250912.md`
    - `docs/qa/assessments/1.2-risk-20250912.md`
- 评估策略：以“最小可用+安全默认”为基线，结合金字塔测试策略与受保护路由、CSR 编辑器、依赖清单输入等关键点进行验证与建议。

## 2. 执行环境与前提
- 前端：Next.js App Router、TS、Tailwind、`@monaco-editor/react`（或降级 CodeMirror）。
- 页面：`(dashboard)/backtests`，需登录态（会话校验）。
- 数据：草稿暂存 `localStorage`，后续对接后端；提交流程在 Story 1.3 完成。

---

## 3. NFR 维度评估

### 3.1 安全（Security）
- 要点：
  - 受保护路由：未登录不得进入 `(dashboard)`；从登录返回可恢复草稿。
  - 依赖清单输入：潜在供应链与注入风险，需最小权限与格式校验。
  - 编辑器内容：潜在 XSS/脚本注入风险，渲染时需转义，预览区谨慎处理。
- 发现与建议：
  - SEC-001 供应链依赖：限制 `requirements.packages` 的允许字符（`^[a-zA-Z0-9._-]+$`）与版本模式；禁用安装指令/URL；提交前仅做“声明”，实际安装在隔离后端。
  - SEC-002 XSS：
    - 编辑器仅作为文本输入源；任何渲染预览要进行 HTML 转义或使用安全渲染库；禁用 `dangerouslySetInnerHTML`。
    - 在组件上增加 `data-testid` 以辅助安全相关单测。
  - SEC-003 会话与路由：在 `(dashboard)/layout.tsx` 做会话守卫，未登录重定向；确保编辑器仅在客户端渲染，避免 SSR 注入面。
- 建议测试：
  - 伪造依赖条目（包含空格、shell、URL）被前端校验拒绝；
  - 编辑器输入 HTML/JS 片段，在任何非预期位置不被执行/渲染。

### 3.2 性能（Performance）
- 要点：富编辑器、懒加载、草稿恢复、交互反馈。
- 目标（MVP）：
  - 首次可交互（TTI）在现代设备下 < 2.5s（已登录状态，缓存命中）；
  - 模板加载/重置响应 < 150ms；
  - 键入延迟（输入到渲染）< 50ms。
- 建议：
  - 使用动态导入懒加载编辑器；
  - 限制编辑器默认高亮/插件集；
  - 模板与草稿操作走内存态并异步写入 `localStorage`；
  - 使用 `requestIdleCallback` 异步非关键处理。
- 建议测试：
  - 端到端计时：按钮点击到内容渲染时间；
  - 低端设备/节流下输入延迟与滚动流畅度抽样。

### 3.3 可靠性（Reliability）与恢复（Resilience）
- 要点：
  - 草稿存取、异常降级、模板加载失败时可重试。
- 建议：
  - `localStorage` 访问失败（隐私模式）时，回退到内存态并显式提示；
  - 模板加载失败显示重试按钮与占位文案；
  - 关键路径加最小错误兜底并记录。
- 建议测试：
  - 注入 `localStorage` 抛错场景；
  - 模板资源 404/超时场景的容错提示。

### 3.4 可用性/可达性（Usability/Accessibility）
- 要点：
  - 深色模式、键盘可达性、ARIA 标签、表单校验文案非技术化。
- 建议：
  - 关键控件：Load/Reset、requirements 输入、metadata 字段，均有 `aria-label` 与 `data-testid`；
  - 表单校验实时反馈并能聚焦到出错字段；
  - 色彩对比度达标（WCAG AA）。
- 建议测试：
  - 键盘 Tab 顺序；
  - 读屏器朗读关键控件；
  - 暗色主题下对比度快检。

### 3.5 可维护性（Maintainability）与可扩展性（Scalability）
- 要点：
  - 类型共享、自包含服务层、目录组织与组件职责清晰。
- 建议：
  - 类型在 `packages/shared/src/strategy.ts` 单一来源；
  - 组件分层：表单与编辑器解耦；服务层封装 `saveDraft/loadDraft`；
  - 预留后端 API 替换点，避免耦合 `localStorage`。
- 建议测试：
  - 单测覆盖类型约束与服务层契约；
  - 变更模板或字段对组件的影响面有限（快照/契约测试）。

### 3.6 可观测性（Observability）
- 要点：
  - 前端错误日志与用户可见错误提示分离；
  - 关键操作打点（加载模板、保存草稿、提交占位）。
- 建议：
  - 统一错误工具（`apps/web/src/services/errors.ts`）输出结构化日志（仅在开发/受控环境）；
  - 加入最小埋点接口以便后续上报集成。

---

## 4. 风险登记与映射（与风险文档对齐）
- SEC-001 供应链依赖 → 输入校验、后端隔离安装、禁止指令/URL。
- SEC-002 XSS → 预览安全渲染、禁 `dangerouslySetInnerHTML`、单测注入样例。
- OPS-001 受保护路由 → `(dashboard)` 会话守卫；未登录重定向。
- PERF-001 编辑器性能 → 懒加载与资源约束；交互延迟阈值测试。
- DATA-001 草稿存取异常 → 内存回退与提示。
- DATA-002 草稿一致性 → 写入节流与校验。

---

## 5. 结论与建议（Summary & Recommendations）
- 结论：在遵循上述约束与测试的前提下，Story 1.2 的 NFR 风险可控，建议与单元/集成/E2E 的 P0 场景联动执行。
- 建议优先级：
  - P0：受保护路由守卫、XSS 防护、依赖输入校验、编辑器懒加载与关键打点。
  - P1：草稿异常回退、键盘可达性、对比度、错误提示一致化。
  - P2：低端设备性能抽样、读屏器细化用例、快照/契约测试补强。

---

## 6. 可执行检查清单（用于评审/CI 快检）
- [ ] `(dashboard)` 下未登录访问被重定向；
- [ ] 编辑器仅在客户端渲染；
- [ ] 依赖条目前端校验（字符与版本模式）；
- [ ] 禁用危险渲染（无 `dangerouslySetInnerHTML`）；
- [ ] 模板加载/重置 < 150ms（样本测试）；
- [ ] 输入延迟 < 50ms（样本测试）；
- [ ] 草稿存取异常可回退；
- [ ] 关键控件具备 `aria-label` 与 `data-testid`；
- [ ] 错误提示用户可读、统一来源；
- [ ] 关键操作具备最小打点（可控环境）。
