# Test Design: Story 2.4

Date: 2025-09-25 (UTC+8)
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 13
- Unit tests: 4 (31%)
- Integration tests: 5 (38%)
- E2E tests: 4 (31%)
- Priority distribution: P0=7, P1=6, P2=0, P3=0

## Test Scenarios by Acceptance Criteria

### AC1：总进度可视化与停机提示

| ID             | Level       | Priority | Test                                                                                       | Justification                                                                 | Mitigates |
|----------------|-------------|----------|--------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|-----------|
| 2.4-UNIT-001   | unit        | P0       | `useOptimizationStatus` hook/服务在父作业终态下冻结 `summary` 并停止轮询                    | 纯逻辑判断与状态机分支，需快速保证停机后不再刷新                               | TECH-001 |
| 2.4-INT-001    | integration | P0       | `/api/v1/optimizations/{id}/status` 早停/取消后返回稳定 `summary`，包含版本戳与提示字段      | 验证 API、持久层与状态锁配合，确保终值一致                                     | TECH-001 |
| 2.4-E2E-001    | e2e         | P1       | 模拟寻优→早停→详情页：进度条冻结、停机提示可见、`summary` 不回退                          | 端到端确认用户体验与提示文案符合 AC                                            | TECH-001, BUS-001 |
| 2.4-INT-005    | integration | P1       | 前端服务层轮询节流：SWR/Query 间隔根据作业状态调整，API 响应无过载                        | 验证轮询调度与 API 节流策略，防止性能退化                                      | PERF-001 |

### AC2：Top-N 动态榜单

| ID             | Level       | Priority | Test                                                                                       | Justification                                                                 | Mitigates |
|----------------|-------------|----------|--------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|-----------|
| 2.4-UNIT-002   | unit        | P0       | 排序/提示辅助函数基于 `earlyStopPolicy.mode` 确定升降序及 UI 提示                          | 纯函数逻辑，确保排序方向一致                                                   | DATA-001 |
| 2.4-INT-002    | integration | P0       | Orchestrator 更新 summary 后，API `topN` 与 DB 数据一致且包含 `score`、`resultSummaryId`   | 覆盖持久层聚合到 API 响应的跨组件流程                                          | DATA-001 |
| 2.4-E2E-002    | e2e         | P1       | UI Top-N 动态刷新、展示空态、并保留早停终值                                               | 确认用户可浏览最终榜单并理解排序方向                                           | DATA-001, BUS-001 |

### AC3：汇总导出

| ID             | Level       | Priority | Test                                                                                       | Justification                                                                 | Mitigates |
|----------------|-------------|----------|--------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|-----------|
| 2.4-UNIT-003   | unit        | P0       | 导出打包器只消费 `ResultSummary.artifacts` 生成结构化文件，显式拒绝回测触发               | 核心逻辑可在单元级验证，阻止误调用重回测                                       | OPS-001 |
| 2.4-INT-003    | integration | P0       | 导出端点在成功、404、权限错误、内部异常下返回约定响应并记录结构化日志                     | API 与存储层交互、错误映射需整体验证                                           | OPS-001 |
| 2.4-E2E-003    | e2e         | P1       | 详情页导出→下载→失败提示降级场景                                                          | 确保用户流程顺畅并捕获失败 fallback                                            | OPS-001 |

### AC4：复运行入口

| ID             | Level       | Priority | Test                                                                                       | Justification                                                                 | Mitigates |
|----------------|-------------|----------|--------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------|-----------|
| 2.4-UNIT-004   | unit        | P1       | 前端复运行请求构造器复制 `paramSpace` 与 `earlyStopPolicy` 并附带 `sourceJobId`            | 保证复运行 payload 在发送前即正确                                             | BUS-001 |
| 2.4-INT-004    | integration | P0       | `POST /api/v1/optimizations` 复运行：成功、新作业写历史、跨租户/缺字段拒绝、审计日志       | 关键跨组件交互，确保鉴权与写库正确                                             | SEC-001, BUS-001 |
| 2.4-E2E-004    | e2e         | P1       | Top-N → 复运行 → 历史列表跳转：预填参数确认、成功提示、源作业链接回跳                     | 关键用户路径，验证体验与数据连通性                                             | BUS-001 |

## Risk Coverage

- TECH-001：2.4-UNIT-001, 2.4-INT-001, 2.4-E2E-001
- DATA-001：2.4-UNIT-002, 2.4-INT-002, 2.4-E2E-002
- OPS-001：2.4-UNIT-003, 2.4-INT-003, 2.4-E2E-003
- PERF-001：2.4-INT-005
- BUS-001：2.4-E2E-001, 2.4-E2E-002, 2.4-UNIT-004, 2.4-INT-004, 2.4-E2E-004
- SEC-001：2.4-INT-004

所有高风险（Score 6）均至少覆盖一个 P0 测试；中低风险配置在 P1 测试并辅以监控。

## Recommended Execution Order

1. P0 Unit：2.4-UNIT-001, 2.4-UNIT-002, 2.4-UNIT-003
2. P0 Integration：2.4-INT-001, 2.4-INT-002, 2.4-INT-003, 2.4-INT-004
3. P0 回归确认完成后补充 P1 Integration：2.4-INT-005
4. P1 Unit：2.4-UNIT-004
5. P1 E2E：2.4-E2E-001, 2.4-E2E-002, 2.4-E2E-003, 2.4-E2E-004

## Gate Inputs

```yaml
test_design:
  scenarios_total: 13
  by_level:
    unit: 4
    integration: 5
    e2e: 4
  by_priority:
    p0: 7
    p1: 6
    p2: 0
    p3: 0
  coverage_gaps: []
```

---

Test design matrix: docs/qa/assessments/2.4-test-design-20250925.md
P0 tests identified: 7
