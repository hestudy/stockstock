# Requirements Traceability Matrix

## Story: 2.1 - Opt Grid Submit

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 2 (40%)
- Partially Covered: 3 (60%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: 提交优化作业（父作业）API 可用：`POST /api/v1/optimizations`

- 测试文件: `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`
  - 测试用例: `accepts a valid optimization submission`
  - Given: 已启用测试环境并允许鉴权旁路，准备包含有效 `versionId` 与混合型 `paramSpace` 的请求体
  - When: 向 `POST /api/v1/optimizations` 发送请求
  - Then: 返回 202，响应包含父作业 `id` 与 `status=queued`，并将估算结果与并发限制写入响应头，证明成功入队
  - coverage: integration
- 测试文件: `services/backtest/tests/test_orchestrator.py`
  - 测试用例: `test_create_optimization_job_records_state`
  - Given: 预设参数空间与并发限制，清理内存编排器存储
  - When: 调用 `create_optimization_job`
  - Then: 返回 `status=queued` 且生成的任务列表与参数组合一致，父作业被记录
  - coverage: unit
- 结论: **Full**

#### AC2: 组合上限与参数校验

- 测试文件: `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`
  - 测试用例: `rejects when param space exceeds limit`
  - Given: 设置 `OPT_PARAM_SPACE_MAX=3` 并准备产生 4 个组合的参数空间
  - When: 提交优化作业请求
  - Then: 返回 400，错误码 `E.PARAM_INVALID`，错误详细包含 `limit` 与 `estimate`
  - coverage: integration
- 测试文件: `services/backtest/tests/test_orchestrator.py`
  - 测试用例: `test_create_optimization_job_respects_limit`
  - Given: 设置参数空间上限为 3 并准备 4 组合
  - When: 调用 `create_optimization_job`
  - Then: 抛出 `ParamInvalidError`，说明服务端校验生效
  - coverage: unit
- 结论: **Full**

#### AC3: 并发与早停策略

- 测试文件: `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`
  - 测试用例: `accepts a valid optimization submission`
  - Given: 请求体包含 `concurrencyLimit=4` 与 `earlyStopPolicy`
  - When: 调用 API
  - Then: 响应头包含 `x-concurrency-limit=4`，证明 API 解析并限制并发值
  - coverage: integration
- 覆盖缺口:
  - 没有断言 `earlyStopPolicy` 被序列化并存入 orchestrator；也未验证并发限制在 orchestrator 内部生效
- 结论: **Partial**

#### AC4: 鉴权与多租户安全

- 测试文件: `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`
  - 测试用例: `returns 401 when authentication fails`
  - Given: 移除旁路标记并提交未鉴权请求
  - When: 调用 API
  - Then: 返回 401，错误码 `E.AUTH`
  - coverage: integration
- 测试文件: `services/backtest/tests/test_orchestrator.py`
  - 测试用例: `test_create_optimization_job_records_state`
  - Given: 指定 `owner_id` 与 `version_id`
  - When: 调用 `create_optimization_job`
  - Then: 生成的任务包含相同 `owner_id`，证明落库结构支持多租户字段
  - coverage: unit
- 覆盖缺口:
  - 缺少从 API 端验证 JWT 解析到的 `ownerId` 确实写入编排器记录的集成测试
- 结论: **Partial**

#### AC5: 测试与质量门

- 测试文件: `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`
  - 测试用例: 覆盖成功、参数无效、未鉴权三条路径
  - Given/When/Then: 详见 AC1 与 AC2 映射
  - coverage: integration
- 测试文件: `services/backtest/tests/test_orchestrator.py`
  - 测试用例: 覆盖父作业记录与参数校验两条核心路径
  - coverage: unit
- 覆盖缺口:
  - 验收标准要求的 E2E 场景（UI 提交流程与后续查询）未实现
  - 未发现覆盖早停策略的自动化测试
- 结论: **Partial**

### Critical Gaps

1. **早停策略持久化未被验证**
   - 风险: 若未正确传递早停配置，会导致资源浪费或作业无法提前终止
   - 建议: 在 `route.int.test.ts` 中断言 orchestrator 调用返回体/存储包含 `earlyStopPolicy`
2. **OwnerId 多租户约束缺少端到端验证**
   - 风险: 记录错误租户数据可能曝光策略或造成计费错位
   - 建议: 在集成测试中读取 `debugListJobs()` 或数据库断言 `ownerId`
3. **缺失 E2E/UI 回归**
   - 风险: 关键用户流程未验证，可能因路由或前端绑定错误导致无法提交
   - 建议: 为 `/optimizations` UI 定义 Cypress/Playwright 场景

### Test Design Recommendations

1. 扩充 `route.int.test.ts`，在成功用例中断言 `debugListJobs()[0].earlyStopPolicy` 与 `concurrencyLimit`，验证 API→编排器传递完整性。
2. 新增集成测试覆盖 JWT 解析：模拟真实 `Authorization` 头，断言记录的 `ownerId` 与令牌一致。
3. 设计 UI 级 E2E：通过前端表单提交最小参数空间并轮询父作业状态，确保端到端流程可用。

### Risk Assessment

- **高风险**: E2E 覆盖缺失 → 用户无法提交作业将直接阻断核心业务。
- **中风险**: 早停策略未验证 → 可能导致过度计算或无法提前收敛。
- **中风险**: 多租户 ownerId 未端到端验证 → 潜在数据泄露与审计问题。
- **低风险**: 现有单元/集成测试覆盖主要 happy path 与参数校验，基础质量可控。
