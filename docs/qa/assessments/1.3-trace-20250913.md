# Requirements Traceability Matrix

## Story: 1.3 - Backtest Submit

### Coverage Summary

- Total Requirements: 7
- Fully Covered: 5 (71.4%)
- Partially Covered: 2 (28.6%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: 提交入口存在，点击可提交当前草稿并获得 jobId

Coverage: FULL

Given-When-Then Mappings:

- Unit/Integration (UI wiring): `apps/web/src/app/(dashboard)/backtests/page.tsx`
  - Given: 用户位于 `(dashboard)/backtests` 页面且编辑器草稿可读
  - When: 点击“提交回测”按钮并触发 `onSubmit`
  - Then: 通过服务层提交，收到 `{ id, status }` 后展示提示并跳转 `/backtests/{id}`

- E2E: `apps/web/e2e/backtests.spec.ts::submit backtest triggers API and redirects to status page`
  - Given: 通过 cookie `e2e_auth_bypass=1` 绕过认证并打开 `/backtests`
  - When: 拦截 `POST /api/v1/backtests`，点击“提交回测”按钮
  - Then: 页面展示状态提示并跳转到 `/backtests/e2e-job-123`

#### AC2: Payload 契约包含 versionId 与 params；请求头含 JWT（或服务器附加）

Coverage: FULL

Given-When-Then Mappings:

- Unit: `apps/web/src/__tests__/strategies.service.test.ts::buildSubmitPayload carries metadata and requirements`
  - Given: 含 `metadata/requirements/source.params` 的策略草稿与 `versionId`
  - When: 调用 `buildSubmitPayload`
  - Then: 返回 payload 含 `versionId`、`params`（从 draft.source.params），并携带 `metadata/requirements`

- Integration: `apps/web/src/__tests__/backtests.service.test.ts::attaches clientRequestId and returns response on success`
  - Given: 服务层 `submitBacktest` 调用
  - When: 发送请求体
  - Then: 请求体包含 `versionId`、`params`、自动生成的 `clientRequestId`

- API: `apps/web/src/app/api/v1/backtests/route.ts` 与 `apps/web/src/__tests__/backtests.api.test.ts::returns 202 with {id,status}`
  - Given: 有效 payload
  - When: 命中 API 路由
  - Then: 返回 `202 { id, status }`，服务端负责认证（E2E/测试中经由开关绕过）

#### AC3: 成功反馈与跳转行为

Coverage: FULL

- UI/Flow: `apps/web/src/app/(dashboard)/backtests/page.tsx`
  - Given: 提交成功
  - When: 收到 `{ id, status }`
  - Then: 设置“已提交，正在跳转…”文案并 `router.push(/backtests/{id})`

- API 合约: `apps/web/src/__tests__/backtests.api.test.ts::returns 202 with {id,status}`
  - Given: 有效请求
  - When: 返回响应
  - Then: 状态码 202，含 `id/status`

- E2E: `apps/web/e2e/backtests.spec.ts` 同 AC1 所述

#### AC4: 失败处理（超时/429/4xx/5xx），统一错误文案与重试支持

Coverage: PARTIAL

- Integration: `apps/web/src/__tests__/backtests.service.test.ts::propagates apiClient error for non-2xx`
  - Given: API 返回 429/500
  - When: 服务层调用失败
  - Then: 抛出可断言的错误信息

- UI 映射: `apps/web/src/app/(dashboard)/backtests/page.tsx`
  - Given: 捕获异常消息
  - When: 包含 "429" 时
  - Then: 设置“请求过于频繁，请稍后重试。”用户文案

Gap: 暂无针对 UI 层错误提示与“重试”交互的单测/E2E 断言；未覆盖超时路径与 4xx/5xx 的多分支用户提示。

#### AC5: 速率限制与幂等键（clientRequestId）机制

Coverage: FULL

- Client 生成幂等键: `apps/web/src/services/backtests.ts::submitBacktest`
  - Given: payload 未提供 `clientRequestId`
  - When: 调用服务层
  - Then: 自动生成 UUID v4 并携带

- API 幂等：`apps/web/src/app/api/v1/backtests/route.ts` 与 `apps/web/src/__tests__/backtests.api.test.ts::returns same id for same clientRequestId within idempotency window`
  - Given: 相同 `clientRequestId` 于窗口期内
  - When: 重复调用
  - Then: 返回相同的 `id` 并设置相应响应头

- 速率限制：`apps/web/src/__tests__/backtests.api.test.ts::rate limits after several requests (429)`
  - Given: 同一 IP 在时间窗口内多次调用
  - When: 超过限制
  - Then: 返回 429，携带用户友好提示

#### AC6: 测试覆盖（单元/集成）与 E2E 钩子

Coverage: PARTIAL

- 单元/集成存在：
  - `apps/web/src/__tests__/strategies.service.test.ts`（payload 结构与数据传播）
  - `apps/web/src/__tests__/backtests.service.test.ts`（请求体与错误分支）
  - `apps/web/src/__tests__/backtests.api.test.ts`（API 路由校验、速率、幂等）
- E2E 钩子：`apps/web/e2e/backtests.spec.ts` 存在“占位流程”验证

Gap: 页面按钮可达性与错误提示的更细粒度 UI 测试缺失；E2E 提交流程为占位，后续故事将补充更完整断言。

#### AC7: 前端生成 clientRequestId 并透传到后端与日志上下文

Coverage: FULL

- Client 生成：`apps/web/src/services/backtests.ts::uuidv4 + submitBacktest`
- API 透传与缓存：`apps/web/src/app/api/v1/backtests/route.ts`（idempotencyCache）
- 测试：`apps/web/src/__tests__/backtests.service.test.ts` 与 `apps/web/src/__tests__/backtests.api.test.ts`

### Critical Gaps

1. 失败处理 UI 覆盖
   - Gap: 缺少对错误提示组件的单测/E2E 断言；未覆盖超时和 4xx/5xx 多分支用户文案
   - Risk: Medium - 影响可用性与可观测性
   - Action: 增加 UI 层错误映射测试与重试按钮/机制测试

2. E2E 提交流程为占位
   - Gap: 缺少对草稿前置、payload 关键字段、跳转后状态提示等更严格断言
   - Risk: Medium - 端到端流畅性在真实后端对接前风险未知
   - Action: 在 Story 1.4/1.5 中补强端到端验证

### Test Design Recommendations

1. 增加 UI 错误提示与重试交互的组件测试（JSDOM）
2. 扩展 E2E：断言请求体字段、跳转后概要提示、无障碍属性（aria-live/aria-disabled）
3. 引入 API 超时/重试退避的模拟与断言
4. 在服务层加入可观测日志 hook，并为 429/5xx 断言埋点

### Risk Assessment

- High Risk: 无
- Medium Risk: AC4（失败处理 UI）、AC6（E2E 占位）
- Low Risk: AC1/2/3/5/7 已具单测/集成/E2E 覆盖（或足够的演示覆盖）
