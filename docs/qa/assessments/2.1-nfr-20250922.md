# NFR Assessment: 2.1

Date: 2025-09-22
Reviewer: Quinn

## Summary

- Security: CONCERNS — API 401 逻辑健全，但对外部 Orchestrator 的调用缺少服务间鉴权与租户约束证据。
- Performance: PASS — 参数空间与并发都有服务器端硬限制并暴露指标，证明具备吞吐保护。
- Reliability: CONCERNS — `sendToRemote` 缺少重试/降级策略，远端编排器不可用时将直接失败。
- Maintainability: PASS — 新增路由/Orchestrator 单元与集成测试，文档同步更新。

Quality Score: 80

## Evidence

- 鉴权与输入校验
  - `apps/web/src/app/api/v1/optimizations/route.ts:20-74`：`resolveOwner` 通过 `getOwner()` 解析 JWT，失败抛 `E.AUTH`；`summarizeParamSpace`、`resolveConcurrencyLimit`、`validateEarlyStop` 逐项校验。
  - `apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`：覆盖 202/400/401 分支，确保鉴权与入参校验生效。
- 服务编排与性能保护
  - `apps/web/src/app/api/v1/optimizations/paramSpace.ts` 与 `services/backtest/app/orchestrator.py`：`safeMultiply` + `OPT_PARAM_SPACE_MAX` 限制组合数量，超限抛 `E.PARAM_INVALID`。
  - `apps/web/src/app/api/v1/optimizations/route.ts:10-18`：使用 `timeHttp` 打点路由延迟，响应头返回估算与并发上限。
- Orchestrator 调用路径
  - `apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:33-75`：优先远程调用 `/internal/optimizations`；若失败仅抛出 `E.DEP_UPSTREAM`，无重试或鉴权头。
  - `services/backtest/tests/test_orchestrator.py`：验证参数限制与任务展开逻辑。
- 文档同步
  - `docs/architecture/05-api-spec.md`：对齐 `/optimizations` 请求/响应与 header 说明。
  - `docs/schema.sql`：补充 `optimization_jobs/optimization_tasks` 结构与索引。

## Findings by NFR

### Security — CONCERNS
- Observations
  - API 层鉴权与输入校验全面，`E2E_AUTH_BYPASS` 默认仅在测试环境启用；401 分支有测试覆盖。
  - 调用外部 Orchestrator (`sendToRemote`) 时未附带任何鉴权信息或签名，若 `/internal/optimizations` 暴露在同一 VPC 之外易被滥用。
  - 尚无端到端证据表明记录的 `ownerId` 在远程服务持久化层被强制校验。
- Actions
  1. 为服务间调用加上 mTLS 或至少 HMAC Header，并在集成测试中断言缺失凭证时返回 401/403。
  2. 在 Orchestrator 层新增断言，校验传入 `ownerId` 与调用者身份，并补充测试/文档说明。

### Performance — PASS
- Observations
  - `OPT_PARAM_SPACE_MAX`（默认 500）与 `safeMultiply` 共同阻止指数爆炸；`limited_param_sets` 进一步将内存展开封顶 1000。
  - `resolveConcurrencyLimit` 默认 2、上限 16，并在响应头回显，便于前端自适应。
  - `timeHttp` 包装路由，结合 OTel 指标满足监控可观测。
- Actions
  1. 计划阶段引入压力测试脚本（如 k6）验证高并发下 202 延迟基线，形成回归数据（建议非阻断）。

### Reliability — CONCERNS
- Observations
  - API 层对输入错误、鉴权失败均能控制性返回；Python Orchestrator 在本地模式下可正常排队。
  - 远程模式无重试/断路器：`fetch` 失败直接转化为 5xx/`E.DEP_UPSTREAM`，调用方需手动重试；无幂等保护说明。
  - 未见监控/告警绑定（如 Orchestrator 健康检查或队列深度），容易在远端故障时静默失败。
- Actions
  1. 为 `sendToRemote` 增加最小指数回退重试与请求 ID 透传，或提供本地回退方案。
  2. 在 docs/architecture/14-monitoring-and-observability.md 中补充 Orchestrator 健康指标与失败告警策略。

### Maintainability — PASS
- Observations
  - TypeScript 路由与 Python Orchestrator 均有针对成功与失败路径的自动化测试；`debugListJobs`/`debug_reset` 便于测试隔离。
  - Param space 归一化封装在独立模块，易扩展；并伴随严格错误消息。
  - PR 同步更新 API Spec、Schema、共享类型，降低知识偏差。
- Actions
  1. 后续故事可将 `earlyStopPolicy` 序列化/反序列化逻辑抽到共享包，并扩充单元测试覆盖负面参数组合。

## Critical Issues
1. 服务间调用缺少鉴权/租户校验，存在被伪造请求滥用的风险。
2. Orchestrator 远程依赖无重试或状态监控，出现网络抖动/服务故障时将直接影响作业提交成功率。

## Quick Wins
- 在 `sendToRemote` 请求头加入共享密钥（临时方案）并在 Python 入口校验（<1h）。
- 结合 `debugListJobs()` 在集成测试中断言 `ownerId`、`earlyStopPolicy` 落库（<1h）。
- 为 `fetch` 失败补充一次快速重试与 `console.error` 日志，便于定位（<1h）。

---

# Gate YAML (copy/paste)

```yaml
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: "API 鉴权到位，但服务间调用缺乏鉴权/租户约束"
  performance:
    status: PASS
    notes: "参数空间/并发均有服务器端限制并通过 OTel 记录"
  reliability:
    status: CONCERNS
    notes: "远程 orchestrator 调用无重试/降级，失败将直接抛出"
  maintainability:
    status: PASS
    notes: "TS+Python 均有自动化测试且文档同步更新"
```

NFR assessment: docs/qa/assessments/2.1-nfr-20250922.md
