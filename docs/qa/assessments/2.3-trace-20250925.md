# Requirements Traceability Matrix

## Story: 2.3 - Workers & Early Stop

### Coverage Summary
- Total Requirements: 5
- Fully Covered: 4 (80%)
- Partially Covered: 1 (20%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: Worker 执行与持久化
**Coverage: FULL**
- `services/backtest/tests/test_worker.py::test_worker_process_success`
  - Given: 通过 `create_optimization_job` 创建的队列任务以及指标捕获钩子
  - When: 调用 `worker.process_next` 执行任务并返回 `score` 与 `resultSummaryId`
  - Then: 任务与父作业状态写回数据库，`result_summary_id` 更新，且 `queue_wait_seconds`、`job_exec_seconds`、`job_retry_total` 指标被发出（unit）
- `services/backtest/tests/test_worker.py::test_worker_retry_then_success`
  - Given: 同一任务第一次执行抛出 `WorkerError` 触发重试
  - When: 快进重试窗口后再次调用 `worker.process_next`
  - Then: Worker 将任务状态从排队恢复并成功写回 `score` 与累计 `retries`，指标颗粒覆盖失败/成功路径（unit）
- `services/backtest/tests/test_orchestrator.py::test_mark_task_succeeded_records_result_summary`
  - Given: Worker 完成任务后调用 `mark_task_succeeded`
  - When: 将 `result_summary_id` 与 `score` 写入 job summary
  - Then: `debug_tasks` 返回的持久对象携带新 `result_summary_id`，父作业统计同步更新（unit）
- `services/backtest/tests/test_orchestrator.py::test_top_n_updates_on_completion`
  - Given: 并发任务依次成功
  - When: 调用 `mark_task_succeeded` 更新成绩
  - Then: `summary.topN` 按分值排序保持最新 Top-N 结果（unit）

#### AC2: 阈值早停
**Coverage: FULL**
- `services/backtest/tests/test_orchestrator.py::test_early_stop_triggers_job_lock`
  - Given: 配置 `early_stop_policy` 的作业与超过阈值的任务结果
  - When: 调用 `mark_task_succeeded` 写入高分
  - Then: 父作业状态变为 `early-stopped`，派发停止且诊断中记录阈值原因（unit）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Early Stop & Cancel › updates status to early stop and hides throttle banner after refresh`
  - Given: 首次轮询返回运行中状态，后续轮询返回 `early-stopped`
  - When: 用户点击“立即刷新”
  - Then: 页面切换为提前停止状态，停机原因呈现且 Top-N 列表冻结（e2e）

#### AC3: 显式取消
**Coverage: FULL**
- `services/backtest/tests/test_orchestrator.py::test_cancel_job_updates_tasks_and_summary`
  - Given: 运行中父作业与至少一个派发任务
  - When: 调用 `cancel_job` 并传入原因
  - Then: 父作业标记为 `canceled` 并阻止后续派发，诊断记录停机原因（unit）
- `services/backtest/tests/test_main_internal_optimizations.py::test_cancel_endpoint_marks_job_and_returns_reason`
  - Given: FastAPI 内网端点启用共享密钥
  - When: 调用 `/internal/optimizations/{id}/cancel`
  - Then: 返回 `status=canceled` 且带 `stopReason` 元数据，拒绝越权取消（integration）
- `apps/web/src/app/api/v1/optimizations/__tests__/cancel.route.int.test.ts::cancels the optimization job and returns final diagnostics`
  - Given: Next.js API 层存在内存 orchestrator 模拟
  - When: 请求 `/api/v1/optimizations/:id/cancel`
  - Then: 返回 202 并在诊断中曝光 `CANCELED` 原因，同时后端 job 状态同步（integration）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Cancel Flow › cancels job and surfaces final diagnostics`
  - Given: UI 轮询运行中状态且取消路由被拦截为 202
  - When: 用户点击取消按钮
  - Then: 页面出现取消提示、状态改为“已取消”并禁用再次取消（e2e）

#### AC4: 运行指标记录
**Coverage: PARTIAL**
- `services/backtest/tests/test_worker.py::test_worker_process_success`
  - Given: 自定义 `emit_metric` 钩子记录事件
  - When: Worker 成功执行任务
  - Then: `queue_wait_seconds`、`job_exec_seconds`、`job_retry_total` 指标被捕获（unit）
- `services/backtest/tests/test_worker.py::test_worker_process_param_error`
  - Given: Runner 抛出参数错误
  - When: Worker 处理失败路径
  - Then: 核心指标在失败场景仍照常输出（unit）
- `services/backtest/tests/test_worker.py::test_worker_retry_then_success`
  - Given: 第一次执行失败并重试
  - When: 第二次执行成功
  - Then: 指标覆盖重试计数及队列等待阶跃（unit）
- `services/backtest/tests/test_worker.py::test_worker_respects_observability_toggle`
  - Given: 关闭指标/日志开关
  - When: Worker 执行任务
  - Then: 观测写入被短路以避免在禁用场景写日志（unit）
- **Coverage gap**: 缺少自动化断言以验证 Orchestrator 在早停/取消分支输出结构化日志与相关指标（如停机计数、派发终止事件）

#### AC5: 测试覆盖
**Coverage: FULL**
- `services/backtest/tests/test_worker.py::test_worker_process_success`
  - Given: 正常执行路径
  - When: Worker 完成任务
  - Then: 单元测试覆盖成功流程（unit）
- `services/backtest/tests/test_worker.py::test_worker_process_param_error`
  - Given: 参数错误
  - When: Worker 报错
  - Then: 单测覆盖失败路径（unit）
- `services/backtest/tests/test_worker.py::test_worker_retry_then_success`
  - Given: 第一次失败、第二次成功
  - When: 重试逻辑运行
  - Then: 单测覆盖重试行为（unit）
- `services/backtest/tests/test_orchestrator.py::test_early_stop_triggers_job_lock`
  - Given/When/Then: 参见 AC2，提供早停覆盖（unit）
- `services/backtest/tests/test_main_internal_optimizations.py::test_cancel_endpoint_marks_job_and_returns_reason`
  - Given/When/Then: 参见 AC3，验证 API 集成（integration）
- `apps/web/src/app/api/v1/optimizations/__tests__/cancel.route.int.test.ts::cancels the optimization job and returns final diagnostics`
  - Given/When/Then: 参见 AC3，验证前端服务层集成（integration）
- `apps/web/e2e/optimizations-detail.spec.ts`（三个场景）
  - Given: UI 假数据与拦截
  - When: 提交 / 刷新 / 取消
  - Then: Playwright 覆盖端到端成功、早停与取消流程（e2e）

### Critical Gaps
1. **Orchestrator 指标与日志未被测试捕获**
   - 范围：未验证早停/取消分支的指标名称和值
   - 风险：可能在生产中缺失观测信号导致问题难以排查

### Test Design Recommendations
1. 新增 `test_orchestrator.py` 覆盖：打桩 `emit_metric` 并断言早停与取消路径的事件与标签。
2. 在 FastAPI 或 Next.js 层增加集成测试，校验取消/早停日志 payload（结构化字段）。
3. Playwright 扩展：模拟指标面板不可用场景，验证 UI 在缺失数据时的降级提示。

### Risk Assessment
- **Medium**：观测指标缺口可能延迟 SLO 趋势发现。
- **Low**：功能流程已覆盖主要正负路径，端到端验证完整。
