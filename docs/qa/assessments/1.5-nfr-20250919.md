# NFR Assessment: 1.5

Date: 2025-09-19
Reviewer: Quinn

## Summary

- Security: CONCERNS — 端点覆盖与密钥管理证据不足；虽有 `rateLimit` 与统一错误包装，但未见全面策略与门限说明。
- Performance: PASS — E2E 验证摘要区域 2 秒内可见；API 指标封装 `timeHttp/recordHttp` 存在并可导出。
- Reliability: PASS — 一致的错误包装 `wrap()` 与多分支（400/401/429/500）测试；Workers 结构化日志 helper 存在与单测覆盖。
- Maintainability: CONCERNS — 覆盖率阈值未定义；建议为 FE/API/Workers 可观测路径设定阈值与度量看板。

Quality Score: 80

## Evidence

- Frontend observability
  - `apps/web/src/utils/observability.ts` 提供 `trackSummaryRendered/trackError`，并在非生产环境通过 `window.__OBS_EVENTS__` 挂钩便于断言
  - E2E 断言：`apps/web/e2e/backtests-detail.spec.ts` 中
    - 2 秒内摘要可见（“Summary within 2 seconds”）
    - 观测事件 `summary_rendered` 被捕获（严格断言）
- API metrics & error handling
  - `apps/web/src/app/api/_lib/otel.ts`：`timeHttp/recordHttp` 记录路由+方法+状态+耗时
  - `apps/web/src/app/api/_lib/handler.ts`：统一错误包装 `wrap()` 输出 `ApiError`（含 requestId/timestamp）
  - `apps/web/src/app/api/v1/backtests/[id]/result/__tests__/route.test.ts` 覆盖 200/400/401/429/500
- Workers observability
  - `services/backtest/app/observability.py` 结构化日志 helper
  - `services/backtest/tests/test_observability.py` 单测覆盖

## Findings by NFR

### Security — CONCERNS
- Observations
  - 路由侧存在 `rateLimit` 模块并在单测中覆盖 429 情形，但未见全局策略与关键鉴权端点（如登录、敏感查询）的频控清单
  - 密钥管理（如 `SENTRY_DSN`/OTLP endpoint token）依赖环境变量，但缺少最小清单与轮换/加载策略文档
  - 错误包装避免泄露栈信息，符合“最小暴露”原则
- Actions
  1. 为所有敏感端点列出频控策略表（方法/路由/桶容量/时间窗/溢出响应）并在单测中覆盖至少 1 个。
  2. 文档化密钥来源（.env/CI Secret）、加载与轮换策略；确保无硬编码密钥扫描（CI 规则）。

### Performance — PASS
- Observations
  - E2E 证明 `(dashboard)/backtests/[id]` 摘要区域 2 秒目标达成
  - API 指标通过 `timeHttp` 记录；可通过环境变量控制启用
- Actions
  1. 在 CI 引入轻量性能冒烟（可基于 Playwright trace）记录首屏耗时分布（p50/p95）以防回退。

### Reliability — PASS
- Observations
  - 统一错误包装，多分支测试覆盖，前端错误提示可控
  - Workers 关键路径具备结构化日志与单测
- Actions
  1. 后续可添加“失败重试/断路器”情景的监控与日志字段扩展（非本故事硬性要求）。

### Maintainability — CONCERNS
- Observations
  - FE/API/Workers 各层均有最小单测与 E2E，但未设统一覆盖率阈值与可观测性专属看板指标（如事件计数、指标导出成功率）
- Actions
  1. 设定最小覆盖率阈值（建议：行 80%/分支 70%），并将 FE 可观测封装/API 指标/Workers 日志纳入覆盖目标。
  2. 增加配置切换用例覆盖 `OBS_ENABLED`、`NEXT_PUBLIC_OBS_ENABLED`、`OTEL_*`：启动/禁用路径均应稳定。
  3. 在 API 路由测试中对 `recordHttp` 的调用进行集成级断言（可通过注入/spy 方式），确保 2xx/4xx/5xx 均产生度量。

## Critical Issues
1. 安全频控策略清单与密钥管理策略缺少“明确证据”。
2. 覆盖率阈值未定义，难以量化维护性基线。

## Quick Wins
- 在现有路由单测中加入对 `recordHttp` 的 spy 断言（<1h）。
- 在 CI 配置覆盖率阈值并出具徽章（<1h）。
- 编写 `SECURITY.md` 中的密钥/频控最小策略章节（1–2h）。

---

# Gate YAML (copy/paste)

```yaml
nfr_validation:
  _assessed: [security, performance, reliability, maintainability]
  security:
    status: CONCERNS
    notes: "Rate limit 策略与密钥管理证据不足；错误包装避免信息泄露"
  performance:
    status: PASS
    notes: "E2E 验证 2s 首屏；API timeHttp 记录路由级时延"
  reliability:
    status: PASS
    notes: "统一错误包装与多分支测试；Workers 结构化日志与单测"
  maintainability:
    status: CONCERNS
    notes: "覆盖率阈值未设；需补集成断言与配置切换用例"
```

NFR assessment: docs/qa/assessments/1.5-nfr-20250919.md

Gate NFR block ready → paste into docs/qa/gates/1.5-minimal-observability.yml under nfr_validation
