# Test Design: Story 2.1

Date: 2025-09-22
Designer: Quinn (Test Architect)

## Test Strategy Overview
- Total test scenarios: 16
- Unit tests: 7 (44%)
- Integration tests: 7 (44%)
- E2E tests: 2 (12%)
- Priority distribution: P0: 11, P1: 4, P2: 1, P3: 0

## Test Scenarios by Acceptance Criteria

### AC1: 提交优化作业 API 可用

#### Scenarios
| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-001   | Unit        | P0       | 请求体验证通过且默认 `concurrencyLimit=2`，`earlyStopPolicy` 可选     | 纯函数校验逻辑，快速阻断无效提交，避免脏数据写入（缓解 DATA-201） |
| 2.1-UNIT-002   | Unit        | P1       | `earlyStopPolicy` 字段结构校验：`metric`/`threshold`/`mode` 完整且 `mode` 仅限 `min|max` | 保证下游调度规则输入合法，避免运行期异常 |
| 2.1-INTEGRATION-001 | Integration | P0   | 鉴权用户提交合法 payload → 返回 202 `{ id, status:'queued' }` 并调用 Orchestrator | 覆盖主成功路径，确保契约与 Orchestrator 集成正常（关联 BUS-201） |

### AC2: 组合上限与参数校验

#### Scenarios
| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-003   | Unit        | P0       | 参数空间组合估算：离散值/区间混合输入时计算正确且遇上限提前短路     | 防止误判合法输入与指数级展开，缓解 TECH-201、PERF-201 |
| 2.1-UNIT-004   | Unit        | P0       | 组合数超过上限 → 返回 `fail('E.PARAM_INVALID', ...)`，包含 `{ limit, estimate }` | 确保错误载荷一致，方便前端提示（TECH-201） |
| 2.1-INTEGRATION-004 | Integration | P0   | 超过上限 payload → API 返回 400 `ApiError`，日志落地限制与估算值     | 验证端到端错误路径，支持监控/审计 |
| 2.1-INTEGRATION-006 | Integration | P1   | Orchestrator 持久化记录包含 `ownerId/versionId/paramSpace` 等关键字段 | 确保数据完整性与多租户审计（DATA-201） |

### AC3: 并发与早停策略

#### Scenarios
| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-005   | Unit        | P0       | Orchestrator 并发闸门：激活计数达到 `concurrency_limit` 时阻断新任务 | 直接缓解 OPS-201，避免资源泛滥 |
| 2.1-UNIT-006   | Unit        | P1       | 早停评估：基于 `mode=min|max` 与 `threshold` 正确终止父作业         | 保证早停策略有序生效，减少浪费 |
| 2.1-INTEGRATION-005 | Integration | P0   | API 成功提交时将 `concurrencyLimit` 与 `earlyStopPolicy` 透传给 Orchestrator | 验证跨服务数据链路完整，保障 OPS-201 |
| 2.1-INTEGRATION-007 | Integration | P0   | Orchestrator 接收多次提交时遵守并发上限：同一租户第 N+1 个任务排队/拒绝 | 防止调度层失控，支撑并发策略（OPS-201） |

### AC4: 鉴权与多租户安全

#### Scenarios
| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-UNIT-007   | Unit        | P0       | `getOwner()` 中间件：合法 JWT 返回 `ownerId`，缺失/伪造时抛出 `E.AUTH` | 单点鉴权逻辑快速失败，缓解 SEC-201 |
| 2.1-INTEGRATION-002 | Integration | P0   | 未附 JWT 或 token 过期 → API 返回 401 `E.AUTH`                        | 覆盖未鉴权路径，防止未授权访问 |
| 2.1-INTEGRATION-003 | Integration | P0   | 鉴权用户请求他人 `versionId` → 返回 403/404 并拒绝写入               | 阻断跨租户滥用（SEC-201） |

### AC5: 测试与质量门

#### Scenarios
| ID             | Level       | Priority | Test                                                                 | Justification |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | ------------- |
| 2.1-INTEGRATION-001 | Integration | P0   | （与 AC1 共享）主成功路径回归测试纳入流水线                           | 满足集成测试要求，保证核心契约稳定 |
| 2.1-E2E-001   | E2E         | P1       | 通过 UI 提交最小参数空间 → 收到父作业 `id` 并在状态列表看到队列中记录 | 验证端到端体验闭环，缓解 BUS-201 |
| 2.1-E2E-002   | E2E         | P2       | UI 提交超过上限参数 → 呈现 `E.PARAM_INVALID` 友好提示                | 确保错误路径体验与诊断信息到位 |

## Risk Coverage
- OPS-201（并发限制失效）：2.1-UNIT-005、2.1-INTEGRATION-005、2.1-INTEGRATION-007
- TECH-201（组合校验错误）：2.1-UNIT-003、2.1-UNIT-004、2.1-INTEGRATION-004
- SEC-201（租户校验缺失）：2.1-UNIT-007、2.1-INTEGRATION-002、2.1-INTEGRATION-003
- PERF-201（组合展开过载）：2.1-UNIT-003、2.1-INTEGRATION-004
- DATA-201（持久化脏数据）：2.1-UNIT-001、2.1-INTEGRATION-006
- BUS-201（状态不可见）：2.1-INTEGRATION-001、2.1-E2E-001、2.1-E2E-002

## Recommended Execution Order
1. P0 单元测试：请求校验、组合估算、鉴权、并发闸门
2. P0 集成测试：API 成功/失败路径、跨租户校验、并发透传
3. P0 E2E 流程：最小参数空间提交与状态可见性
4. P1 层级测试：早停逻辑、持久化字段完整性、UI 正常路径
5. P2 场景：UI 错误提示及其他低频体验验证

## Coverage Checklist
- [x] 每条验收标准至少 1 个测试场景
- [x] 测试层级选择遵循金字塔原则
- [x] 无重复覆盖；不同层级验证不同关注点
- [x] 优先级与风险评分对齐
- [x] 测试 ID 符合 `{epic}.{story}-{LEVEL}-{SEQ}` 规范

---

# Gate YAML Snippet (test_design)

```yaml
test_design:
  scenarios_total: 16
  by_level:
    unit: 7
    integration: 7
    e2e: 2
  by_priority:
    p0: 11
    p1: 4
    p2: 1
    p3: 0
  coverage_gaps: []
```

# Trace References

```
Test design matrix: docs/qa/assessments/2.1-test-design-20250922.md
P0 tests identified: 11
```
