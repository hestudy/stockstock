# Requirements Traceability Matrix

## Story: 1.2 - Strategy Template & Editor

### Coverage Summary

- Total Requirements: 5
- Fully Covered: 2 (40%)
- Partially Covered: 3 (60%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: 内置策略模板：提供至少一个可运行的策略模板（含示例参数），支持一键加载/重置到编辑器。

Coverage: FULL

Given-When-Then Mappings:

- Unit Test: `apps/web/src/__tests__/strategyEditor.component.test.tsx::renders and loads template into editor`
  - Given: 组件渲染完成且初始状态加载模板
  - When: 初次渲染与副作用执行
  - Then: 编辑器文本不为空（模板内容已加载）

- Unit Test: `apps/web/src/__tests__/strategyEditor.component.test.tsx::reset button restores template content`
  - Given: 编辑器内容被用户修改
  - When: 点击 `data-testid=reset-template` 按钮
  - Then: 编辑器内容恢复为模板原始内容

- E2E Test: `apps/web/e2e/backtests.spec.ts::shows editor and template actions`
  - Given: 已通过 cookie 方式绕过登录，访问 `/backtests`
  - When: 页面加载完成
  - Then: 可见 `data-testid=editor` 与 `data-testid=reset-template`，表明模板相关 UI 已就绪

#### AC2: 语法高亮：策略代码编辑器具备语法高亮和基础编辑体验（行号、自动缩进、错误高亮占位）。

Coverage: PARTIAL

Given-When-Then Mappings:

- Unit Test: `apps/web/src/__tests__/strategyEditor.component.test.tsx::renders and loads template into editor`
  - Given: 组件加载 CodeMirror（测试中以 textarea mock）
  - When: 初次渲染
  - Then: 编辑器可输入/展示内容（基础编辑体验有最小保障）

- Implementation Reference: `apps/web/src/components/forms/StrategyEditor.tsx`
  - Given: 引入 `@uiw/react-codemirror` 与 `@codemirror/lang-python`
  - When: 配置 `extensions={[python()]}` 与 `basicSetup={{ lineNumbers: true }}`
  - Then: 具备语法高亮与行号的基础体验（但缺少针对“错误高亮占位”的验证用例）

Gaps:

- 缺少针对“错误高亮占位”的显式测试（例如语法错误高亮/占位出现与可访问性属性）

#### AC3: 依赖声明：支持在 UI 中维护策略的 requirements 清单，提交时一并保存/传递。

Coverage: PARTIAL

Given-When-Then Mappings:

- Unit Test: `apps/web/src/__tests__/strategyEditor.component.test.tsx::requirements invalid input shows validation message`
  - Given: 用户在依赖输入框 `data-testid=requirements-input` 中输入非法格式
  - When: 触发 input/change/blur 事件
  - Then: 出现校验错误信息（`data-testid=requirements-error`）

- Integration Test: `apps/web/src/__tests__/strategies.service.test.ts::saves and loads draft`
  - Given: 构造包含 requirements 的 `StrategyDraft`
  - When: 通过 `saveDraft`/`loadDraft` 持久化与读取
  - Then: 能正确读取保存的依赖内容

- Integration Test: `apps/web/src/__tests__/strategies.service.test.ts::submitBacktest mock returns ok`
  - Given: 构造 `BacktestSubmitRequest`（含 draft）
  - When: 调用 `submitBacktest`
  - Then: 返回 `{ ok: true }`（验证提交通道存在）

Gaps:

- 缺少提交 payload 中 `requirements` 字段在 UI→服务层→提交层完整链路的端到端校验（可在集成或 E2E 中断言 payload 结构）

#### AC4: 元数据可编辑：支持维护策略元数据（名称、标签、描述、版本时间戳等），并在提交时随作业上送。

Coverage: PARTIAL

Given-When-Then Mappings:

- Implementation Reference: `apps/web/src/components/forms/StrategyEditor.tsx`（存在名称/标签/描述/时间戳输入控件）
  - Given: 用户编辑元数据输入框
  - When: 触发 onChange 事件
  - Then: 本地状态与草稿持久化更新（`saveDraft`）

- Integration Test: `apps/web/src/__tests__/strategies.service.test.ts::saves and loads draft`
  - Given: `StrategyDraft` 带元数据
  - When: 保存/读取草稿
  - Then: 元数据可正确还原

Gaps:

- 缺少组件层面对元数据输入控件行为的单元测试（名称/标签拆分逻辑、时间戳可编辑性）
- 缺少提交 payload 中元数据携带性的断言（集成/E2E）

#### AC5: 可测与可集成：具备单元/集成测试覆盖（前端组件与服务层），并预留 E2E 场景钩子（登录后进入编辑器页）。

Coverage: FULL

Given-When-Then Mappings:

- Unit Tests: 组件层覆盖模板加载/重置、依赖校验
  - Given: 组件渲染
  - When: 用户操作与副作用
  - Then: 对应行为被断言

- Integration Tests: 服务层草稿保存/读取与提交占位
  - Given: 构造 draft 与请求
  - When: 调用服务方法
  - Then: 正确读写与提交通道存在

- E2E Test: `apps/web/e2e/backtests.spec.ts`
  - Given: 通过 cookie 绕过登录
  - When: 访问 `/backtests`
  - Then: 编辑器与模板按钮可见（E2E 钩子已接入）

### Critical Gaps

1. 错误高亮占位（AC2）
   - Gap: 无针对错误高亮/占位的显式测试
   - Risk: Medium - 影响编辑器可用性与可达性
   - Action: 添加单元测试，模拟错误内容并断言可达性提示/样式占位

2. 提交 payload 完整性（AC3/AC4）
   - Gap: 未端到端验证 `requirements` 与 `metadata` 在提交请求中的存在与结构
   - Risk: Medium - 影响后续 1.3/1.4 串联
   - Action: 在集成测试中对 `submitBacktest` 进行 payload 参数断言；或在 E2E 中拦截网络请求断言

### Test Design Recommendations

1. 新增 AC2 相关用例：针对错误高亮占位与可访问性属性（aria）
2. 新增 AC3/AC4 集成/端到端用例：断言提交 payload 携带 `metadata` 与 `requirements`
3. 为元数据输入控件添加组件单元测试（名称/标签/时间戳）
4. 在 E2E 中增加模板加载与表单编辑的交互路径校验

### Risk Assessment

- High Risk: 无
- Medium Risk: AC2、AC3/AC4 覆盖为 PARTIAL 的条目
- Low Risk: AC1、AC5 已 FULL 覆盖
