# Requirements Traceability Matrix

## Story: 2.4 - Progress & Aggregation

### Coverage Summary
- Total Requirements: 4
- Fully Covered: 4 (100%)
- Partially Covered: 0 (0%)
- Not Covered: 0 (0%)

### Requirement Mappings

#### AC1: 总进度可视化
**Coverage: FULL**
- `apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx::renders progress bar and sorting note`
  - Given: 详情页服务层返回运行中作业的 `summary.total/finished/status`
  - When: 页面渲染详情组件并等待轮询完成
  - Then: 进度条展示 "4/10"、父作业状态标签与轮询刷新提示（unit）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Early Stop & Cancel › updates status to early stop and hides throttle banner after refresh`
  - Given: 首次轮询为运行中状态，后续返回 `early-stopped` 终值
  - When: 用户点击“立即刷新”强制触发第二次请求
  - Then: 页面切换为提前停止状态、停机提示出现且进度面板固化终值（e2e）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Cancel Flow › cancels job and surfaces final diagnostics`
  - Given: 轮询返回运行中状态且取消接口可用
  - When: 用户点击取消按钮
  - Then: UI 呈现终止提示、进度栏冻结并清除节流信息（e2e）
- `services/backtest/tests/test_main_internal_optimizations.py::test_cancel_endpoint_marks_job_and_returns_reason`
  - Given: 内部 FastAPI 启用共享密钥保护
  - When: 调用 `/internal/optimizations/{id}/cancel`
  - Then: 返回 `status=canceled`、诊断携带 `stopReason`，验证后端锁定终值（integration）
- `services/backtest/tests/test_orchestrator.py::test_early_stop_triggers_job_lock`
  - Given: 作业配置 `early_stop_policy`
  - When: 第一批任务达到阈值
  - Then: 父作业状态变为 `early-stopped` 并阻止追加派发，确保 summary 固定（unit）

#### AC2: Top-N 动态榜单
**Coverage: FULL**
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Top-N & Throttle › renders throttling banner and sorted topN table`
  - Given: 轮询返回带节流状态与 `summary.topN`
  - When: 页面加载详情页
  - Then: Top-N 表格按分值降序呈现 `taskId/score` 并显示节流提示（e2e）
- `apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx::renders progress bar and sorting note`
  - Given: `earlyStopPolicy.mode = "max"`
  - When: 详情组件渲染 Top-N 提示
  - Then: UI 显示“降序展示”说明，确保方向提示正确（unit）
- `services/backtest/tests/test_orchestrator.py::test_top_n_updates_on_completion`
  - Given: 连续完成三条任务
  - When: 标记成功并写回分数
  - Then: `summary.topN` 依分值降序排序（unit）
- `services/backtest/tests/test_orchestrator.py::test_top_n_respects_min_mode`
  - Given: `early_stop_policy.mode = "min"`
  - When: 依次写入得分
  - Then: Top-N 列表按升序排序并保留最低分在首位（unit）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Early Stop & Cancel › updates status to early stop and hides throttle banner after refresh`
  - Given: 第二次轮询返回 `early-stopped` 终值
  - When: 页面刷新状态
  - Then: Top-N 列表锁定终值且仍可浏览（e2e）

#### AC3: 汇总导出
**Coverage: FULL**
- `apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx::calls export bundle and shows notice`
  - Given: 服务层导出方法模拟返回 Top-N 聚合包
  - When: 用户点击导出按钮
  - Then: 生成下载链接并提示“已导出 Top-N 聚合包”（unit）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Export & Rerun › exports bundle then reruns and redirects to new job`
  - Given: 导出接口返回成功 JSON
  - When: 用户点击导出按钮
  - Then: 页面显示成功提示且流程不中断（e2e）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Export & Rerun › surfaces export and rerun errors without breaking UI`
  - Given: 导出接口返回 500 错误
  - When: 用户触发导出
  - Then: UI 显示统一错误提示并保持详情页可用（e2e）
- `apps/web/src/app/api/v1/optimizations/__tests__/export.route.int.test.ts::returns downloadable bundle with Top-N artifacts`
  - Given: 内存 orchestrator 填充 Top-N 结果
  - When: 调用 `/api/v1/optimizations/{id}/export`
  - Then: 返回 `content-disposition` 与带 `artifacts/metrics` 的 JSON 包（integration）
- `services/backtest/tests/test_main_internal_optimizations.py::test_export_endpoint_returns_topn_bundle`
  - Given: FastAPI 内部导出端点
  - When: 请求导出
  - Then: 响应含 `items.artifacts` 且无回测重跑（integration）
- `services/backtest/tests/test_orchestrator.py::test_export_top_n_bundle_contains_artifacts`
  - Given: Orchestrator Top-N 数据已写回
  - When: 调用 `export_top_n_bundle`
  - Then: 返回包含指标与 artifact 引用的聚合包（unit）

#### AC4: 复运行入口
**Coverage: FULL**
- `apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx::invokes rerun and redirects`
  - Given: 服务层 `rerunOptimization` 模拟成功返回新 job
  - When: 用户点击任一复运行按钮
  - Then: 调用服务并重定向至新作业，jobsStore 记录来源（unit）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Export & Rerun › exports bundle then reruns and redirects to new job`
  - Given: Rerun 接口返回 202 和新 job id
  - When: 用户点击复运行
  - Then: 浏览器跳转至新详情页并在历史列表高亮新作业（e2e）
- `apps/web/e2e/optimizations-detail.spec.ts::Optimizations Detail — Export & Rerun › surfaces export and rerun errors without breaking UI`
  - Given: Rerun 接口返回 503
  - When: 用户点击复运行
  - Then: UI 显示统一错误信息且详情页可继续操作（e2e）
- `apps/web/src/app/api/v1/optimizations/__tests__/rerun.route.int.test.ts::clones param space and marks source job id`
  - Given: 原始作业存在 `paramSpace/earlyStopPolicy`
  - When: 调用 `/api/v1/optimizations/{id}/rerun`
  - Then: 新作业继承原参数并写入 `sourceJobId`（integration）
- `services/backtest/tests/test_orchestrator.py::test_get_job_snapshot_reports_source_job`
  - Given: Orchestrator 保存 `source_job_id`
  - When: 获取 job 快照
  - Then: 响应包含原作业引用供 UI 复运行（unit）
- `services/backtest/tests/test_main_internal_optimizations.py::test_history_endpoint_returns_sorted_jobs`
  - Given: 快速创建多条作业并完成其中一条
  - When: 调用 `/internal/optimizations?limit=1`
  - Then: 历史接口按更新时间排序并包含 `sourceJobId` 回链（integration）

### Critical Gaps
- 无缺口，所有验收条件均有覆盖。

### Test Design Recommendations
1. 在 nightly 管道保持 Playwright 场景运行，以监测导出/复运行接口的错误降级行为。
2. 增加一例 orchestrator 回归测试，模拟 Top-N 数组为空以验证 UI 空态提示与导出禁用逻辑（当前仅通过 E2E 间接覆盖）。

### Risk Assessment
- **Low**：核心流程在单元、集成与端到端层面均有验证；风险主要来自真实环境 Top-N 空态与大批量导出性能，可通过新增回归测试监控。
