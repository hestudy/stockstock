# Test Design: Story 1.4 — Status & Basic Result

Date: 2025-09-13 (UTC+8)
Owner: Quinn (Test Architect)
Related Story: `docs/stories/1.4.status-basic-result.md`
Related Gate: `docs/qa/gates/1.4-status-basic-result.yml`
Related Risk: `docs/qa/assessments/1.4-risk-20250913.md`

## 1. Scope & Objectives

- Ensure users can, on `(dashboard)/backtests/[id]`, see job status and basic results (收益/回撤/夏普) and equity curve, with summary visible within 2 seconds.
- Verify robust error/empty-state handling and accessible UI with `aria-live="polite"`.
- Validate export capabilities (CSV/JSON at least one) for summary and equity data.
- Provide E2E hooks to guarantee “Login → Detail → Summary visible within 2s”.

## 2. Requirements Traceability Matrix (AC → Tests)

- AC1 状态查询入口 → Integration: status API success/429/5xx/network; UI shows status/progress/retry.
- AC2 摘要首屏 2 秒 → Unit: summary renders with skeleton; Integration: virtual clock 2s; E2E: 2s visibility.
- AC3 净值曲线懒加载与导出 → Unit: chart render and props; Integration: lazy import SSR off; export function.
- AC4 结果导出 → Unit: `toCSV/toJSON` success/failure; Integration: error toast.
- AC5 错误与空态 → Unit: error mapping; Integration: failed/early-stopped/canceled branches; empty result polling.
- AC6 可达性（A11y） → A11y: semantic roles, aria-live polite, keyboard operability, alt text.
- AC7 覆盖度 → All layers: unit + integration + e2e include polling/2s/export/error/empty.

## 3. Test Strategy by Layer

### 3.1 Unit Tests (Frontend)

Target files:
- `apps/web/src/components/summary/SummaryCards.tsx`
- `apps/web/src/components/charts/EquityCurve.tsx`
- `apps/web/src/utils/export.ts`
- `apps/web/src/services/backtests.ts` (service helpers)

Key cases:
- SummaryCards
  - Renders metrics when provided; skeleton when loading; aria-live="polite"; `data-testid="summary-cards"` present.
  - Handles null/undefined metrics gracefully (empty-state text).
- EquityCurve
  - Renders with given series; tooltip and zoom handlers present; SSR disabled via dynamic import.
  - Large dataset prop does not freeze test runner (basic performance guard).
- Export utils
  - `toCSV` happy path with proper headers/order; error case returns Result with error.
  - `toJSON` happy path and error case; large dataset chunking (if implemented) smoke test.
- Services
  - `getBacktestStatus/getBacktestResult` build URL correctly; header construction; error normalization.

### 3.2 Integration Tests (Frontend)

Target:
- `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`

Approach:
- Use React Testing Library + jest/fakeTimers or vitest/fake timers.
- Mock network via msw.

Scenarios:
- Status polling → when status=running then later=completed, page fetches result afterwards, summary visible within 2 seconds (virtual clock).
- API branches: success, 429 with retry/backoff, 5xx with readable error; network error.
- Result not ready → shows placeholder; becomes available after polling tick → summary appears.
- Export button → triggers CSV/JSON generation; failure shows readable toast.
- Error mapping for failed/early-stopped/canceled → unified copy and actions to retry/return list.
- A11y: focus order, key activation of buttons, aria-label presence.

### 3.3 End-to-End (E2E)

Tooling: Playwright
File: `e2e/backtests-detail.spec.ts`
Hooks:
- Intercept `GET /api/v1/backtests/{id}/status` & `.../result`.
- Provide stable, fast response for result to assert 2-second requirement deterministically.

Scenarios:
- Login → open `(dashboard)/backtests/[id]` → ensure `data-testid="summary-cards"` visible within 2 seconds.
- Export flow basic: click export, file download triggered; failure path shows toast.
- Error/empty: simulate failed and canceled jobs → see mapped copy and actions.

## 4. Non-Functional Tests

- Performance: ensure first meaningful summary visible ≤ 2s under typical network and with mocked interfaces in tests. Perf budget: summary JS chunk size kept minimal; chart lazy-loaded and SSR off.
- Accessibility: screen reader announces updates in summary region; keyboard navigability for export and retry; chart alt text/empty description.
- Security: ensure no sensitive details in errors; auth errors mapped to readable messages.

## 5. Test Data & Mocking

- Shared types: `packages/shared/src/backtest.ts` defines `BacktestStatusResponse`, `ResultSummary`, `JobStatus` single source of truth.
- Mock payloads:
  - status-running: `{ status: "running", progress: 30, retries: 0 }`
  - status-completed: `{ status: "completed", progress: 100, retries: 0 }`
  - result-ready: `{ metrics: { return: 0.12, drawdown: 0.05, sharpe: 1.4 }, equity: [{ t: 1, v: 1.0}, ...] }`
  - errors: 429 with `retry-after`, 5xx with generic message; ApiError normalized shape.
- Large data: equity series with 50k points for performance smoke.

## 6. Tooling & Coverage

- Unit/Integration: Jest/Vitest + RTL + msw + fake timers.
- E2E: Playwright with network interception.
- Coverage targets (Story scope):
  - Lines: ≥ 80%
  - Branches: ≥ 70%
  - Critical paths (polling, 2s summary, export, error mapping): 100% of defined scenarios.

## 7. Entry/Exit Criteria

- Entry: Story `1.4` UI skeleton present; services stubs for status/result; shared types ready.
- Exit: All AC mapped tests pass locally and in CI; e2e 2-second assertion stable; accessibility checks pass; gate updated.

## 8. Monitoring & Observability

- FE web-vitals: track time-to-summary (custom metric) and export failure rate.
- BE: P95 latency and error rate for `/status` and `/result`.
- Alerts: threshold-based alerts for regressions; CI to block on coverage drop below target for story scope.

## 9. Risks Linkage and Mitigations

- PERF-001: enforce lazy chart, early summary render, timers-based tests; perf budget guard in CI if feasible.
- DATA-001: export schema single source, unit tests for schema; integration checks on empty/partial result.
- TECH-001: dynamic import with `ssr: false`; integration tests for flicker/rollback paths.
- SEC-001: ApiError mapping test; 401/403/404 simulated in integration.
- OPS-001: add monitoring tasks to PR checklist.
- PERF-002: large-data smoke tests; consider chunking in export utils.
- BUS-001: clear user messaging on slow paths; tests to assert presence of copy and retry.

## 10. Test Case IDs (Representative)

- U-SUM-001 Summary renders metrics
- U-SUM-002 Summary shows skeleton when loading
- U-EXP-001 CSV export success
- U-EXP-002 JSON export error shows message
- I-PAGE-001 Status polling to result
- I-PAGE-002 429 backoff and retry
- I-PAGE-003 5xx shows readable error
- I-PAGE-004 Result not ready → placeholder → becomes visible
- I-A11Y-001 Aria and keyboard operability
- E2E-001 Login→Detail→Summary within 2s
- E2E-002 Export happy path
- E2E-003 Failed/Stopped job copy

## 11. Work Items Mapping

- Ensure presence of files listed in story `File List (expected)` and add corresponding tests under `__tests__` directories and `e2e/`.

## 12. References

- Story: `docs/stories/1.4.status-basic-result.md`
- Risk: `docs/qa/assessments/1.4-risk-20250913.md`
- Gate: `docs/qa/gates/1.4-status-basic-result.yml`
- Architecture: `docs/architecture/` sections referenced in Story.
