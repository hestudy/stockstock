# Test Design: Story 2.3

Date: 2025-09-24 (UTC+8)
Designer: Quinn (Test Architect)

## Test Strategy Overview

- Total test scenarios: 11
- Unit tests: 3 (~27%)
- Integration tests: 6 (~55%)
- E2E tests: 2 (~18%)
- Priority distribution: P0=5, P1=6, P2=0, P3=0

## Test Scenarios by Acceptance Criteria

### AC1 Worker 执行与持久化

| ID             | Level       | Priority | Test                                                                 | Justification                                                              | Mitigates        |
| -------------- | ----------- | -------- | -------------------------------------------------------------------- | -------------------------------------------------------------------------- | ---------------- |
| 2.3-INT-001    | Integration | P0       | Worker 消费队列任务并回写 `optimization_tasks` 以及父作业 summary/topN | 验证 orchestrator-Worker-DB 交互链路的核心成功路径                          | DATA-001         |
| 2.3-INT-002    | Integration | P1       | Runner 抛出可重试异常时递增 `retries`、指数退避且 summary 不重复计数    | 确认失败重试路径不会产生僵尸任务或重复记账                                  | OPS-001          |

### AC2 阈值早停

| ID             | Level       | Priority | Test                                                                     | Justification                                                             | Mitigates                  |
| -------------- | ----------- | -------- | ------------------------------------------------------------------------ | ------------------------------------------------------------------------- | -------------------------- |
| 2.3-UNIT-001   | Unit        | P0       | `should_trigger_early_stop` 在 `mode=min|max` 与边界值下均正确判定        | 纯逻辑判断，确保阈值比较方向与容差正确                                     | TECH-001                    |
| 2.3-INT-003    | Integration | P0       | 模拟分数达到阈值后 Job 进入 `early-stopped`，停止派发且 summary/topN 冻结 | 确认早停控制面生效并避免额外任务调度                                       | TECH-001, PERF-001, BUS-001 |
| 2.3-INT-006    | Integration | P1       | Job 状态为 `early-stopped` 时 Worker 立即退避并不再请求新任务             | 防止阈值命中后 CPU 空转与多余指标写入                                      | PERF-001, OPS-001          |

### AC3 显式取消

| ID             | Level       | Priority | Test                                                                  | Justification                                                      | Mitigates         |
| -------------- | ----------- | -------- | --------------------------------------------------------------------- | ------------------------------------------------------------------ | ----------------- |
| 2.3-INT-004    | Integration | P0       | 调用取消接口后父作业与排队子任务标记为 `canceled`，运行中任务获得终止信号 | 验证 orchestrator 内部状态迁移与 Worker 协同，避免重复写入              | OPS-001, DATA-001 |
| 2.3-INT-005    | Integration | P0       | `/optimizations/[id]/cancel` 返回 202 并对跨租户访问返回 403/404        | 保证取消入口鉴权、审计与幂等响应                                         | SEC-001          |
| 2.3-INT-006    | Integration | P1       | Job 状态为 `canceled` 时 Worker 停止拉取并记录撤销指标                   | 防止已取消作业继续执行或消耗资源                                         | OPS-001, PERF-001 |

### AC4 运行指标记录

| ID             | Level | Priority | Test                                                                 | Justification                                   | Mitigates  |
| -------------- | ----- | -------- | -------------------------------------------------------------------- | ------------------------------------------------ | ---------- |
| 2.3-UNIT-002   | Unit  | P1       | Worker 成功路径记录 `queue_wait_seconds`、`job_exec_seconds` 指标与日志 | 通过 mock metric/log 通道验证核心指标被采集       | PERF-001   |
| 2.3-UNIT-003   | Unit  | P1       | Worker 失败路径上报 `job_retry_total` 且日志包含错误分类                | 确保重试与失败分类可观测，支撑告警与排障          | OPS-001    |

### AC5 测试覆盖要求

| ID             | Level       | Priority | Test                                                                                             | Justification                                                     | Mitigates       |
| -------------- | ----------- | -------- | ------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------- | --------------- |
| 2.3-E2E-001    | E2E         | P1       | Playwright：提交寻优 → Worker 命中早停 → UI 显示 `early-stopped`、Top-N 冻结、导出可用             | 覆盖用户最关注的早停可见性与结果质量                                 | BUS-001         |
| 2.3-E2E-002    | E2E         | P1       | Playwright：提交寻优 → 触发取消 → UI 显示 toast/状态 `canceled`，轮询停止且错误提示友好            | 覆盖取消主流程，验证前端服务层与 API 集成                             | OPS-001, SEC-001 |
| 2.3-INT-002    | Integration | P1       |（复用）失败重试路径计入覆盖矩阵，满足 AC5 对重试与指标的要求                                      | 确保 AC5 所需的失败/重试测试落地                                       | OPS-001         |

## Risk Coverage

| Risk ID  | Covered By                                        | Notes                                                |
| -------- | ------------------------------------------------- | ---------------------------------------------------- |
| TECH-001 | 2.3-UNIT-001, 2.3-INT-003                         | 阈值逻辑与触发流程均有防护                           |
| DATA-001 | 2.3-INT-001, 2.3-INT-004                          | 回写与 summary 同步路径被验证                         |
| PERF-001 | 2.3-INT-003, 2.3-INT-006, 2.3-UNIT-002            | 早停退避与指标采集防止资源空转                       |
| OPS-001  | 2.3-INT-002, 2.3-INT-004, 2.3-UNIT-003, 2.3-E2E-002 | 重试、取消、日志链路与用户反馈均覆盖                 |
| BUS-001  | 2.3-INT-003, 2.3-E2E-001                          | Top-N 冻结与用户提示维持结果可信度                   |
| SEC-001  | 2.3-INT-005, 2.3-E2E-002                          | 鉴权失败与前端提示路径均有自动化验证                 |

## Recommended Execution Order

1. 运行全部 P0 场景（2.3-INT-001, 2.3-UNIT-001, 2.3-INT-003, 2.3-INT-004, 2.3-INT-005）
2. 补充 P1 单元/集成测试（2.3-INT-002, 2.3-UNIT-002, 2.3-UNIT-003, 2.3-INT-006）
3. 执行 Playwright E2E 场景（2.3-E2E-001, 2.3-E2E-002）
4. 根据监控或缺陷回放需要扩展额外探索性测试

## Gate Summary

```yaml
test_design:
  scenarios_total: 11
  by_level:
    unit: 3
    integration: 6
    e2e: 2
  by_priority:
    p0: 5
    p1: 6
    p2: 0
    p3: 0
  coverage_gaps: []
```

<!-- Test design matrix: qa.qaLocation/assessments/2.3-test-design-20250924.md -->
