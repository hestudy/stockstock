# Risk Profile: Story 2.2

Date: 2025-09-23
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 5
- Critical Risks: 0
- High Risks: 2
- Risk Score: 68/100

Story 2.2 引入新的队列编排核心，技术与性能约束成为主要风险来源。高风险集中在并发闸门一致性与队列堆积吞吐；若不在上线前压实控制与监测，容易造成资源放大与服务卡顿。其余风险集中在数据聚合准确性、多租户隔离与运维可观测性，需要通过测试与监控增强加以缓释。

## Risk Matrix

| Risk ID  | Description                                   | Probability | Impact     | Score | Priority |
| -------- | --------------------------------------------- | ----------- | ---------- | ----- | -------- |
| TECH-301 | 并发闸门跨进程状态不一致导致超额激活          | 中 (2)      | 高 (3)     | 6     | 高       |
| PERF-210 | 队列堆积导致父作业进度停滞与节流失效          | 中 (2)      | 高 (3)     | 6     | 高       |
| DATA-140 | Summary/Top-N 聚合不同步造成状态接口返回错误   | 中 (2)      | 中 (2)     | 4     | 中       |
| SEC-130  | 状态查询缺少租户隔离导致跨租户数据暴露        | 低 (1)      | 高 (3)     | 3     | 低       |
| OPS-125  | 缺失重试/节流监测导致退避策略退化             | 中 (2)      | 中 (2)     | 4     | 中       |

## Critical Risks Requiring Immediate Attention

本次评估未识别到得分为 9 的关键风险；请优先在开发阶段关闭高风险项 TECH-301 与 PERF-210。

## Risk Distribution

### By Category

- Security: 1 风险（关键: 0）
- Performance: 1 风险（关键: 0）
- Data: 1 风险（关键: 0）
- Business: 0 风险
- Operational: 1 风险（关键: 0）
- Technical: 1 风险（关键: 0）

### By Component

- Frontend: 0 风险
- Backend: 4 风险
- Database: 1 风险
- Infrastructure/Monitoring: 1 风险

## Detailed Risk Register

| Risk ID  | Category | Probability | Impact | Score | Priority | Description | Mitigation Strategy | Testing Focus | Owner |
| -------- | -------- | ----------- | ------ | ----- | -------- | ----------- | ------------------- | ------------- | ----- |
| TECH-301 | 技术     | 中 (2)      | 高 (3) | 6     | 高       | 并发闸门依赖 Redis/DB 计数，若缺少原子操作或幂等处理，多个 Orchestrator 实例会同时激活超出 `concurrencyLimit` 的子任务，造成资源放大与竞态失序。 | 采用 Lua/事务保证入队与计数原子性；对活跃/排队清单引入版本化或分布式锁；上线前执行并发冲击演练并启用自愈限流。 | 编写并发闸门单测 + 竞争态集成测试；模拟多实例并发压测校验上限。 | Backend |
| PERF-210 | 性能     | 中 (2)      | 高 (3) | 6     | 高       | 重试与节流策略若配置不当，会导致大量任务长期留在排队状态，父作业 summary 不前进，用户感知停滞并拖垮 worker 吞吐。 | 为排队/退避配置上限与降级策略；增加队列深度、等待时间和退避失败比率告警；按 owner 设定公平调度或优先级。 | 构建负载/长尾场景集成测试；注入失败率验证重试退避；监控链路 E2E 演练。 | Backend |
| DATA-140 | 数据     | 中 (2)      | 中 (2) | 4     | 中       | Summary 与 Top-N 依赖多源更新，若更新顺序或事务控制不足，可能返回过期或重复条目，影响用户决策。 | 使用事务或变更序列保障 summary 与 Top-N 同步；对 Top-N 使用幂等更新；在 API 层加入数据一致性校验与缓存失效策略。 | 单测覆盖 summary/Top-N 更新；API 集成测试校验对外字段一致性；回放真实流量验证排序稳定。 | Backend |
| SEC-130  | 安全     | 低 (1)      | 高 (3) | 3     | 低       | 若 GET status 缺少租户检查或队列键命名不安全，可能将某租户作业状态暴露给其他租户。 | 统一通过 ownerId/租户标签过滤；在状态接口强制鉴权与多租户单元测试；为关键路径添加安全审计日志。 | 租户隔离单测；API 集成测试覆盖跨租户访问；安全扫描验证路由保护。 | Backend |
| OPS-125  | 运维     | 中 (2)      | 中 (2) | 4     | 中       | 缺少针对重试、节流、排队深度的指标与报警，退避策略失效时无法及时发现，导致 SLA 漂移。 | 定义 retry/backoff 成功率、排队深度、节流命中率指标；在 Observability 层建立告警阈值；对异常流量提供快速排查 runbook。 | 指标/告警单测附配置校验；演练告警触发流程；整合 E2E 日志验证字段齐全。 | SRE |

## Risk-Based Testing Strategy

### Priority 1: Critical Risk Tests

- 针对 TECH-301：构建多实例并发压力测试，验证 Redis/数据库操作的原子性及限流生效；辅助以破坏性测试（kill/restart orchestrator 实例）验证状态恢复。
- 针对 PERF-210：执行长时间高负载队列回放，注入失败率，确认退避窗口与排队深度在阈值内，并验证摘要进度仍更新。

### Priority 2: High Risk Tests

- 针对 DATA-140 与 OPS-125：补齐 summary/Top-N 组合单测与 API 集成校验，模拟异常更新顺序；对监控指标与告警配置进行单元/集成验证。

### Priority 3: Medium/Low Risk Tests

- 针对 SEC-130：扩展租户隔离测试矩阵，覆盖跨租户 token、匿名访问等路径；纳入自动化安全扫描。

## Risk Acceptance Criteria

### Must Fix Before Production

- 解决所有得分 ≥6 的风险（TECH-301、PERF-210），确保闸门与队列受控。
- 对 DATA-140 完成成功路径与异常路径的测试覆盖，确保用户暴露数据准确。

### Can Deploy with Mitigation

- SEC-130 可在具备强制鉴权、审计日志与隔离测试通过后接受残余风险。
- OPS-125 可在监控指标上线并通过预演后接受，后续继续优化。

### Accepted Risks

- 暂无正式接受的剩余风险，若上线前无法完全关闭，应记录在变更流程并获得 owner 签签确认。

## Monitoring Requirements

- 追踪 `active/queued/throttled` 任务量、排队等待时长、退避命中次数；为突增建立即时告警。
- 对限流与并发闸门失败率设置 SLO，并在日志中关联父作业与 ownerId，便于排查。
- 对 `/status` 接口返回耗时、错误率以及 topN 变化频率建立仪表盘，验证数据可靠性。

## Risk Review Triggers

- 引入新的任务分发策略、worker 横向扩容或跨区域部署。
- 调整退避/重试参数或新增错误分类。
- 多租户模型、鉴权策略或 API 合同发生变更。
- 发现队列堆积、限流失效或 topN 数据异常趋势。
