# NFR Assessment — Story 2.3 Workers & Early Stop

**Date:** 2025-09-25  
**Reviewed By:** Quinn (QA)  
**Scope:** security, performance, reliability, maintainability

## Summary

| NFR | Status | Notes |
| --- | --- | --- |
| Security | PASS | 取消流程严格绑定 owner/secret，API 层统一走 `resolveOwnerId` 并有越权/缺失密钥用例覆盖。 |
| Performance | CONCERNS | Worker 路径记录并校验 `queue_wait_seconds`/`job_exec_seconds`，但 orchestrator 早停/取消分支缺少指标验证，无法证明 Queue/Compute SLO 端到端可观测。 |
| Reliability | CONCERNS | 早停/取消状态机与重试逻辑经单测、集成、E2E 验证，但缺失 orchestrator 观测指标与日志断言，故障诊断与告警可信度不足。 |
| Maintainability | PASS | Python/Next.js 层均补齐单测、集成与 E2E；共享类型同步，故事文件记录清晰的完成说明。 |

**Quality Score:** 80

## Evidence

### Security — PASS
- FastAPI 内网接口验证共享密钥与 owner 头：`services/backtest/tests/test_main_internal_optimizations.py::test_cancel_endpoint_marks_job_and_returns_reason`、`::test_rejects_on_owner_mismatch`、`::test_status_requires_owner_header`。
- Next.js API 取消路由统一调用 `resolveOwnerId()` 并在测试中覆盖非法 ID 与取消结果：`apps/web/src/app/api/v1/optimizations/__tests__/cancel.route.int.test.ts`。
- UI 层 Playwright 仅通过模拟认证 cookie，未暴露额外权限入口。

### Performance — CONCERNS
- Worker 层指标通过单测校验（成功、失败、重试、开关关闭）：`services/backtest/tests/test_worker.py`；Queue SLO 用例验证 `queue_wait_seconds` P95 在 120s 内。
- 架构要求队列等待 P95 ≤ 120s、平均 ≤ 30s（`docs/architecture/10-security-and-performance.md`），并强调早停触发时应记录停机原因与指标。
- orchestration 侧尚未对 `emit_metric`/结构化日志进行断言，也缺少集成/E2E 验证，早停/取消路径是否输出指标未知 → 无法确认可观测性满足性能 SLO。

### Reliability — CONCERNS
- 状态机/锁定：`services/backtest/tests/test_orchestrator.py::test_early_stop_triggers_job_lock`、`::test_cancel_job_updates_tasks_and_summary`，并发/重试/持久化均有覆盖。
- E2E（`apps/web/e2e/optimizations-detail.spec.ts`）验证提前停止、取消后的 UI 终态与禁用逻辑。
- 观测缺口同样影响可靠性：无法确认停机原因/告警事件实际落地，事故排查依赖度降低。

### Maintainability — PASS
- 多层测试（金字塔结构）覆盖成功/失败/重试/取消流程，便于回归；`docs/stories/2.3.workers-early-stop.md` 中 Dev Notes/Completion Notes 对变更和测试命令完整记录。
- 代码按架构约束分布（Python services / Next.js API / shared types），未发现违背 coding standards 的实现。

## Recommendations

1. **补齐 orchestrator 指标/日志测试**：在 `test_orchestrator.py` 中打桩 `emit_metric`/`observability.write`，断言早停/取消时输出的指标名称、标签与停机原因日志。
2. **集成验证**：为 FastAPI/Next.js 编排层补充集成测试，确认 `/cancel` `/status` 在早停或取消后记录结构化日志条目，确保可观测链路贯通。
3. **可观测降级校验**：扩展 Playwright，对指标接口返回异常或为空时的 UI 提示进行验证，避免监控缺口被前端掩盖。

## Risks

- **监控盲区**：缺少 orchestrator 指标断言意味着 Queue/Compute SLO 警报可能在生产中缺失，影响性能与可靠性目标。
- **事故诊断延迟**：无结构化日志验证时，早停/取消原因若未正确记录，回溯难度加大。

## Next Steps

- 实施建议 1 和 2，将缺口修复纳入当前故事或下一轮 hardening。
- 回归运行 `python -m pytest services/backtest/tests/test_worker.py test_orchestrator.py test_queue_slo.py` 与前端 Vitest/Playwright，确认新增校验不会破坏现有流程。
