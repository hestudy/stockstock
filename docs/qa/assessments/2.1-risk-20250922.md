# Risk Profile: Story 2.1 — Opt Grid Submit

Date: 2025-09-22
Reviewer: Quinn (Test Architect)

## Executive Summary

- Total Risks Identified: 6
- Critical Risks: 1
- High Risks: 3
- Risk Score: 40/100

关键信息：核心威胁在于“记录但未真正约束”的并发控制，若 Orchestrator 对 `concurrencyLimit` 与父作业队列缺乏反压，将在首次上线时造成资源拥塞。其次需要确保参数空间上限校验准确、跨租户鉴权闭环、以及避免在组合展开与持久化时引入性能与数据质量问题。

## Critical Risks Requiring Immediate Attention

### 1. OPS-201: 并发限制未在 Orchestrator 生效导致资源放大

- Score: 9 (Critical)
- Probability: High (3) — Next.js API 与 Python Orchestrator 首次对接 `concurrencyLimit`/`earlyStopPolicy`，占位实现极易遗漏该字段，且暂无指标佐证
- Impact: High (3) — 若默认无限制并发，将快速压垮计算节点与任务队列，阻塞其它回测/优化作业
- Mitigation:
  - 建立 API→Orchestrator 集成测试，断言并发限制写入并被调度层消费
  - 在 Orchestrator 中增加并发计数+排队阈值的保护逻辑（即使后续故事才能完整实现，也需最小兜底）
  - 配置并发/队列长度指标与告警，首轮上线前做演练
- Testing Focus:
  - Python 层并发闸门单测与集成测试；模拟超过限制的提交并验证被延迟/拒绝

## Risk Distribution

### By Category

- Operational: 1 risks (1 critical)
- Technical: 1 risks (0 critical)
- Security: 1 risks (0 critical)
- Performance: 1 risks (0 critical)
- Data: 1 risks (0 critical)
- Business: 1 risks (0 critical)

### By Component

- Next.js API 层: 3 risks
- Python Orchestrator: 3 risks
- 数据持久化/模型: 2 risks
- 用户体验/业务流程: 1 risks

## Detailed Risk Register

| Risk ID  | Category | Title                                       | Probability | Impact    | Score | Priority |
|----------|----------|---------------------------------------------|-------------|-----------|-------|----------|
| OPS-201  | OPS      | 并发限制未在 Orchestrator 生效导致资源放大 | High (3)    | High (3)  | 9     | Critical |
| TECH-201 | TECH     | 参数组合上限校验逻辑不正确                  | Medium (2)  | High (3)  | 6     | High     |
| SEC-201  | SEC      | 缺少 `versionId` 与租户归属校验             | Medium (2)  | High (3)  | 6     | High     |
| PERF-201 | PERF     | 参数空间展开占用过多 CPU/内存               | Medium (2)  | High (3)  | 6     | High     |
| DATA-201 | DATA     | `paramSpace` 持久化未做深度校验，数据脏化   | Medium (2)  | Medium (2)| 4     | Medium   |
| BUS-201  | BUS      | 202 响应后缺少状态可见性导致体验崩坏        | Medium (2)  | Medium (2)| 4     | Medium   |

风险按分数降序排列；概率×影响 = 风险分数。

## Risk-Based Testing Strategy

### Priority 1: Critical / High Risk Tests

- OPS-201：
  - 集成测试覆盖 API→Orchestrator 传递并发限制；模拟超限请求，验证调度层阻塞或排队
  - 压力测试验证并发计数指标与告警阈值是否触发
- TECH-201：
  - 单测/属性测试覆盖离散、多值、嵌套范围的组合上限计算；边界用例（刚好等于上限、超出上限）
  - 错误路径集成测试验证 `E.PARAM_INVALID` 与诊断载荷 `{ limit, estimate }`
- SEC-201：
  - API 集成测试：提交不属于当前用户的 `versionId` 时返回 403/401
  - 验证 `ownerId` 从 JWT 与数据库校验链路；构造多租户场景
- PERF-201：
  - 预留大参数空间输入（例如 10×10×10）执行单元测试/集成测试，确保仅做估算而非全量展开
  - 监控 Python 端内存占用，必要时改用惰性生成或批量入库

### Priority 2: Medium Risk Tests

- DATA-201：
  - 使用 JSON Schema/自定义校验确保 `paramSpace` 字段类型、取值范围与体积（size）受控
  - 数据迁移/回放测试验证写入记录的字段完整性
- BUS-201：
  - E2E：提交作业后在 UI/查询端点中确认父作业状态可读、失败路径有清晰反馈
  - 验证 202 响应附带的 `id` 能在后续状态查询接口查到

## Risk Acceptance Criteria

- Must Fix Before Production
  - OPS-201 及所有安全/资源相关的 High（TECH-201、SEC-201、PERF-201）需上线前闭环
- Can Deploy with Mitigation
  - Medium 风险需提供补偿控制（如字段校验、监控面板、回滚预案）并在验收记录
- Accepted Risks
  - 若需暂缓某项 Medium 风险，必须记录责任人、缓解时限和监控指标

## Monitoring Requirements

- 并发与排队：Orchestrator 暴露 `active_jobs`, `queued_jobs`, `throttled_requests` 指标并设阈值告警
- 组合估算：API 路由记录 `paramSpace_estimate` 直方图，用于观测常见输入规模
- 安全审计：记录 `ownerId`、`versionId` 及校验结果，支持审计日志
- 数据质量：数据库层对 `optimization_jobs` 表新增约束/检查，异常条目触发报警
- 体验可见性：API 202 响应率 vs 后续状态查询命中率，发现“已提交但查不到”时报警

## Risk Review Triggers

- 上线并发调度功能（Story 2.2/2.3）或变更 Orchestrator 调度算法
- 引入新的参数类型或参数空间描述格式
- 增加新的租户隔离规则、权限模型或版本管理方式
- 发现新的性能瓶颈或资源告警
- 数据模型或数据库索引发生重大调整

---

# Gate YAML Snippet (risk_summary)

```yaml
risk_summary:
  totals:
    critical: 1
    high: 3
    medium: 2
    low: 0
  highest:
    id: OPS-201
    score: 9
    title: "并发限制未在 Orchestrator 生效导致资源放大"
  recommendations:
    must_fix:
      - "实现并验证 Orchestrator 对 concurrencyLimit 的硬性约束，并为超限路径编写测试"
      - "完善参数组合估算函数的边界用例，确保 E.PARAM_INVALID 返回一致"
      - "在提交链路中校验 versionId 的租户归属，阻止跨租户滥用"
    monitor:
      - "建立并发/队列长度指标仪表盘并配置阈值告警"
      - "跟踪 paramSpace 估算值与数据库记录体积，及时调整上限"
```

Hook line for review task:

```
Risk profile: docs/qa/assessments/2.1-risk-20250922.md
```
