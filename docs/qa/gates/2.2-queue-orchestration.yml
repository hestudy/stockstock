# <!-- Powered by BMAD™ Core -->
schema: 1
story: "2.2"
story_title: "Queue Orchestration"
gate: "FAIL" # PASS|CONCERNS|FAIL|WAIVED
status_reason: "Python orchestrator 在并发饱和时将所有排队任务提前解除 throttle，`summary.throttled`/`diagnostics.queueDepth` 被错误清零，AC2/AC4 要求的排队可观测性失效。"
reviewer: "Quinn (Test Architect)"
updated: "2025-09-24T08:31:18Z"

waiver: { active: false }

top_issues:
  - id: "QA-2.2-QUEUE-DEPTH"
    title: "并发饱和时状态接口的 throttled/queueDepth 丢失排队信息"
    severity: high
    evidence:
      - "services/backtest/app/orchestrator.py:503"
      - "docs/stories/2.2.queue-orchestration.md#QA Results"
    recommendation: "修正 `_activate_slots` 的容量计算，确保仅释放所需任务并维持 throttled 计数，新增单测覆盖排队指标在并发饱和场景下的正确性"

trace:
  totals:
    requirements: 5
    full: 3
    partial: 1
    none: 1
  planning_ref: "docs/qa/assessments/2.2-test-design-20250923.md"
  uncovered:
    - "AC2 并发闸门与排队限制：队列深度指标失真"
    - "AC4 进度聚合与 Top-N：状态接口无法正确反馈排队信息"
  notes: "See docs/qa/assessments/2.2-trace-20250923.md"

nfr_validation:
  security:
    status: PASS
    notes: "API 继续校验租户与内部密钥，集成测试覆盖未授权/越权路径。"
  performance:
    status: CONCERNS
    notes: "Queue SLO pytest 通过，但需在修复 throttled 统计后回归指标，现阶段数据可能被稀释。"
  reliability:
    status: FAIL
    notes: "核心 orchestrator 在并发饱和时丢失队列深度观测，依赖该诊断信息的告警与 UI 全部失效。"
  maintainability:
    status: PASS
    notes: "Playwright 拦截表达式修复，端到端测试命中 stub 并验证 UI。"

evidence:
  tests_reviewed: 12
  risks_identified: 1
  trace:
    ac_covered: [1, 3, 5]
    ac_gaps: [2, 4]
  story_file: docs/stories/2.2.queue-orchestration.md
  traceability: docs/qa/assessments/2.2-trace-20250923.md
  nfr_assessment: docs/qa/assessments/2.2-nfr-20250923.md
  test_design: docs/qa/assessments/2.2-test-design-20250923.md

quality_score: 60
expires: "2025-10-08T08:31:18Z"

recommendations:
  immediate:
    - action: "修复 `_activate_slots` 逻辑并补充单测验证 throttled/queueDepth 在并发饱和场景仍保持正确"
      refs:
        - "services/backtest/app/orchestrator.py"
        - "services/backtest/tests/test_orchestrator.py"
  future:
    - action: "清理 orchestrator/worker datetime.utcnow 弃用告警并统一时间处理"
      refs:
        - "services/backtest/app/orchestrator.py"
        - "services/backtest/app/worker.py"
