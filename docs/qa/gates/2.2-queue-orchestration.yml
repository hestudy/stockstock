# <!-- Powered by BMAD™ Core -->
schema: 1
story: "2.2"
story_title: "Queue Orchestration"
gate: "FAIL" # PASS|CONCERNS|FAIL|WAIVED
status_reason: "Queue/Compute SLO pytest 因 orchestrator.create_optimization_job 缺少 totalTasks 字段而抛错，性能基线无法验证；需先修复再回归 Gate。"
reviewer: "Quinn (Test Architect)"
updated: "2025-09-25T02:00:00Z"

waiver: { active: false }

top_issues:
  - id: "BUG-totalTasks"
    title: "Queue SLO pytest 因 orchestrator 缺少 totalTasks 字段而失败"
    severity: "critical"
    action: "补齐 create_optimization_job 返回的 totalTasks 或调整 test_queue_slo 读取 job 摘要，恢复 Queue/Compute SLO 校验。"
    suggested_owner: "dev"

trace:
  totals:
    requirements: 5
    full: 4
    partial: 0
    none: 1
  planning_ref: "docs/qa/assessments/2.2-test-design-20250923.md"
  uncovered:
    - ac: "AC5"
      reason: "Queue SLO pytest 未能运行，P95≤120s 指标未验证"
  notes: "See docs/qa/assessments/2.2-trace-20250923.md"

nfr_validation:
  security:
    status: PASS
    notes: "API 继续校验租户与内部密钥，集成测试覆盖未授权/越权路径。"
  performance:
    status: FAIL
    notes: "Queue SLO pytest 崩溃，队列等待 P95 ≤120s 目标未验证，需修复后再观察指标。"
  reliability:
    status: PASS
    notes: "并发闸门、重试、Top-N 聚合与线程安全场景均有单元/集成测试覆盖。"
  maintainability:
    status: CONCERNS
    notes: "测试与实现契约未对齐（totalTasks 缺失），建议统一接口避免回归。"

evidence:
  tests_reviewed: 9
  risks_identified: 1
  trace:
    ac_covered: [1, 2, 3, 4]
    ac_gaps: [5]
  story_file: docs/stories/2.2.queue-orchestration.md
  traceability: docs/qa/assessments/2.2-trace-20250923.md
  nfr_assessment: docs/qa/assessments/2.2-nfr-20250923.md
  test_design: docs/qa/assessments/2.2-test-design-20250923.md

quality_score: 80
expires: "2025-10-09T02:00:00Z"

recommendations:
  immediate:
    - action: "修复 orchestrator totalTasks 字段缺失或调整 test_queue_slo 读取数据来源"
      refs:
        - "services/backtest/app/orchestrator.py"
        - "services/backtest/tests/test_queue_slo.py"
  future:
    - action: "为 queue_wait_seconds 指标配置报警阈值脚本"
      refs:
        - "services/backtest/app/observability.py"
