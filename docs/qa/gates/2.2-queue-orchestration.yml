# <!-- Powered by BMAD™ Core -->
schema: 1
story: "2.2"
story_title: "Queue Orchestration"
gate: "CONCERNS" # PASS|CONCERNS|FAIL|WAIVED
status_reason: "Next.js 编排器回退实现忽略 early-stop 最小化排序，测试/本地默认配置下 Top-N 顺序被反转，需补齐与 Python orchestrator 一致的排序逻辑及覆盖。"
reviewer: "Quinn (Test Architect)"
updated: "2025-09-27T05:30:00Z"

waiver: { active: false }

top_issues:
  - id: "QA-2.2-TOPN-FALLBACK"
    title: "本地 orchestrator 回退忽略 min 模式导致 Top-N 顺序错误"
    severity: high
    evidence:
      - "apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:314"
      - "docs/stories/2.2.queue-orchestration.md#QA Results"
    recommendation: "在回退实现中按 earlyStopPolicy.mode 排序并补充最小化场景测试"

trace:
  totals:
    requirements: 5
    full: 5
    partial: 0
    none: 0
  planning_ref: "docs/qa/assessments/2.2-test-design-20250923.md"
  uncovered: []
  notes: "See docs/qa/assessments/2.2-trace-20250923.md"

nfr_validation:
  security:
    status: PASS
    notes: "API 继续校验租户与内部密钥，集成测试覆盖未授权/越权路径。"
  performance:
    status: PASS
    notes: "Queue SLO pytest 已恢复并通过（仍有 datetime.utcnow 弃用警告需后续治理）。"
  reliability:
    status: CONCERNS
    notes: "Next.js 回退路径未根据 early-stop 最小化排序 Top-N，dev/test 默认配置可能返回错误排名。"
  maintainability:
    status: PASS
    notes: "Playwright 拦截表达式修复，端到端测试命中 stub 并验证 UI。"

evidence:
  tests_reviewed: 11
  risks_identified: 2
  trace:
    ac_covered: [1, 2, 3, 4, 5]
    ac_gaps: []
  story_file: docs/stories/2.2.queue-orchestration.md
  traceability: docs/qa/assessments/2.2-trace-20250923.md
  nfr_assessment: docs/qa/assessments/2.2-nfr-20250923.md
  test_design: docs/qa/assessments/2.2-test-design-20250923.md

quality_score: 82
expires: "2025-10-05T05:30:00Z"

recommendations:
  immediate: []
  future:
    - action: "清理 orchestrator/worker datetime.utcnow 弃用告警并统一时间处理"
      refs:
        - "services/backtest/app/orchestrator.py"
        - "services/backtest/app/worker.py"
