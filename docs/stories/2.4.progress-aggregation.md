# Story 2.4: Progress & Aggregation

## Status

Draft

## Story

**As a** 参数寻优体验负责人,
**I want** 在寻优详情页提供总进度、Top-N 汇总以及导出与复运行操作,
**so that** 用户可以实时掌握寻优状态并快速复用表现最佳的参数组合。

## Acceptance Criteria

1. 总进度可视化：寻优详情页展示来自 `GET /api/v1/optimizations/{id}/status` 的 `summary.total`、`summary.finished`、父作业 `status` 与进度条，并遵循服务层的 SWR/Query 轮询策略保持刷新；当父作业进入 `early-stopped` 或 `canceled` 时需呈现停机/取消提示且 `summary` 数据保持终值。  
   [Source: architecture/05-api-spec.md#/optimizations/{id}/status]  
   [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]  
   [Source: front-end-spec.md#job-status]
2. Top-N 动态榜单：Top-N 区域基于 `summary.topN` 数组实时排序展示 `taskId` 与 `score`，并根据 `earlyStopPolicy.mode` 在 UI 上提示排序方向；无数据时显示空态，占用停机/取消后保持最终榜单可浏览。  
   [Source: architecture/04-data-models.md#optimizationjob父]  
   [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]  
   [Source: front-end-spec.md#flow-c-grid-optimization]
3. 汇总导出：提供导出操作，复用 `ResultSummary.artifacts` 引用生成可下载的 Top-N 聚合包（包含参数、核心指标与结果引用），失败时返回统一 `ApiError` 并记录结构化日志；导出流程不得重复触发完整回测。  
   [Source: architecture/04-data-models.md#resultsummary]  
   [Source: architecture/02-high-level-architecture.md#high-level-architecture]  
   [Source: architecture/12-coding-standards.md#critical-fullstack-rules]
4. 复运行入口：允许用户从 Top-N 列表或详情页复运行选中组合，调用 `POST /api/v1/optimizations` 预填原始 `paramSpace` 与 `earlyStopPolicy`，将新作业写入历史列表并链接回源作业；未鉴权或参数缺失时按统一错误提示处理。  
   [Source: architecture/05-api-spec.md#/optimizations]  
   [Source: docs/prd/requirements.md#functional-fr]  
   [Source: front-end-spec.md#flow-d-re-run-from-history]

## Dependencies & Flow Fit

- 前置：`Story 2.3 Workers & Early Stop` 已实现任务执行回写、早停/取消与指标输出，本故事在其稳定的 `summary` 与监控基线上构建可视化与导出能力。  
  [Source: docs/stories/2.3.workers-early-stop.md#Acceptance Criteria]
- 后续：`Story 2.5 Failures & Quotas` 将利用本故事导出的聚合结果补充失败分类与配额提示，因此需确保 Top-N 结果与导出结构完整。  
  [Source: docs/prd/epic-details.md#Epic 2: Grid Optimization & Queue Orchestration]
- 业务契合：满足 PRD 关于历史复运行与结果导出的功能要求，为 Epic 2 向历史管理与计费占位扩展铺路。  
  [Source: docs/prd/requirements.md#functional-fr]

## Dev Notes

### Previous Story Insights

- 2.3 已验证 Worker 与 Orchestrator 写回 `summary.total/finished/topN` 并在早停或取消时锁定结果，当前故事应直接消费这些字段而非重复聚合。  
  [Source: docs/stories/2.3.workers-early-stop.md#Acceptance Criteria]
- 2.3 输出 `queue_wait_seconds`、`job_exec_seconds` 等指标，为进度面板与导出操作提供监控钩子；需沿用该指标体系暴露导出时延与错误事件。  
  [Source: docs/stories/2.3.workers-early-stop.md#Dev Notes]

### Data Models

- `OptimizationJob.summary` 包含 `total`、`finished` 与 `topN[{ taskId, score }]`，用于计算整体进度与榜单显示。  
  [Source: architecture/04-data-models.md#optimizationjob父]
- `OptimizationTask` 记录 `score`、`resultSummaryId` 与当前 `status`，榜单行需联动这些字段呈现指标与结果链接。  
  [Source: architecture/04-data-models.md#optimizationtask子]
- `ResultSummary` 提供 `metrics`、`artifacts` 与结果引用，是导出时打包指标及跳转链接的唯一来源。  
  [Source: architecture/04-data-models.md#resultsummary]

### API Specifications

- `GET /api/v1/optimizations/{id}/status` 返回 `OptimizationStatusResponse`，包含 `status` 与 `summary`，前端需通过服务层调用该接口完成轮询。  
  [Source: architecture/05-api-spec.md#/optimizations/{id}/status]
- `POST /api/v1/optimizations` 支持提交新寻优作业，复运行入口应复用该端点并复制原作业的 `paramSpace`/`earlyStopPolicy`。  
  [Source: architecture/05-api-spec.md#/optimizations]
- `JobStatus` 枚举（`queued|running|succeeded|failed|early-stopped|canceled`）需在 UI 中完整映射提示文案与颜色。  
  [Source: architecture/05-api-spec.md#optimizationstatusresponse]

### Component Specifications

- Grid Optimization 详情页需包含进度面板、Top-N 榜单、导出按钮与早停/取消操作区。  
  [Source: front-end-spec.md#flow-c-grid-optimization]
- 历史与复运行流程要求从列表项快速复运行或带入参数打开编辑器，需在详情页保持一致的操作入口。  
  [Source: front-end-spec.md#jobs-history]  
  [Source: front-end-spec.md#flow-d-re-run-from-history]
- 前端服务层通过 `apps/web/src/services/` 封装 API 调用，支持 SWR/Query 缓存策略与错误处理。  
  [Source: architecture/07-frontend-architecture.md#frontend-services-layer]

### File Locations

- UI：`apps/web/src/app/(dashboard)/optimizations/[id]/page.tsx` 详情页与 `optimizations/page.tsx` 提交流程需扩展进度、Top-N 与操作入口。  
  [Source: architecture/07-frontend-architecture.md#routing-architecture]
- 服务层：`apps/web/src/services/optimizations.ts` 提供状态轮询、导出与复运行调用封装。  
  [Source: architecture/07-frontend-architecture.md#frontend-services-layer]
- API：`apps/web/src/app/api/v1/optimizations/[id]/status/route.ts`、`.../route.ts` 与新增导出/复运行辅助端点负责对接 orchestrator/仓储。  
  [Source: architecture/08-backend-architecture.md#service-architecture]
- Python Orchestrator：`services/backtest/app/orchestrator.py` 维护 summary、Top-N 与导出的数据聚合逻辑；必要时扩展导出辅助模块。  
  [Source: architecture/08-backend-architecture.md#service-architecture]
- 共享类型：`packages/shared/src/optimization.ts` 需同步 `OptimizationStatusResponse`、导出 payload 与复运行请求结构，保持跨栈一致。  
  [Source: architecture/12-coding-standards.md#critical-fullstack-rules]

### Testing Requirements

- 单元：Python orchestrator 聚合/导出函数、TS 服务层排序/空态逻辑、错误提示映射。  
  [Source: architecture/11-testing-strategy.md#testing-pyramid]
- 集成：`GET /optimizations/{id}/status`、导出端点与 `POST /optimizations` 复运行路径需在 API 测试中覆盖成功、鉴权失败、无效参数与导出异常分支。  
  [Source: architecture/11-testing-strategy.md#test-organization]
- 前端：Vitest 覆盖进度面板轮询、Top-N 排序方向、复运行按钮交互与错误降级提示。  
  [Source: front-end-spec.md#flow-c-grid-optimization]
- E2E：Playwright 场景验证提交寻优 → 详情页实时刷新 → 导出成功与失败回退 → 复运行成功写入历史。  
  [Source: architecture/11-testing-strategy.md#testing-pyramid]

### Technical Constraints

- 进度与导出操作需满足队列时延与性能目标（平均排队 ≤30s、P95 ≤2min），避免阻塞主线程或重复昂贵计算。  
  [Source: architecture/10-security-and-performance.md#performance-optimization]
- 前端与 API 遵循统一服务层与结构化错误格式，禁止直接 `fetch` 或散落的 `process.env` 访问。  
  [Source: architecture/12-coding-standards.md#critical-fullstack-rules]
- 导出与进度 API 应输出结构化日志与指标，以便监控导出时延、失败率与用户操作。  
  [Source: architecture/14-monitoring-and-observability.md#监控栈]

## Tasks / Subtasks

- [ ] 前端进度与 Top-N 展示（AC: 1, 2）  
  - [ ] 更新 `optimizations/[id]/page.tsx` 在进度面板展示 `summary`、状态徽标与停机/取消提示，并通过 SWR/Query 轮询调用服务层。  
        [Source: architecture/07-frontend-architecture.md#routing-architecture]  
        [Source: front-end-spec.md#job-status]
  - [ ] 调整 Top-N 表格组件，依据 `earlyStopPolicy.mode` 切换升/降序并加入空态与骨架屏。  
        [Source: architecture/04-data-models.md#optimizationjob父]  
        [Source: front-end-spec.md#flow-c-grid-optimization]
  - [ ] 在 UI 中显式展示队列节流/早停诊断信息，复用 2.3 产出的指标提示组件。  
        [Source: docs/stories/2.3.workers-early-stop.md#Dev Notes]

- [ ] 后端聚合与导出接口（AC: 1, 3）  
  - [ ] 扩展 orchestrator 聚合逻辑，确保 summary 与 Top-N 在停机/取消后保持终值且包含导出所需的 `resultSummaryId`。  
        [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]
  - [ ] 新增导出 API（Next.js Route + 内部 FastAPI 调用），生成包含 Top-N 参数与 `ResultSummary.artifacts` 链接的压缩包/流式响应，失败时返回统一 `ApiError`。  
        [Source: architecture/08-backend-architecture.md#service-architecture]  
        [Source: architecture/04-data-models.md#resultsummary]  
        [Source: architecture/12-coding-standards.md#critical-fullstack-rules]
  - [ ] 更新 `packages/shared/src/optimization.ts` 与 orchestrator 客户端，定义导出与复运行请求/响应类型。  
        [Source: architecture/12-coding-standards.md#critical-fullstack-rules]

- [ ] 复运行操作与历史写入（AC: 4）  
  - [ ] 在 Top-N 行与详情页操作区新增“Re-run”按钮，调用服务层复用原 `paramSpace` 与 `earlyStopPolicy` 发起新作业。  
        [Source: front-end-spec.md#flow-d-re-run-from-history]
  - [ ] API 层将复运行请求写入 `optimization_jobs` 并附上 `sourceJobId`，以便历史列表追踪。  
        [Source: architecture/05-api-spec.md#/optimizations]  
        [Source: architecture/08-backend-architecture.md#database-architecture]
  - [ ] 历史页面/服务刷新逻辑更新，以新作业返回后自动跳转详情或显示操作反馈。  
        [Source: front-end-spec.md#jobs-history]

- [ ] 测试与可观测性（AC: 1-4）  
  - [ ] 编写 Pytest 覆盖导出成功/失败、早停状态下 summary 锁定与 Top-N 排序。  
        [Source: architecture/11-testing-strategy.md#test-organization]  
        [Source: architecture/14-monitoring-and-observability.md#指标基线示例]
  - [ ] 扩展 API 集成测试覆盖 `/optimizations/{id}/status` 排序、导出 200/4xx、复运行鉴权失败与成功路径。  
        [Source: architecture/11-testing-strategy.md#test-organization]
  - [ ] Playwright 用例验证实时刷新、导出下载、复运行后跳转与错误提示降级。  
        [Source: architecture/11-testing-strategy.md#testing-pyramid]  
        [Source: front-end-spec.md#flow-c-grid-optimization]

## Testing

- Python：新增 orchestrator 导出与排序单测，以及导出失败时的指标/日志断言。  
  [Source: architecture/11-testing-strategy.md#test-organization]
- API：Jest/Supertest 覆盖 `/optimizations/{id}/status`、导出端点与复运行请求的成功/错误/鉴权分支。  
  [Source: architecture/11-testing-strategy.md#test-organization]
- 前端：Vitest 针对进度轮询、Top-N 排序提示、复运行按钮与错误 fallback 的组件/服务测试。  
  [Source: front-end-spec.md#flow-c-grid-optimization]
- E2E：Playwright 场景验证提交寻优 → 查看详情 → 导出 → 复运行 → 历史列表刷新闭环。  
  [Source: architecture/11-testing-strategy.md#testing-pyramid]

## Env & Config

- 轮询间隔、导出批量大小等参数集中在配置模块管理，避免散落常量并支持环境化调整。  
  [Source: architecture/12-coding-standards.md#critical-fullstack-rules]
- 复运行与导出操作需遵循现有鉴权与最小权限配置，沿用 Supabase JWT 推导 `ownerId`。  
  [Source: architecture/08-backend-architecture.md#authentication-and-authorization]

## Project Structure Notes

- 遵循 Monorepo 结构：前端在 `apps/web/`、Python 服务在 `services/backtest/`、共享类型集中于 `packages/shared/`。  
  [Source: architecture/02-high-level-architecture.md#repository-structure建议]
- 前端所有 API 调用通过服务层统一封装，禁止组件内直接发请求。  
  [Source: architecture/07-frontend-architecture.md#frontend-services-layer]

## Change Log

| Date (UTC+8) | Version | Description                                       | Author |
| ------------ | ------- | ------------------------------------------------- | ------ |
| 2025-09-27   | v0.1    | Initial Draft created for PRD Epic 2 Story 2.4   | Bob (SM) |

## Dev Agent Record

### Agent Model Used

- 待开发完成后由 Dev Agent 填写。

### Debug Log References

- 待开发完成后由 Dev Agent 填写。

### Completion Notes List

- 待开发完成后由 Dev Agent 填写。

### File List

- 待开发完成后由 Dev Agent 填写。

## QA Results

- Draft 阶段暂无，实施后由 QA Agent 更新。

## Story Draft Checklist — Validation Report

### Summary

- Story readiness: READY
- Clarity score: 9/10
- Major gaps: 无

### Validation Table

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | 目标、依赖与业务价值清晰对齐 Epic 2 |
| 2. Technical Implementation Guidance | PASS   | 关键文件、类型与接口均已列出 |
| 3. Reference Effectiveness           | PASS   | 所有技术点提供精确文档引用 |
| 4. Self-Containment Assessment       | PASS   | 核心信息内嵌，引用作为证据补充 |
| 5. Testing Guidance                  | PASS   | 单元/集成/E2E 场景明确可行 |

### Developer Perspective

- 作为开发者可依据本故事立即开展实现；无未解答的问题。
- 潜在延迟：导出格式若需 UX 进一步确认，可在开发前同步，但不阻塞初版实现。
