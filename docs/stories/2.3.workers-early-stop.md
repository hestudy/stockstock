# Story 2.3: Workers & Early Stop

## Status

Draft

## Story

**As a** 参数寻优执行与稳定性负责人,
**I want** 让 Python Workers 消费子任务并在阈值或人工触发时安全终止,
**so that** 我们能在资源受控的前提下稳定输出 Top-N 结果并保留监控指标。

## Acceptance Criteria

1. Worker 执行与持久化：Python Worker 必须从队列拉取 `OptimizationTask`，执行后将状态、`retries`、`score`、`resultSummaryId` 等字段写回 `optimization_tasks`，并更新父作业 `OptimizationJob.summary` 的 `total/finished/topN`。  
   [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]  
   [Source: architecture/04-data-models.md#optimizationtask子]  
   [Source: architecture/04-data-models.md#optimizationjob父]
2. 阈值早停：当 `earlyStopPolicy` 的指标满足阈值（根据 `mode=min|max` 判断）时，Orchestrator 应将父作业状态置为 `early-stopped`，停止派发剩余任务并记录停机原因，保证 summary 与 Top-N 不再变化。  
   [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]  
   [Source: architecture/10-security-and-performance.md#queuecompute-slo]
3. 显式取消：提供对外取消入口（API 或 UI 调用）与内部处理逻辑，触发后需将父作业与未完成子任务状态转为 `canceled`，刷新 `summary` 并向调用方返回 202。  
   [Source: architecture/08-backend-architecture.md#service-architecture]  
   [Source: architecture/04-data-models.md#optimizationjob父]
4. 运行指标记录：Worker 与 Orchestrator 必须输出 `queue_wait_seconds`、`job_exec_seconds`、`job_retry_total` 等指标及结构化日志，为后续告警与 SLO 评估提供基础。  
   [Source: architecture/14-monitoring-and-observability.md#指标基线示例]  
   [Source: architecture/10-security-and-performance.md#queuecompute-slo]
5. 测试覆盖：新增/更新的单元、集成与端到端测试需覆盖执行成功、早停触发、取消触发、重试与指标输出路径，并纳入质量门。  
   [Source: architecture/11-testing-strategy.md#testing-pyramid]  
   [Source: architecture/11-testing-strategy.md#test-organization]

## Dependencies & Flow Fit

- 前置：`Story 2.2 Queue Orchestration` 已落实父作业拆分、并发闸门与 Top-N 汇总，本故事以其输出的调度事件为输入，完成真正的执行与终止流程。  
  [Source: docs/stories/2.2.queue-orchestration.md#Tasks / Subtasks]
- 后续：`Story 2.4 Progress & Aggregation` 将扩展 UI 与导出能力，依赖本故事提供的实时状态与指标；`Story 2.5 Failures & Quotas` 会在本故事的错误分类与撤销能力之上完善失败反馈与配额提示。  
  [Source: docs/prd/epic-details.md#Epic 2: Grid Optimization & Queue Orchestration]

## Dev Notes

### Previous Story Insights

- 架构流程表明 Orchestrator 会将父作业拆分并通过 Redis 推送给 Workers，本故事需在该流程后半段完成执行、终止与回写逻辑。  
  [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]

### Data Models

- `OptimizationJob` 记录 `concurrencyLimit`、`earlyStopPolicy`、`summary{total,finished,topN}` 与状态机（含 `early-stopped`/`canceled`），执行结果需严格对齐该结构。  
  [Source: architecture/04-data-models.md#optimizationjob父]
- `OptimizationTask` 保存 `params`、`status`、`progress`、`retries`、`score`、`resultSummaryId` 等字段，Worker 更新时必须维持这些字段与父作业一致性。  
  [Source: architecture/04-data-models.md#optimizationtask子]

### API Specifications

- Next.js API 层包含 `optimizations/route.ts` 与 `optimizations/[id]/status/route.ts`，本故事需要在此基础上补充取消入口并维持与共享类型一致。  
  [Source: architecture/08-backend-architecture.md#service-architecture]
- `JobStatus` 枚举包括 `queued/running/succeeded/failed/early-stopped/canceled`，API 响应必须使用统一状态值。  
  [Source: architecture/04-data-models.md#optimizationjob父]

### Component Specifications

- 队列与执行组件：Orchestrator 控制并发与早停，Worker 执行后写 DB/Storage 并上报指标，是本故事需要扩展的组件边界。  
  [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]
- Python 服务位于 `services/backtest/app/`，包含 orchestrator、worker、FastAPI 入口等。  
  [Source: architecture/08-backend-architecture.md#service-architecture]

### File Locations

- Python 执行路径：`services/backtest/app/orchestrator.py`、`services/backtest/app/workers/worker.py`、`services/backtest/app/main.py`。  
  [Source: architecture/08-backend-architecture.md#service-architecture]
- API/类型：`apps/web/src/app/api/v1/optimizations/[id]/cancel/route.ts`（新增）、`apps/web/src/app/api/v1/optimizations/orchestratorClient.ts`、`packages/shared/src/optimization.ts`。  
  [Source: architecture/08-backend-architecture.md#service-architecture]  
  [Source: architecture/02-high-level-architecture.md#repository-structure建议]

### Testing Requirements

- Python 端单测位于 `services/backtest/tests/test_*.py`（Pytest），需覆盖执行成功、异常重试与早停路径。  
  [Source: architecture/11-testing-strategy.md#test-organization]
- API/前端测试位于 `apps/web/src/app/api/**/__tests__`（Jest/Vitest）与 `apps/web/e2e`（Playwright），需包含取消与状态展示场景。  
  [Source: architecture/11-testing-strategy.md#test-organization]
- 测试金字塔要求单测数量最多，其次集成，再到端到端，确保关键路径被覆盖。  
  [Source: architecture/11-testing-strategy.md#testing-pyramid]

### Technical Constraints

- 队列与重试遵循 SLO：平均等待 ≤30s、P95 ≤2min；指数退避并限制最大重试次数。  
  [Source: architecture/10-security-and-performance.md#queuecompute-slo]
- Worker 错误必须分类抛出（`ParamInvalid`/`UpstreamError`/`InternalError`），便于重试与告警。  
  [Source: architecture/13-error-handling.md#workers-error-classificationpy片段]
- 代码需遵守统一类型共享、结构化日志与配置集中管理等后端编码规范。  
  [Source: architecture/12-coding-standards.md#critical-fullstack-rules]
- 监控需通过结构化日志与指标端点输出，支撑队列/执行指标跟踪。  
  [Source: architecture/14-monitoring-and-observability.md#monitoring-stack]

## Tasks / Subtasks

- [ ] Worker 执行与结果回写（AC: 1,4）  
  - [ ] 在 `services/backtest/app/workers/worker.py` 扩展任务消费逻辑，执行后写入 `optimization_tasks` 并更新 `resultSummaryId/score/retries`。  
        [Source: architecture/06-components-and-workflows.md#寻优流程optimization-submit含早停top-n-聚合]  
        [Source: architecture/04-data-models.md#optimizationtask子]
  - [ ] 引入结构化日志与指标计时，产出 `queue_wait_seconds`、`job_exec_seconds`、`job_retry_total`。  
        [Source: architecture/14-monitoring-and-observability.md#指标基线示例]
  - [ ] Pytest：补充成功/失败/重试路径与指标断言。  
        [Source: architecture/11-testing-strategy.md#test-organization]

- [ ] Orchestrator 早停与取消（AC: 2,3,4）  
  - [ ] 在 `services/backtest/app/orchestrator.py` 实现阈值检测与 `early-stopped` 状态写入，并停止派发剩余任务。  
        [Source: architecture/10-security-and-performance.md#queuecompute-slo]
  - [ ] 增加取消处理逻辑：接收取消请求后标记父作业与待执行子任务为 `canceled`，刷新 summary。  
        [Source: architecture/04-data-models.md#optimizationjob父]
  - [ ] 更新内网 FastAPI 端点与 Redis 调度以支持早停/取消回写，并记录结构化日志。  
        [Source: architecture/08-backend-architecture.md#service-architecture]
  - [ ] Pytest：覆盖早停命中、取消触发、多租户隔离等场景。  
        [Source: architecture/11-testing-strategy.md#test-organization]

- [ ] API 与服务层集成（AC: 1,3,5）  
  - [ ] 新增 `apps/web/src/app/api/v1/optimizations/[id]/cancel/route.ts`，调用 orchestrator 取消接口并返回 202。  
        [Source: architecture/08-backend-architecture.md#service-architecture]
  - [ ] 更新 `apps/web/src/app/api/v1/optimizations/orchestratorClient.ts` 与 `apps/web/src/services/optimizations.ts`，暴露取消函数与状态刷新。  
        [Source: architecture/07-frontend-architecture.md#frontend-services-layer]
  - [ ] 同步 `packages/shared/src/optimization.ts` 类型（含 `JobStatus`）并补充 API 层单测。  
        [Source: architecture/04-data-models.md#optimizationjob父]  
        [Source: architecture/11-testing-strategy.md#test-organization]

- [ ] 端到端验证与监控校验（AC: 4,5）  
  - [ ] 扩展 Playwright 覆盖：提交寻优 → 触发取消/早停 → 确认状态与 Top-N 更新。  
        [Source: architecture/11-testing-strategy.md#testing-pyramid]
  - [ ] 集成测试确保指标端点/日志在开关关闭时仍安全运行，不影响主流程。  
        [Source: architecture/14-monitoring-and-observability.md#monitoring-stack]
  - [ ] 记录队列/执行指标并与 SLO 阈值比较，必要时在 QA 文档中输出基线。  
        [Source: architecture/10-security-and-performance.md#queuecompute-slo]

## Testing

- Python 单测：`test_worker.py`、`test_orchestrator.py` 验证执行、早停、取消、重试与指标。  
  [Source: architecture/11-testing-strategy.md#test-organization]
- API 集成：`apps/web/src/app/api/v1/optimizations/__tests__/` 覆盖取消接口与状态聚合，断言状态机与错误映射。  
  [Source: architecture/11-testing-strategy.md#test-organization]
- 前端/服务层单测：验证取消按钮、状态轮询与错误提示。  
  [Source: architecture/07-frontend-architecture.md#frontend-services-layer]
- E2E：Playwright 覆盖“提交寻优 → Worker 执行 → 触发早停/取消 → UI 展示状态与 Top-N 更新”。  
  [Source: architecture/11-testing-strategy.md#testing-pyramid]

## Env & Config

- 继续复用现有 Redis、数据库与监控配置；若需新增早停阈值或重试上限配置，应集中在配置模块声明并遵循集中管理规则。  
  [Source: architecture/12-coding-standards.md#critical-fullstack-rules]  
  [Source: architecture/10-security-and-performance.md#queuecompute-slo]

## Project Structure Notes

- 代码组织遵循 Monorepo 约定：Python 执行逻辑位于 `services/backtest/app/`，Next.js API 位于 `apps/web/src/app/api/`，共享契约在 `packages/shared/`。  
  [Source: architecture/08-backend-architecture.md#service-architecture]  
  [Source: architecture/02-high-level-architecture.md#repository-structure建议]
- 新增或更新的测试分别落在 `services/backtest/tests/`、`apps/web/src/app/api/**/__tests__/`、`apps/web/e2e/` 目录。  
  [Source: architecture/11-testing-strategy.md#test-organization]

