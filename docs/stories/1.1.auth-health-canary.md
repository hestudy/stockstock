# Story 1.1: Auth & Health Canary

## Status

Approved

## Story

**As a** 登录用户,
**I want** 成功完成鉴权并访问健康检查/金丝雀信息,
**so that** 我能确认系统可用，未登录时得到明确的重定向与提示

## Acceptance Criteria

1. 鉴权可用：基于 Supabase Auth 完成登录/注册与会话管理；未登录访问受保护路由将被重定向至登录页，并展示提示。
2. 健康页可见：提供健康/金丝雀端点或页面，至少展示 API、Worker、Queue、Datasource 的状态快照。
3. 状态可视：在健康页或相关 UI 可见队列/服务状态（up/degraded/down），并有最近时间戳。
4. 错误提示：未登录、无权限或服务降级场景下，用户能看到清晰、非技术术语的错误文案。
5. 路由保护：前端 `(dashboard)` 段需有基于会话的保护逻辑；通过 E2E 验证基本登录 → 访问受保护页 → 跳转/展示正确内容路径。

来源：`docs/prd.md#Epic 1`（Story 1.1）

## Tasks / Subtasks

- [ ] 前端鉴权与路由保护（AC: 1,5）
  - [ ] 在 `apps/web/src/app/(dashboard)/layout.tsx` 实施会话检查与 `redirect("/login")`
        [Source: architecture/07-frontend-architecture.md#Protected Route Pattern]
  - [ ] 登录/注册 UI 或占位页接入 Supabase Auth（最简流程）
        [Source: architecture/07-frontend-architecture.md]
- [ ] 健康/金丝雀端点（AC: 2,3）
  - [ ] Next.js API Routes 暴露 `GET /api/v1/health` 返回 `service/status/details/ts`
        [Source: architecture/05-api-spec.md#HealthStatus]
  - [ ] 前端健康页或卡片展示 API、Worker、Queue、Datasource 状态（加载失败时有降级文案）
        [Source: architecture/06-components-and-workflows.md#Components Diagrams]
- [ ] 错误与文案（AC: 4）
  - [ ] 未登录与无权限状态的统一错误提示（参考 `ApiError` 结构与文案规范）
        [Source: architecture/05-api-spec.md#ApiError]
- [ ] 观测与日志（基础）（AC: 3）
  - [ ] 结构化日志与最小监控指标占位（API/Worker）
        [Source: architecture/03-tech-stack.md#Tech Stack; architecture/10-security-and-performance.md#Performance Optimization]
- [ ] 测试（AC: 1-5）
  - [ ] 前端单测（路由保护/组件渲染）
        [Source: architecture/11-testing-strategy.md#Test Organization]
  - [ ] API 路由单测（`/health` 200/结构）
        [Source: architecture/11-testing-strategy.md#Test Organization]
  - [ ] 关键路径 E2E：登录 → 访问受保护页 → 健康卡片可见；首屏加载不阻塞
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Dev Notes

- 技术栈与形态
  - 前端 Next.js App Router + TypeScript，UI 使用 Tailwind。
    [Source: architecture/03-tech-stack.md#Tech Stack]
  - 鉴权采用 Supabase Auth，后端解析 JWT 推导 `ownerId`；REST 前缀 `/api/v1`。
    [Source: architecture/05-api-spec.md]
- 路由与受保护段
  - 在 `(dashboard)/layout.tsx` 中执行会话校验与重定向，未登录重定向到 `/login`。
    [Source: architecture/07-frontend-architecture.md#Protected Route Pattern]
  - 目录组织参考 `apps/web/src/app/(dashboard)/**`。
    [Source: architecture/07-frontend-architecture.md#Route Organization]
- 健康/金丝雀
  - API: `GET /api/v1/health` 返回 `service`（api/worker/queue/datasource）、`status`（up/degraded/down）、`details`、`ts`。
    [Source: architecture/05-api-spec.md#HealthStatus]
  - 前端展示“摘要先行 → 细节”的加载策略；健康卡以轻量摘要优先。
    [Source: architecture/12-coding-standards.md#Result Loading; architecture/06-components-and-workflows.md#Core Workflows]
- 错误与日志
  - 统一 `ApiError` 结构与结构化日志（Pino/structlog），禁止 `console.log` 残留到生产。
    [Source: architecture/05-api-spec.md#ApiError; architecture/12-coding-standards.md#Logging]
- 安全与性能
  - 最小权限、CSP、速率限制与幂等建议；对 `submit/opt` 等写操作做限流。
    [Source: architecture/10-security-and-performance.md#Security Requirements]
- 测试
  - 单测/集成/E2E 组织与示例，关键路径 E2E 断言 2s 内摘要可见（在结果页场景，健康页不必强制 2s）。
    [Source: architecture/11-testing-strategy.md#Testing Strategy]
- 项目结构一致性
  - 前端组件禁直连后端，统一走 `services/` 服务层。
    [Source: architecture/12-coding-standards.md#Service Layer Only]

## Testing

- Frontend Unit：路由保护逻辑、健康卡组件渲染。
- API Unit：`/health` 结构校验与边界用例（未知服务名忽略/默认）。
- E2E：登录 → 访问 `(dashboard)`→ 健康卡片出现；失败时展示非技术术语的提示。
- 覆盖率目标：单元+集成 ≥70%，关键路径 E2E 校验维持。

## Project Structure Notes

- 与 `docs/architecture/07-frontend-architecture.md` 的路由与目录组织一致；
- 服务层封装 API 调用（`apps/web/src/services/`）。

## Change Log

| Date (UTC+8) | Version | Description                                     | Author   |
| ------------ | ------- | ----------------------------------------------- | -------- |
| 2025-09-11   | v0.1    | Initial Draft created from PRD Epic 1 Story 1.1 | Bob (SM) |

## Dev Agent Record

### Agent Model Used

{{agent_model_name_version}}

### Debug Log References

- N/A (to be populated by Dev Agent)

### Completion Notes List

- N/A (to be populated by Dev Agent)

### File List

- N/A (to be populated by Dev Agent)

## QA Results

Date: 2025-09-11
Author: Quinn (QA)

Summary:

- Test design 文档已生成：`docs/qa/assessments/1.1-test-design-20250911.md`
- 场景总数：15；层级分布：unit 5，integration 5，e2e 5
- 优先级：P0 6，P1 8，P2 1，P3 0
- 建议执行顺序：P0 单测 → P0 集成 → P0 E2E → 其余按优先级

Gate YAML 引用：

```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 5
    integration: 5
    e2e: 5
  by_priority:
    p0: 6
    p1: 8
    p2: 1
    p3: 0
  coverage_gaps: []
```

Trace:

- Test design matrix: `docs/qa/assessments/1.1-test-design-20250911.md`
- P0 tests identified: 6
