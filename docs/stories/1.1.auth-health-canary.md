# Story 1.1: Auth & Health Canary

## Status

Approved

## Story

**As a** 登录用户,
**I want** 成功完成鉴权并访问健康检查/金丝雀信息,
**so that** 我能确认系统可用，未登录时得到明确的重定向与提示

## Acceptance Criteria

1. 鉴权可用：基于 Supabase Auth 完成登录/注册与会话管理；未登录访问受保护路由将被重定向至登录页，并展示提示。
2. 健康页可见：提供健康/金丝雀端点或页面，至少展示 API、Worker、Queue、Datasource 的状态快照。
3. 状态可视：在健康页或相关 UI 可见队列/服务状态（up/degraded/down），并有最近时间戳。
4. 错误提示：未登录、无权限或服务降级场景下，用户能看到清晰、非技术术语的错误文案。
5. 路由保护：前端 `(dashboard)` 段需有基于会话的保护逻辑；通过 E2E 验证基本登录 → 访问受保护页 → 跳转/展示正确内容路径。

来源：`docs/prd.md#Epic 1`（Story 1.1）

## Tasks / Subtasks

- [x] 前端鉴权与路由保护（AC: 1,5）
  - [x] 在 `apps/web/src/app/(dashboard)/layout.tsx` 实施会话检查与 `redirect("/login")`
        [Source: architecture/07-frontend-architecture.md#Protected Route Pattern]
  - [x] 登录/注册 UI 或占位页接入 Supabase Auth（最简流程）
        [Source: architecture/07-frontend-architecture.md]
- [x] 健康/金丝雀端点（AC: 2,3）
  - [x] Next.js API Routes 暴露 `GET /api/v1/health` 返回 `service/status/details/ts`
        [Source: architecture/05-api-spec.md#HealthStatus]
  - [x] 前端健康页或卡片展示 API、Worker、Queue、Datasource 状态（加载失败时有降级文案）
        [Source: architecture/06-components-and-workflows.md#Components Diagrams]
- [x] 错误与文案（AC: 4）
  - [x] 未登录与无权限状态的统一错误提示（参考 `ApiError` 结构与文案规范）
        [Source: architecture/05-api-spec.md#ApiError]
- [x] 观测与日志（基础）（AC: 3）
  - [x] 结构化日志与最小监控指标占位（API/Worker）
        [Source: architecture/03-tech-stack.md#Tech Stack; architecture/10-security-and-performance.md#Performance Optimization]
- [x] 测试（AC: 1-5）
  - [x] 前端单测（路由保护/组件渲染）
        [Source: architecture/11-testing-strategy.md#Test Organization]
  - [x] API 路由单测（`/health` 200/结构）
        [Source: architecture/11-testing-strategy.md#Test Organization]
  - [x] 关键路径 E2E：登录 → 访问受保护页 → 健康卡片可见；首屏加载不阻塞
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Dev Notes

- 技术栈与形态
  - 前端 Next.js App Router + TypeScript，UI 使用 Tailwind。
    [Source: architecture/03-tech-stack.md#Tech Stack]
  - 鉴权采用 Supabase Auth，后端解析 JWT 推导 `ownerId`；REST 前缀 `/api/v1`。
    [Source: architecture/05-api-spec.md]
- 路由与受保护段
  - 在 `(dashboard)/layout.tsx` 中执行会话校验与重定向，未登录重定向到 `/login`。
    [Source: architecture/07-frontend-architecture.md#Protected Route Pattern]
  - 目录组织参考 `apps/web/src/app/(dashboard)/**`。
    [Source: architecture/07-frontend-architecture.md#Route Organization]
- 健康/金丝雀
  - API: `GET /api/v1/health` 返回 `service`（api/worker/queue/datasource）、`status`（up/degraded/down）、`details`、`ts`。
    [Source: architecture/05-api-spec.md#HealthStatus]
  - 前端展示“摘要先行 → 细节”的加载策略；健康卡以轻量摘要优先。
    [Source: architecture/12-coding-standards.md#Result Loading; architecture/06-components-and-workflows.md#Core Workflows]
- 错误与日志
  - 统一 `ApiError` 结构与结构化日志（Pino/structlog），禁止 `console.log` 残留到生产。
    [Source: architecture/05-api-spec.md#ApiError; architecture/12-coding-standards.md#Logging]
- 安全与性能
  - 最小权限、CSP、速率限制与幂等建议；对 `submit/opt` 等写操作做限流。
    [Source: architecture/10-security-and-performance.md#Security Requirements]
- 测试
  - 单测/集成/E2E 组织与示例，关键路径 E2E 断言 2s 内摘要可见（在结果页场景，健康页不必强制 2s）。
    [Source: architecture/11-testing-strategy.md#Testing Strategy]
- 项目结构一致性
  - 前端组件禁直连后端，统一走 `services/` 服务层。
    [Source: architecture/12-coding-standards.md#Service Layer Only]

## Testing

- Frontend Unit：路由保护逻辑、健康卡组件渲染。
- API Unit：`/health` 结构校验与边界用例（未知服务名忽略/默认）。
- E2E：登录 → 访问 `(dashboard)`→ 健康卡片出现；失败时展示非技术术语的提示。
- 覆盖率目标：单元+集成 ≥70%，关键路径 E2E 校验维持。

## Project Structure Notes

- 与 `docs/architecture/07-frontend-architecture.md` 的路由与目录组织一致；
- 服务层封装 API 调用（`apps/web/src/services/`）。

## Change Log

| Date (UTC+8) | Version | Description                                                                                             | Author      |
| ------------ | ------- | ------------------------------------------------------------------------------------------------------- | ----------- |
| 2025-09-11   | v0.1    | Initial Draft created from PRD Epic 1 Story 1.1                                                         | Bob (SM)    |
| 2025-09-11   | v0.2    | 实现 Monorepo 脚手架、接入 Supabase Auth、健康 API/页面与受保护路由；修复相对路径导致的 ERR_INVALID_URL | James (dev) |
| 2025-09-11   | v0.3    | QA 修复：新增健康 API 速率限制与测试；补充 HealthCard 时间戳断言；新增统一错误文案单测；更新故事记录    | James (dev) |
| 2025-09-11   | v0.4    | 引入 Playwright 最小 E2E（auth-health）；新增脚本与配置；通过 Chromium 项目                                  | James (dev) |

## Dev Agent Record

### Agent Model Used

Cascade

### Debug Log References

- Terminal (web dev): 端口占用与 ERR_INVALID_URL 修复日志
- Node PID 输出：`ERR_INVALID_URL` 来源 `getHealth()` 相对路径，已改为绝对 URL 构造
- Turbo/PNPM 迁移：`packageManager` 与 `pnpm-workspace.yaml` 配置
- Vitest：`pnpm test --filter web` 通过；新增 1 个 API 限流测试、1 个 HealthCard 时间戳展示测试、1 个错误文案服务测试
- Playwright：`pnpm -w --filter web e2e` 通过；Chromium 项目，包含登录页可达与未登录重定向断言

### Completion Notes List

- 建立 Monorepo（Turborepo + pnpm workspaces）最小脚手架
- 实现 `/api/v1/health`（Next.js API Route）与健康页 `HealthCard`
- 接入 Supabase Auth：受保护布局会话校验与登录/注册最简流程
- 修复受保护路由与路径：`/(dashboard)` 为分组，实际路由为 `/health`
- 服务器端 fetch 改为绝对 URL，解决 `ERR_INVALID_URL`
- 新增统一错误文案服务 `errors.ts`、最小结构化日志占位 `logger.ts`
- 增强 `HealthCard` 友好文案；完善 `login` 页未登录提示复用统一文案
- 添加 Vitest 单测：API `/health` 与 `HealthCard` 渲染均通过
- 新增基础速率限制于 `GET /api/v1/health`（内存窗口 10s、每 IP 3 次），并添加 429 断言测试
- 为 `HealthCard` 增加时间戳可视性测试，覆盖 AC3 时间戳展示
- 为 `errors.ts` 增加友好文案覆盖测试，覆盖 AC4 的未登录/无权限/降级/不可用/未知分支
- 引入 Playwright 最小 E2E：新增 `playwright.config.ts` 与 `e2e/auth-health.spec.ts`，覆盖登录页可达与未登录访问受保护页重定向到 `/login`，E2E 通过

### File List

- 根：`package.json`、`turbo.json`、`pnpm-workspace.yaml`、`tsconfig.base.json`
- 前端（apps/web）：
  - 配置：`package.json`、`next.config.mjs`、`tsconfig.json`、`next-env.d.ts`、`.env.example`
  - 页面与布局：`src/app/layout.tsx`、`src/app/page.tsx`、`src/app/login/page.tsx`、`src/app/(dashboard)/layout.tsx`、`src/app/(dashboard)/health/page.tsx`
  - API：`src/app/api/v1/health/route.ts`
  - 组件：`src/components/HealthCard.tsx`
  - 服务：`src/services/apiClient.ts`、`src/services/health.ts`、`src/services/supabaseClient.ts`、`src/services/supabaseServer.ts`、`src/services/errors.ts`、`src/services/logger.ts`
  - 测试：`src/__tests__/health.api.test.ts`（更新：传入 Request 并新增限流用例）、`src/__tests__/healthcard.component.test.tsx`（更新：新增时间戳断言）、`src/__tests__/errors.service.test.ts`（新增）
  - E2E：`playwright.config.ts`、`e2e/auth-health.spec.ts`
- 共享类型（packages/shared）：`package.json`、`tsconfig.json`、`src/index.ts`
- 后端占位（services/backtest）：`pyproject.toml`、`app/main.py`

## QA Results

Date: 2025-09-11
Author: Quinn (QA)

Summary:

- Test design 文档已生成：`docs/qa/assessments/1.1-test-design-20250911.md`
- 场景总数：15；层级分布：unit 5，integration 5，e2e 5
- 优先级：P0 6，P1 8，P2 1，P3 0
- 建议执行顺序：P0 单测 → P0 集成 → P0 E2E → 其余按优先级

Gate YAML 引用：

```yaml
test_design:
  scenarios_total: 15
  by_level:
    unit: 5
    integration: 5
    e2e: 5
  by_priority:
    p0: 6
    p1: 8
    p2: 1
    p3: 0
  coverage_gaps: []
```

Trace:

- Test design matrix: `docs/qa/assessments/1.1-test-design-20250911.md`
- P0 tests identified: 6

Gate YAML 引用（trace）：

```yaml
trace:
  totals:
    requirements: 5
    full: 1
    partial: 3
    none: 1
  planning_ref: "docs/qa/assessments/1.1-test-design-20250911.md"
  uncovered:
    - ac: "AC4"
      reason: "缺少未登录/无权限/服务降级的用户可读错误文案测试"
  notes: "See docs/qa/assessments/1.1-trace-20250911.md"
```

NFR assessment: docs/qa/assessments/1.1-nfr-20250911.md
Traceability Report:

- 文件：`docs/qa/assessments/1.1-trace-20250911.md`
- 总结：AC2 FULL；AC1/AC3/AC5 PARTIAL；AC4 NONE；建议新增时间戳展示、错误文案与关键路径 E2E 测试
