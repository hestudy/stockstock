# Story 1.5: Minimal Observability

## Status

Approved

## Story

**As a** 平台工程与开发团队,
**I want** 在前端、API 与 Workers 实现“最小可观测性”能力（结构化日志、关键时延指标、统一错误追踪）,
**so that** 我们可以快速定位问题、量化性能（含 2s 首屏目标）、并向用户提供一致的可读提示。

## Acceptance Criteria

1. 结构化日志（前端/后端/Workers）：
   - 前端：关键页面（结果详情页）发生错误时上报统一格式并带路由/用户态标签；可选启用 Web Vitals。
     [Source: architecture/14-monitoring-and-observability.md#Monitoring and Observability]
   - API（Next.js Routes）：按统一结构输出错误对象（`ApiError`），并记录请求上下文（路由/状态码）。
     [Source: architecture/13-error-handling.md#Error Response Format（TS）]
   - Workers（Python）：异常按分类码记录（参数/上游/内部），输出结构化日志。
     [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
2. 时延与性能指标（最小集）：
   - 对 `GET /api/v1/backtests/{id}/status` 与 `GET /api/v1/backtests/{id}/result` 采集请求时延直方图与计数（按路由与状态码打 label），暴露/导出到可用的 APM/控制台。
     [Source: architecture/14-monitoring-and-observability.md#指标基线（示例）]
     [Source: architecture/07-frontend-architecture.md#Frontend Services Layer]
     [Source: architecture/08-backend-architecture.md#Service Architecture]
   - 定义摘要首屏渲染耗时埋点（ms），用于验证 2s NFR。
     [Source: architecture/14-monitoring-and-observability.md#采集与导出（要点）]
3. 统一错误分类与用户提示：
   - API 返回体遵循 `ApiError` 结构，前端将错误码映射为用户可读信息（含鉴权、参数、频控、上游不可用等）。
     [Source: architecture/13-error-handling.md#Frontend Error Handling（TS）]
     [Source: architecture/13-error-handling.md#Backend Error Handling（TS，API 层）]
4. 可配置与最小依赖：
   - 不引入 Prometheus 自托管；允许通过环境变量启用/禁用（示例：`OBS_ENABLED`, `SENTRY_DSN`, `OTEL_EXPORTER_OTLP_ENDPOINT`），默认 dev/ci 开启，prod 可按环境配置。
     [Source: architecture/14-monitoring-and-observability.md#采集与导出（要点）]
5. 测试闭环：
   - 单测：错误映射函数、API 错误包装器、日志/埋点封装最小调用覆盖。
     [Source: architecture/11-testing-strategy.md#Test Organization]
   - 集成：`status/result` 路由成功/失败路径均记录指标与错误；Workers 异常分类日志路径。
     [Source: architecture/11-testing-strategy.md#Testing Pyramid]
   - E2E：回测详情首屏 2s 场景触发“摘要渲染耗时”埋点（可通过 mock/拦截验证）。
     [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Dependencies & Flow Fit

- 前置：`Story 1.4 Status & Basic Result` 已交付状态/结果接口与页面，是本故事采集与埋点的主要对象。
- 位置：对 Epic 1 闭环的稳定性与可维护性提供最小可观测性基线，便于后续性能与可靠性提升。

## Tasks / Subtasks

- [ ] 前端（埋点与错误追踪）
  - [x] 建立 `observability` 封装（Sentry/Web Vitals 可选、事件上报 API），暴露 `trackSummaryRendered(ms)`，带路由/会话上下文。
        [Source: architecture/14-monitoring-and-observability.md#采集与导出（要点）]
        [Source: architecture/07-frontend-architecture.md#Component Architecture]
  - [x] 在 `(dashboard)/backtests/[id]/page.tsx` 完成“摘要渲染耗时”埋点与错误捕获上报（用户可读提示保持不变）。
        [Source: architecture/07-frontend-architecture.md#Routing Architecture]
        [Source: architecture/13-error-handling.md#Frontend Error Handling（TS）]
  - [ ] 单测：埋点函数被调用；错误映射函数输出正确信息。
        [Source: architecture/11-testing-strategy.md#Test Organization]

- [ ] API（Next.js Routes）
  - [x] 建立 `apps/web/src/app/api/_lib/otel.ts` 指标/追踪最小封装：HTTP 直方图（路由+状态码 label）、计数器；对 `status/result` 路由接入。
        [Source: architecture/08-backend-architecture.md#Service Architecture]
        [Source: architecture/14-monitoring-and-observability.md#指标基线（示例）]
  - [x] 统一错误包装 `wrap()` 继续使用，确保 `ApiError` 结构与 requestId/timestamp；在失败路径记录指标。
        [Source: architecture/13-error-handling.md#Backend Error Handling（TS，API 层）]
  - [ ] 集成测试：成功/失败/429/5xx 分支触发指标与错误对象；断言 `ApiError` 结构。
        [Source: architecture/11-testing-strategy.md#Test Organization]

- [ ] Workers（Python）
  - [x] 在 `services/backtest/app/observability.py` 定义结构化日志 helper（包含 jobId、ownerId、阶段、耗时、重试次数、错误分类码）。
        [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
        [Source: architecture/14-monitoring-and-observability.md#Monitoring Stack]
  - [ ] 在关键路径（入队、开始、结束、异常）写日志；可选暴露最小指标（执行时长）。
        [Source: architecture/14-monitoring-and-observability.md#采集与导出（要点）]
  - [ ] Pytest：异常分类触发结构化日志（断言字段存在与分类码）。
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]

- [ ] E2E（最小验证）
  - [ ] 在 `e2e/backtests-detail.spec.ts` 通过拦截/注入方式验证“摘要渲染耗时”埋点触发（或通过 SDK mock 断言）。
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Dev Notes

- 监控与日志最小栈：前端 Sentry（可选）+ API OTel（导出器 Console/OTLP）+ Workers 结构化日志；不引入 Prometheus 自托管。
  [Source: architecture/14-monitoring-and-observability.md#Monitoring Stack]
- 指标基线：HTTP 时延按路由/状态打 label；队列侧推荐 `job_exec_seconds`/`job_retry_total`；业务计数如 `backtests_submitted_total` 可后续补充。
  [Source: architecture/14-monitoring-and-observability.md#指标基线（示例）]
- 错误策略：统一 `ApiError`；前端映射用户可读提示，避免技术细节外泄；Workers 侧异常分类（参数/上游/内部）。
  [Source: architecture/13-error-handling.md#Error Flow]
  [Source: architecture/13-error-handling.md#Frontend Error Handling（TS）]
  [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
- 路由/页面：埋点优先覆盖 `(dashboard)/backtests/[id]/page.tsx` 的“摘要先行 → 曲线 → 明细”流程，聚焦 2s 首屏目标。
  [Source: architecture/07-frontend-architecture.md#Routing Architecture]
  [Source: architecture/03-tech-stack.md#Tech Stack]
- API 服务层：`getBacktestStatus/getBacktestResult` 是指标采集与错误分类的重点路径。
  [Source: architecture/07-frontend-architecture.md#Frontend Services Layer]
  [Source: architecture/08-backend-architecture.md#Service Architecture]

### Env & Config

- 建议：`OBS_ENABLED`、`SENTRY_DSN`、`OTEL_EXPORTER_OTLP_ENDPOINT`、`OTEL_RESOURCE_ATTRIBUTES`。
  [Source: architecture/14-monitoring-and-observability.md#采集与导出（要点）]

### Testing（Standards & Hooks）

- 单测：前端错误映射与埋点封装、API 错误包装与指标封装、Workers 结构化日志 helper。
  [Source: architecture/11-testing-strategy.md#Test Organization]
- 集成：`status/result` 路由成功/失败路径的指标与错误断言；Workers 异常分类日志。
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]
- E2E：登录 → 进入 `(dashboard)/backtests/[id]` → 在 2 秒内可见摘要，同时验证埋点触发（mock 拦截）。
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Project Structure Notes

- 代码位置与命名（建议）：
  - `apps/web/src/utils/observability.ts`（前端埋点与错误上报封装）
  - `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`（摘要耗时埋点接入）
  - `apps/web/src/app/api/_lib/otel.ts`（API 指标封装）
  - `apps/web/src/app/api/_lib/handler.ts`（错误包装器，保持统一结构）
  - `services/backtest/app/observability.py`（Workers 结构化日志）

## File List (expected)

- apps/web/src/utils/observability.ts
- apps/web/src/app/(dashboard)/backtests/[id]/page.tsx
- apps/web/src/app/api/_lib/otel.ts
- apps/web/src/app/api/_lib/handler.ts
- services/backtest/app/observability.py
- e2e/backtests-detail.spec.ts（新增/增强：埋点验证）
- apps/web/src/app/api/**/__tests__/*.test.ts（指标与错误结构断言）
- services/backtest/tests/test_observability.py

Added/Updated in this implementation pass:

- apps/web/src/utils/observability.ts
- apps/web/src/app/api/_lib/otel.ts
- apps/web/src/app/api/_lib/handler.ts
- services/backtest/app/observability.py
- apps/web/src/utils/__tests__/observability.test.ts
- apps/web/src/app/api/_lib/__tests__/otel.test.ts
- apps/web/src/app/api/_lib/__tests__/handler.test.ts
- services/backtest/tests/test_observability.py

## Dev Agent Record

### Agent Model Used

- Cascade

### Debug Log References

- .ai/debug-log.md

### Completion Notes

- 完成 FE 最小观测封装与接入（`observability.ts` + 回测详情页摘要耗时/错误上报）。
- 新增 API 指标封装 `otel.ts` 与错误包装 `handler.ts`，并接入 `status/result` 路由，记录路由+状态码时延与失败路径。
- 新增 Workers 结构化日志 helper（`services/backtest/app/observability.py`）。
- 补充最小单测：FE 观测封装、API `timeHttp` 与 `wrap`；Workers `log_error`。
- 后续待办：API 路由集成测试分支覆盖、Workers 在关键路径接入日志、E2E 埋点验证用例。

## Story Draft Checklist — Validation Report

Quick Summary

- Story readiness: READY
- Clarity score: 9/10
- Major gaps identified: 无（Prometheus 自托管留作后续增强）

Validation Table

| Category                             | Status | Issues |
| ------------------------------------ | ------ | ------ |
| 1. Goal & Context Clarity            | PASS   | 与 Epic 1 闭环契合，聚焦 2s 首屏可观测性 |
| 2. Technical Implementation Guidance | PASS   | 关键文件与封装位置、最小指标/埋点已明确 |
| 3. Reference Effectiveness           | PASS   | 全部技术点附带 `architecture/*.md#section` 引用 |
| 4. Self-Containment Assessment       | PASS   | 关键信息内嵌，引用作证据与扩展 |
| 5. Testing Guidance                  | PASS   | 单测/集成/E2E 最小验证路径清晰 |

Final Assessment: READY

## Change Log

| Date (UTC+8) | Version | Description                                   | Author |
| ------------ | ------- | --------------------------------------------- | ------ |
| 2025-09-19   | v0.1    | Initial Draft created from PRD Epic 1 Story 1.5 | Bob (SM) |
