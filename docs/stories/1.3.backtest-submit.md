# Story 1.3: Backtest Submit

## Status

Ready for Review

## Story

**As a** 登录用户（量化研究者）,  
**I want** 在受保护的回测页面提交包含策略版本与参数的回测作业,  
**so that** 我可以触发后端队列执行并在后续查看其状态与结果

## Acceptance Criteria

1. 提交入口：在 `(dashboard)/backtests` 页面提供“提交回测”入口，点击可提交当前编辑器草稿（或表单）并获得 `jobId`。
2. Payload 契约：提交的 `POST /api/v1/backtests` 请求体包含 `versionId` 与 `params` 字段；字段结构与共享类型一致；请求头包含 JWT（若前端代理则由服务器侧附加）。
3. 成功反馈：接口返回 `202 Accepted` 与 `{ id, status }`，前端接收 `id` 并展示“已提交”的可视反馈与跳转按钮（或自动跳转至 `/backtests/{id}`）。
4. 失败处理：当请求失败（含超时/429/4xx/5xx），展示用户可读的统一错误文案并支持重试；错误遵循 `ApiError` 结构。
5. 速率与幂等：提交接口具备速率限制与幂等键机制（如 `clientRequestId`），前端在服务层内可生成并附带（占位或预留）。
6. 测试覆盖：具备单元与集成测试覆盖“payload 结构正确、成功/失败分支处理”，并预留 E2E 钩子（登录 → 提交 → 跳转状态页）。
7. 幂等与请求标识：前端服务层生成 `clientRequestId`（UUID v4）并随 `POST /api/v1/backtests` 发送；API 层基于该键提供 5 分钟幂等窗口并将其透传至队列/日志上下文。

来源：`docs/prd.md#Epic 1`（Story 1.3）

## Dependencies & Flow Fit

- 前置依赖：`Story 1.2 Strategy Template & Editor` — 已提供策略编辑器与 `buildSubmitPayload` 等组装能力。
- 上下文承接：本故事产出 `submitBacktest` 的前端对接与 UI 提交流程，为 `Story 1.4 Status & Basic Result` 提供 `jobId` 与导航入口。

## Tasks / Subtasks

- [x] 前端提交流程（AC: 1,2,3,4,5）
  - [x] 在 `apps/web/src/app/(dashboard)/backtests/page.tsx` 增加“提交回测”按钮，并调用服务层提交方法；成功后提示与跳转（或可选停留+复制链接）。  
         [Source: architecture/07-frontend-architecture.md#Route Organization]
  - [x] 在 `apps/web/src/services/backtests.ts` 对接 `submitBacktest(payload)`，并与 `buildSubmitPayload` 对齐，确保 `versionId` 与 `params` 正确传入。  
         [Source: architecture/07-frontend-architecture.md#Frontend Services Layer]
  - [x] 在 `apps/web/src/services/strategies.ts` 暴露 `buildSubmitPayload(draft)`（若已存在则复用），校验草稿结构与参数映射，必要时补充类型守卫。  
         [Source: architecture/12-coding-standards.md#Type Sharing]
  - [x] 成功后展示可视反馈（toast/inline）并将 `id` 写入 `useJobsStore`（若使用），支持一键跳转 `/backtests/{id}`。  
         [Source: architecture/07-frontend-architecture.md#State Patterns]
  - [x] 失败分支：统一错误捕获与文案映射，避免技术术语泄漏；对 `429` 给出节流/重试提示。  
         [Source: architecture/12-coding-standards.md#Error Handling]
- [x] API 契约与安全（AC: 2,4,5）

  - [x] 请求路径：`POST /api/v1/backtests`，响应 `202 { id, status }`；遵循共享类型 `BacktestSubmitRequest/Response`。  
         [Source: architecture/05-api-spec.md#L22; architecture/05-api-spec.md#L152]
  - [x] 认证：JWT（Supabase）在服务器侧解析（若走 Next.js API routes）；前端不持久化敏感信息。  
         [Source: architecture/05-api-spec.md#L5]
  - [x] 速率限制：提交类接口具备速率限制与幂等键（`clientRequestId` 预留/实现）；在 CI/E2E 中确保不过度触发。  
         [Source: architecture/12-coding-standards.md#Rate Limit/Idempotency]

- [x] UI/UX 与导航（AC: 1,3）

  - [x] 在提交成功后提供明显的“查看状态”入口（按钮/链接），并在 1.4 故事中消费 `/backtests/{id}/status`。  
         [Source: architecture/06-components-and-workflows.md#Core Workflows]
  - [x] 提交按钮在前置条件不足时禁用（如草稿为空/参数不合法），并给出可达性提示（aria-disabled/aria-live）。
  - [x] 未登录访问 `(dashboard)/backtests` 将根据受保护路由模式重定向至 `/login`（见 `docs/architecture/07-frontend-architecture.md#Protected Route Pattern`）。
  - [x] 无障碍：提交按钮与错误提示应包含 `aria-disabled` 与 `aria-live=\"polite\"` 等属性，确保可达性。

- [ ] 测试（AC: 6）
  - [x] Frontend Unit：`buildSubmitPayload` 结构断言、提交按钮禁用/启用逻辑、成功/失败反馈渲染。  
         [Source: architecture/11-testing-strategy.md#Test Organization]
  - [x] Integration：服务层对 `submitBacktest` 的请求体与响应处理（mock fetch）；对 `429/4xx/5xx` 重试/提示路径断言。  
         [Source: architecture/11-testing-strategy.md#Testing Pyramid]
  - [x] E2E（占位）：登录 → 进入 `(dashboard)/backtests` → 点击提交（拦截网络）→ 看到成功提示与“查看状态”入口；后续 1.4 完成详情跳转与摘要 2s 断言。

## Dev Notes

- 技术栈与形态
  - 前端 Next.js App Router + TypeScript，UI 使用 Tailwind；服务层封装 HTTP 与错误处理。  
    [Source: architecture/03-tech-stack.md#Tech Stack; architecture/07-frontend-architecture.md#Frontend Services Layer]
- 契约与共享类型
  - `BacktestSubmitRequest = { versionId: string; params: Record<string, any> }`；响应 `{ id: string; status: JobStatus }`；保持与 `packages/shared` 一致（若缺失则本故事附带添加）。  
    [Source: architecture/05-api-spec.md#paths; architecture/12-coding-standards.md#Type Sharing]
- 路由与导航
  - 提交入口位于 `(dashboard)/backtests/page.tsx`；成功后跳转 `/backtests/{id}`（后续故事消费 status/result）。  
    [Source: architecture/07-frontend-architecture.md#Route Organization; architecture/06-components-and-workflows.md#Core Workflows]
- 错误与日志
  - 统一 `ApiError` 结构，用户可读错误文案走前端 `errors.ts`；禁止输出敏感信息；结构化日志用于诊断。  
    [Source: architecture/12-coding-standards.md#Error Handling; architecture/05-api-spec.md#components]
- 安全与速率
  - 提交接口启用速率限制、重试退避与幂等键；前端避免暴露 Service Key，仅使用匿名 Key；JWT 由服务器侧解析。  
    [Source: architecture/12-coding-standards.md#Security Defaults; #Rate Limit/Idempotency]

### Env & Config

- 前端：`NEXT_PUBLIC_API_BASE`、`NEXT_PUBLIC_SUPABASE_URL`、`NEXT_PUBLIC_SUPABASE_ANON_KEY`
- 后端/API：`SUPABASE_SERVICE_KEY`（仅后端）、`REDIS_URL`、`RATE_LIMIT_*`（占位）
- 约束：环境变量需集中由 `config` 模块导出，业务代码禁止散用；参见 `docs/architecture/12-coding-standards.md#Env Access`

### Testing（Standards & Hooks）

- 单测：
  - `buildSubmitPayload` 断言 `versionId/params` 均存在且类型正确；空草稿/非法参数抛错分支。
  - 提交按钮状态与可达性：`aria-disabled`、错误提示通过 `aria-live="polite"`。
- 集成：
  - `submitBacktest` 成功路径返回 `id/status` 并写入 store；失败路径对 429 与 500 分别断言文案与重试提示。
- E2E（占位）：
  - 登录 → 访问 `(dashboard)/backtests`→ 点击提交（拦截 `POST /api/v1/backtests` 并返回伪 `id`）→ 页面出现“查看状态”按钮并可导航。

## Project Structure Notes

- 代码位置与命名：
  - `apps/web/src/app/(dashboard)/backtests/page.tsx`（提交入口/按钮）
  - `apps/web/src/services/backtests.ts`（提交/状态/结果服务封装）
  - `apps/web/src/services/strategies.ts`（`buildSubmitPayload` 与草稿读取）
  - `packages/shared/src/backtest.ts`（若缺失则新增共享类型：`BacktestSubmitRequest/Response` 等）
    - 导出类型：`BacktestSubmitRequest`、`BacktestSubmitResponse`、`BacktestStatusResponse`、`ResultSummary`、`JobStatus`

## File List

- apps/web/src/app/(dashboard)/backtests/page.tsx（提交入口/按钮、可达性属性、导航）
- apps/web/src/services/backtests.ts（`submitBacktest` 封装，自动生成 `clientRequestId`）
- packages/shared/src/backtest.ts（共享类型契约：`BacktestSubmitRequest/Response`、`JobStatus` 等）
- apps/web/e2e/backtests.spec.ts（E2E 烟囱测试：编辑器与模板动作可见性；提交流占位待补充）
- apps/web/src/__tests__/backtests.page.test.tsx（页面单测：按钮渲染与基本 SSR 烟测）
- apps/web/src/__tests__/backtests.service.test.ts（服务层集成测试：请求体与错误分支）
- apps/web/src/__tests__/jobsStore.service.test.ts（最近提交 Job Id 写入验证）
- apps/web/src/__tests__/strategyEditor.component.test.tsx（编辑器组件可用性与校验）

## Dev Agent Record

- Agent Model Used: Cascade（dev 工作流）
- Debug Log References: `.ai/debug-log.md`
- Completion Notes:
  - 已按 AC 实现前端提交流程与服务层契约，`clientRequestId` 幂等键在前端自动生成，API 层透传并提供 5 分钟窗口（`apps/web/src/app/api/v1/backtests/route.ts`）。
  - 本地执行 `pnpm lint`、`pnpm test` 全部通过，覆盖率符合预期；E2E 仅针对 `e2e/backtests.spec.ts` 进行烟测通过，其余跨故事用例暂未纳入本故事范围。
  - 已补充 File List 以便评审定位改动点；E2E 提交流程仍为占位，后续在 Story 1.4/1.5 中继续完善。

## Change Log

| Date (UTC+8) | Version | Description                                     | Author   |
| ------------ | ------- | ----------------------------------------------- | -------- |
| 2025-09-12   | v0.2    | 前端提交流程、API 契约与 UI 导航完成；单元/集成测试通过 | James (dev) |
| 2025-09-12   | v0.1    | Initial Draft created from PRD Epic 1 Story 1.3 | Bob (SM) |
| 2025-09-12   | v0.2.1  | 本地 Lint/测试通过校验；补充 File List；E2E 提交流程仍为占位 | James (dev) |
| 2025-09-12   | v0.3    | 新增并通过 E2E 占位用例（拦截 `POST /api/v1/backtests` 并跳转）；状态更新为 Ready for Review | James (dev) |
