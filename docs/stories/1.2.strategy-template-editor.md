# Story 1.2: Strategy Template & Editor

## Status

Done

## Story

**As a** 登录用户（量化研究者）,  
**I want** 使用内置策略模板在前端代码编辑器中进行策略编辑并维护依赖与元数据,  
**so that** 我可以快速上手并提交规范化的回测作业

## Acceptance Criteria

1. 内置策略模板：提供至少一个可运行的策略模板（含示例参数），支持一键加载/重置到编辑器。
2. 语法高亮：策略代码编辑器具备语法高亮和基础编辑体验（行号、自动缩进、错误高亮占位）。
3. 依赖声明：支持在 UI 中维护策略的 `requirements`（例如 `vectorbt`, `pandas`）清单，提交时一并保存/传递。
4. 元数据可编辑：支持维护策略元数据（名称、标签、描述、版本时间戳等），并在提交时随作业上送。
5. 可测与可集成：具备单元/集成测试覆盖（前端组件与服务层），并预留 E2E 场景钩子（登录后进入编辑器页）。

来源：`docs/prd.md#Epic 1`（Story 1.2）

## Dependencies & Flow Fit

- 前置依赖：`Story 1.1 Auth & Health Canary` — 已提供受保护路由与登录后访问能力（确保本故事页面位于 `(dashboard)` 下并启用会话校验）。
- 上下文承接：本故事交付编辑器与模板/依赖/元数据能力，为 `Story 1.3 Backtest Submit` 的提交流程与 `Story 1.4 Status & Result` 的结果展示提供输入模型与 UI 入口。

## Tasks / Subtasks

- [x] 编辑器基础与模板装载（AC: 1,2）
  - [x] 在 `apps/web/src/app/(dashboard)/backtests/page.tsx` 增加“策略编辑器 + 提交入口”的布局骨架（左/中/右 或 上/下 两栏），优先骨架与可访问性。
        [Source: architecture/07-frontend-architecture.md#Route Organization]
    - 注：规定页面放置于 `(dashboard)` 及布局结构，确保路由与会话保护一致
  - [x] 选择编辑器实现（优先 `@monaco-editor/react`）并实现语法高亮、行号与最小错误高亮占位。
        [Source: architecture/03-tech-stack.md#Tech Stack]
    - 注：明确前端技术栈并支持富编辑器在客户端渲染
  - [x] 在 `apps/web/src/components/forms/` 下创建 `StrategyEditor.tsx`，支持加载/重置内置模板。
        [Source: architecture/07-frontend-architecture.md#Component Organization]
    - 注：组件按领域组织，表单/编辑器归口 `components/forms/`
  - [x] 在 `packages/shared/` 定义并导出 `StrategyMetadata`/`StrategyRequirements`/`StrategySource` 类型。
        [Source: architecture/12-coding-standards.md#Type Sharing]
    - 注：类型单一来源，前后端共享，避免重复定义
- [x] 模板与示例参数（AC: 1）
  - [x] 在 `apps/web/src/components/forms/templates/` 放置 `mean-reversion.template.ts`（包含 `source`, `params` 示例、注释与使用说明）。
        [Source: architecture/06-components-and-workflows.md#Core Workflows]
    - 注：模板对齐核心工作流，便于后续提交/结果串联
  - [x] 在编辑器提供“从模板加载/重置到模板/清空”按钮与确认提示。
- [x] 依赖与元数据面板（AC: 3,4）
  - [x] 在右侧信息面板提供 `requirements` 编辑（多行或 tag 输入），校验基本格式（包名: 可选版本）。
        [Source: architecture/12-coding-standards.md#Security Requirements]
    - 注：依赖声明遵循安全默认与最小权限原则
  - [x] 提供元数据表单：`name`、`tags[]`、`description`、`versionTimestamp`（默认当前时间，可编辑）。
  - [x] 数据模型与服务层：在 `apps/web/src/services/strategies.ts` 定义保存/读取草稿的服务方法（可先存于本地 `localStorage` 或后续接 API）。
        [Source: architecture/07-frontend-architecture.md#Frontend Services Layer]
    - 注：服务层统一封装存取，便于替换存储介质（本地/后端）
    - 存储键与结构（本故事建议实现）：
      - localStorage key: `strategy-editor:draft`
      - JSON schema（最小）：
        ```json
        {
          "metadata": {
            "name": "",
            "tags": [],
            "description": "",
            "versionTimestamp": "ISO-8601"
          },
          "requirements": {
            "packages": [{ "name": "vectorbt", "version": ">=0.25" }]
          },
          "source": { "language": "python", "content": "", "params": {} }
        }
        ```
- [x] 提交流程对接（占位对齐 Story 1.3）（AC: 5）
  - [x] 统一构造 `BacktestSubmitRequest` 的 `versionId`（模板可生成占位 UUID）与 `params`，并将 `metadata`/`requirements` 附带到 payload。
        [Source: architecture/07-frontend-architecture.md#Frontend Services Layer]
    - 注：对齐提交契约，确保后续 1.3 可直接复用
  - [x] 调用占位的 `submitBacktest`（若尚未实现后端，提供 mock；本故事不要求提交成功）。
- [x] 错误与可达性（AC: 2,5）
  - [x] 统一错误文案复用 `apps/web/src/services/errors.ts`；在编辑器与表单区展示非技术术语的提示。
        [Source: architecture/12-coding-standards.md#Logging]
    - 注：统一错误结构/文案，避免技术术语外泄
  - [x] 深色模式与键盘可达性（Tab 顺序、按钮 aria-label）。
- [x] 测试（AC: 5）
  - [x] Frontend Unit：`StrategyEditor` 渲染、模板加载/重置、依赖/元数据表单校验。
        [Source: architecture/11-testing-strategy.md#Test Organization]
    - 注：遵循测试金字塔与目录组织
  - [x] Integration：服务层 `strategies.ts` 草稿保存/读取；与 `submitBacktest` payload 组装。
  - [x] E2E（占位）：登录后访问 `(dashboard)/backtests`，断言编辑器/模板按钮可见。

## Dev Notes

- 技术栈与形态
  - 前端：Next.js App Router + TypeScript + Tailwind；组件分层与服务层封装。
    [Source: architecture/03-tech-stack.md#Tech Stack]
  - 编辑器：首选 `@monaco-editor/react`；如受限可降级至 `CodeMirror`。仅在客户端渲染，确保 SSR 兼容。
    [Source: architecture/07-frontend-architecture.md#Component Organization]
- 目录与路由
  - 编辑页位于 `(dashboard)/backtests/page.tsx`，后续与提交/结果（1.3/1.4）同域串联。
    [Source: architecture/07-frontend-architecture.md#Route Organization]
- 服务层与类型

  - 禁止在组件内直接 `fetch`，统一通过 `apps/web/src/services/`。
    [Source: architecture/12-coding-standards.md#Service Layer Only]
  - 在 `packages/shared/` 定义并共享 `Strategy*` 类型，避免重复定义。
    [Source: architecture/12-coding-standards.md#Type Sharing]
  - 最小类型契约示例（建议在 `packages/shared/src/strategy.ts` 落地）：

    ```ts
    export type StrategyMetadata = {
      name: string;
      tags: string[];
      description?: string;
      versionTimestamp: string; // ISO-8601
    };

    export type StrategyRequirements = {
      packages: Array<{ name: string; version?: string }>;
    };

    export type StrategySource = {
      language: "python"; // MVP 固定
      content: string;
      params: Record<string, any>;
    };

    export type StrategyDraft = {
      metadata: StrategyMetadata;
      requirements: StrategyRequirements;
      source: StrategySource;
    };
    ```

- 安全与性能
  - 仅在受保护布局 `(dashboard)/layout.tsx` 下提供编辑器，未登录自动重定向到 `/login`。
    [Source: architecture/07-frontend-architecture.md#Protected Route Pattern]
  - 编辑器与图表等重组件按需/懒加载，避免阻塞；严格遵循“摘要先行 → 曲线 → 明细”的整体策略（后续故事适用）。
    [Source: architecture/12-coding-standards.md#Result Loading]
- 测试要求
  - 覆盖率目标 ≥70%，单元/集成/E2E 组织遵循文档。
    [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Testing

- Frontend Unit：
  - `StrategyEditor` 渲染与语法高亮占位；模板加载/重置按钮行为；依赖/元数据表单校验。
- Integration：
  - `services/strategies.ts` 草稿保存/读取；`submitBacktest` payload 组装包含 `metadata` 与 `requirements`。
- E2E（占位）：
  - 登录 → 访问 `(dashboard)/backtests` → 看到编辑器与模板按钮；后续故事将接入提交与结果流。
- 覆盖率：
  - 目标 ≥70%；CI 由 `web-unit.yml` 汇报，E2E 由 `web-e2e.yml` 执行。

### 可测断言示例（建议落地 data-testid）

- `data-testid="editor"`：点击“Load Template”后 100ms 内文本非空。
- `data-testid="requirements-input"`：非法依赖格式时显示校验消息，提交按钮禁用。
- `data-testid="reset-template"`：点击后代码与表单恢复到模板初始值。

## Project Structure Notes

- 遵循 `docs/architecture/07-frontend-architecture.md` 的组件与服务层组织。
- 新增文件建议：
  - `apps/web/src/components/forms/StrategyEditor.tsx`
  - `apps/web/src/components/forms/templates/mean-reversion.template.ts`
  - `apps/web/src/services/strategies.ts`
  - `packages/shared/src/strategy.ts`

## Assumptions & Edge Cases

- 编辑器仅在客户端渲染（SSR 跳过）；失败时显示占位与“重试加载”按钮。
- 未登录重定向后返回页面时，从 `localStorage`（`strategy-editor:draft`）自动恢复草稿。
- 模板资源加载失败时，展示友好提示并提供重试入口；不阻塞元数据/依赖编辑。
- 依赖清单为空或格式非法时，提交按钮禁用并展示提示（本故事到 UI 校验）。

## QA Results

- 评审日期（UTC+8）：2025-09-12
- 评审人：Quinn（Test Architect）
- 测试设计文档：`docs/qa/assessments/1.2-test-design-20250912.md`
- NFR 评估文档：`docs/qa/assessments/1.2-nfr-20250912.md`
- 概要：
  - 场景总数：12；按层级：Unit 5（41.7%）、Integration 4（33.3%）、E2E 3（25.0%）
  - 优先级分布：P0=4，P1=5，P2=3
  - 重点风险覆盖：SEC-001（供应链依赖）、OPS-001（受保护路由）、PERF-001（编辑器性能）、SEC-002（XSS）、DATA-001/002、BUS-001/002
  - 推荐执行顺序：P0 Unit → P0 Integration → P0 E2E → P1 → P2
- 备注：请在实现中为关键元素添加 `data-testid`（editor、requirements-input、reset-template），以支持自动化断言。
  Gate: PASS → docs/qa/gates/1.2-strategy-template-editor.yml

---

### 追加评审（2025-09-12 13:30 UTC+8）

- Gate 决策：CONCERNS（详见 `docs/qa/gates/1.2-strategy-template-editor.yml`）
- 主要依据：
  - AC1、AC5 已 FULL 覆盖；
  - AC2/AC3/AC4 目前 PARTIAL，存在两个关键缺口：
    1. 错误高亮占位缺少显式用例（AC2）；
    2. 提交 payload 携带 `metadata`/`requirements` 的端到端断言缺失（AC3/AC4）。
- 建议行动（P0）：
  - 在组件单测中补充“错误高亮占位可访问性”断言；
  - 在集成或 E2E 中对 `buildSubmitPayload` 或网络层进行断言，验证 `metadata` 与 `requirements` 已正确携带。

详见测试设计矩阵文档获取 AC→ 场景映射表与风险到测试的追踪矩阵。

---

### 追加评审（2025-09-12 13:39 UTC+8）

- Gate 决策：PASS（详见 `docs/qa/gates/1.2-strategy-template-editor.yml`）
- 主要依据：
  - 组件单测补齐并通过：`editor-error-placeholder` 的 `aria-live="polite"` 可访问占位（AC2），见 `apps/web/src/__tests__/strategyEditor.component.test.tsx`；
  - 集成测试补齐并通过：`buildSubmitPayload` 携带 `metadata`/`requirements` 及 `params` 的断言（AC3/AC4），见 `apps/web/src/__tests__/strategies.service.test.ts`；
  - 模板加载、基础编辑体验与测试钩子满足（AC1/AC5）。
- 建议后续：依据 `docs/qa/assessments/1.2-nfr-20250912.md`，在 E2E 中补充网络层拦截以断言提交 payload，并对性能/可靠性进行抽样验证。

## Dev Agent Record

### Agent Model Used

- Cascade

### Debug Log References

- 2025-09-12 13:27 (UTC+8) 执行：`pnpm test` → 所有 Vitest 测试通过；覆盖率统计：Statements 92.74%, Branches 77.5%, Functions 74.28%, Lines 92.74%
- 注意：jsdom 环境关于 `act(...)` 报告了 Warning（非阻断），不影响断言结果
- 2025-09-12 13:35 (UTC+8) 执行：`pnpm test` → 全部通过（9/9）；覆盖率：Statements 92.74%, Branches 77.5%, Functions 74.28%, Lines 92.74%。请求 QA 复审 Gate。

### Completion Notes

- AC2：在 `apps/web/src/components/forms/StrategyEditor.tsx` 中增加 `data-testid="editor-error-placeholder"` 且带 `aria-live="polite"` 的可访问占位，以支持“错误高亮占位”测试与可达性要求
- AC3/AC4：在 `apps/web/src/services/strategies.ts` 新增 `buildSubmitPayload`，确保 `metadata` 与 `requirements` 在提交 payload 结构中可被直接断言；并补充相应集成测试
- 规范：统一共享类型导入为 `@shared/strategy`，对齐 `packages/shared` 的类型共享规则

### File List

- apps/web/src/components/forms/StrategyEditor.tsx (modified)
- apps/web/src/services/strategies.ts (modified)
- apps/web/src/**tests**/strategyEditor.component.test.tsx (added test)
- apps/web/src/**tests**/strategies.service.test.ts (added test)

## Change Log

| Date (UTC+8) | Version | Description                                                                              | Author      |
| ------------ | ------- | ---------------------------------------------------------------------------------------- | ----------- |
| 2025-09-12   | v0.1    | Initial Draft created from PRD Epic 1 Story 1.2                                          | Bob (SM)    |
| 2025-09-12   | v0.2    | Apply checklist-driven revisions: 依赖与流程、最小类型、草稿存储结构、边界与可测断言补充 | Bob (SM)    |
| 2025-09-12   | v0.3    | QA 修复：AC2 错误高亮占位可达性；AC3/AC4 提交 payload 结构断言；统一共享类型导入         | James (Dev) |
| 2025-09-12   | v0.4    | Validation：本地测试套件全部通过并记录覆盖率；请 QA 重新执行 Gate 评审                   | James (Dev) |
