# Story 2.1: Opt Grid Submit

## Status

Ready for Review

## Story

**As a** 策略用户/量化工程师,
**I want** 提交“参数空间寻优（Grid Search）”作业并控制并发与早停策略,
**so that** 我可以在限定资源下高效探索参数组合并尽快得到最优解的候选集合。

## Acceptance Criteria

1. 提交优化作业（父作业）API 可用：`POST /api/v1/optimizations`
   - 请求体至少包含：`versionId`, `paramSpace`；可选：`concurrencyLimit`（默认 2）, `earlyStopPolicy{metric,threshold,mode}`。
   - 响应 202：返回 `{ id, status }`（父作业 id 与状态）。
   - [Source: architecture/05-api-spec.md]
2. 组合上限与参数校验：
   - 服务端根据 `paramSpace` 计算组合数并与项目策略的“组合上限”进行校验，不合规返回 `ApiError`（`E.PARAM_INVALID`）。
   - 记录 `ownerId`、`versionId`、`paramSpace` 等关键字段。
   - [Source: architecture/13-error-handling.md#Error Response Format（TS）]
   - [Source: architecture/04-data-models.md#OptimizationJob]
3. 并发与早停策略：
   - 记录 `concurrencyLimit` 用于下游编排（Python Orchestrator），并保证并发不超过限制。
   - 若提供 `earlyStopPolicy`，在 Orchestrator 中作为任务调度/终止判据（基于目标 `metric` 与 `threshold` 及 `mode=min|max`）。
   - [Source: architecture/08-backend-architecture.md#Service Architecture]
4. 鉴权与多租户安全：
   - 仅鉴权用户可提交；从 JWT 中解析 `ownerId` 并写入父作业记录。
   - [Source: architecture/08-backend-architecture.md#Authentication and Authorization]
5. 测试与质量门：
   - 单测：API 请求校验、错误路径、参数空间上限校验逻辑。
   - 集成：提交优化作业成功/参数无效/未鉴权 401 分支。
   - E2E：通过 UI 提交最小参数空间，收到父作业 `id`，并可在稍后查询到状态。
   - [Source: architecture/11-testing-strategy.md]

## Dependencies & Flow Fit

- 前置：`Story 1.x Backtest Submit/Status/Result` 已具备基础回测作业与结果查询能力；本故事在其之上引入“父作业（OptimizationJob）”与“子任务（OptimizationTask）”的提交与编排入口。
- 位置：开启 Epic 2 的参数寻优能力，为后续 2.2/2.3 的“并发编排/早停/聚合”打基础。

## Tasks / Subtasks

- [x] API（Next.js Routes）
  - [x] 新增 `apps/web/src/app/api/optimizations/route.ts`，导出 `POST`，校验请求体并返回 202。
        - [Source: architecture/08-backend-architecture.md#Service Architecture]
        - [Source: architecture/05-api-spec.md#paths /optimizations]
  - [x] 复用 `getOwner()` 中间件解析 JWT → `ownerId`；未鉴权返回 401（`E.AUTH`）。
        - [Source: architecture/08-backend-architecture.md#Authentication and Authorization]
        - [Source: architecture/13-error-handling.md#Backend Error Handling（TS，API 层）]
  - [x] 参数与上限校验：计算 `paramSpace` 组合数（简单笛卡尔积估算），超过上限返回 `fail('E.PARAM_INVALID', 'param space too large', { limit, estimate })`。
        - [Source: architecture/13-error-handling.md#Error Response Format（TS）]
  - [x] 按约定写入存储（或调用内部 Orchestrator 接口）创建父作业记录，响应 `{ id, status: 'queued' }`。
        - [Source: architecture/08-backend-architecture.md#Service Architecture]
        - [Source: architecture/04-data-models.md#OptimizationJob]
  - [x] 集成测试：成功（202）/参数无效（400）/未鉴权（401）分支。
        - [Source: architecture/11-testing-strategy.md#Test Organization]

- [x] 内部 Orchestrator（Python, FastAPI 入口占位）
  - [x] 在 `services/backtest/app/main.py` 或 `orchestrator.py` 添加内部端点/函数以接收父作业创建请求，记录 `concurrency_limit` 与 `early_stop_policy` 并持久化。
        - [Source: architecture/08-backend-architecture.md#传统服务（Python FastAPI：Backtest/Optimization 服务）]
        - [Source: architecture/04-data-models.md#OptimizationJob]
  - [x] 生成子任务计划（仅占位）：根据 `paramSpace` 展开组合，不实际执行（2.2/2.3 实现并发与早停）。
  - [x] Pytest：最小化断言创建父作业记录成功与参数无效路径。
        - [Source: architecture/11-testing-strategy.md#Test Organization]

- [x] 数据与结构
- [x] 数据表/模型：确认/迁移 `optimization_jobs` 与 `optimization_tasks` 及索引（如 `idx_opt_tasks_job`）。
        - [Source: architecture/08-backend-architecture.md#Database Architecture]
  - [x] 记录 `owner_id, version_id, param_space, concurrency_limit, early_stop_policy, status, summary` 字段。
        - [Source: architecture/04-data-models.md#OptimizationJob]

- [x] 错误与可观测性
  - [x] 统一错误包装 `fail()/wrap()`；对 4xx/5xx 输出 `ApiError`，前端可映射用户提示。
        - [Source: architecture/13-error-handling.md#Backend Error Handling（TS，API 层）]
  - [x] API 路由计时与标签（route/status），复用最小 OTel 封装。
        - [Source: architecture/14-monitoring-and-observability.md]

- [x] 文档与示例
  - [x] 在 `docs/architecture/05-api-spec.md` 中核对 `/optimizations` 请求/响应骨架与字段对齐。
  - [x] 在 `docs/architecture/04-data-models.md` 与数据库片段中补充/对齐字段。

## Dev Notes

- 技术栈与位置：
  - API 层采用 Next.js API Routes，实现 `POST /api/v1/optimizations`；Python FastAPI 作为 Orchestrator 内部服务。
    - [Source: architecture/08-backend-architecture.md#Service Architecture]
  - 鉴权解析 `ownerId`，仅鉴权用户可提交。
    - [Source: architecture/08-backend-architecture.md#Authentication and Authorization]

- 数据模型与持久化：
  - `OptimizationJob`（父）与 `OptimizationTask`（子）模型，记录并发上限、早停策略、参数空间与状态/摘要。
    - [Source: architecture/04-data-models.md#OptimizationJob]
    - [Source: architecture/04-data-models.md#OptimizationTask]
  - 数据库表与索引：`optimization_jobs`、`optimization_tasks`、`idx_opt_tasks_job`。
    - [Source: architecture/08-backend-architecture.md#Database Architecture]

- API 契约：
  - `/optimizations` 请求体：`versionId`, `paramSpace`, 可选 `concurrencyLimit`, `earlyStopPolicy{metric,threshold,mode}`；返回 `{ id, status }`。
    - [Source: architecture/05-api-spec.md#paths /optimizations]

- 错误处理：
  - 统一 `ApiError` 与 `wrap()/fail()`，参数无效→`E.PARAM_INVALID`；未鉴权→`E.AUTH`；上游失败→`E.DEP_UPSTREAM` 等。
    - [Source: architecture/13-error-handling.md#Error Response Format（TS）]
    - [Source: architecture/13-error-handling.md#Backend Error Handling（TS，API 层）]

- 测试要求：
  - 单测/集成按金字塔组织；API 路由测试位于 `apps/web/src/app/api/**/__tests__/*.test.ts`；Python Pytest 位于 `services/backtest/tests/`。
    - [Source: architecture/11-testing-strategy.md#Test Organization]

### Env & Config

- 继承现有环境变量与可观测性配置；不引入新的外部依赖。
- 可选：设置参数组合上限（如 `OPT_PARAM_SPACE_MAX=500`）作为校验阈值，便于在不同环境下调整。

### Testing（Standards & Hooks）

- 单测：
  - API：payload 校验（含默认值）、鉴权、上限校验、错误包装结构。
  - Python：Orchestrator 接口最小路径；参数无效分支。
- 集成：
  - API 成功（202）/参数无效（400）/未鉴权（401）；
- E2E：
  - 通过 UI 提交最小参数空间，收到父作业 id 并能在列表/状态页看到记录（后续故事可加强）。
- [Source: architecture/11-testing-strategy.md]

## Project Structure Notes

- 代码位置建议：
  - `apps/web/src/app/api/optimizations/route.ts`
  - `apps/web/src/app/api/optimizations/[id]/status/route.ts`（后续故事使用）
  - `apps/web/src/app/api/_lib/handler.ts`（错误包装）
  - `apps/web/src/app/api/_lib/otel.ts`（路由指标）
  - `services/backtest/app/orchestrator.py`（父作业创建/并发/早停编排）
  - `services/backtest/app/models.py`（pydantic schema 与数据模型）

## Change Log

| Date (UTC+8) | Version | Description | Author |
| ------------ | ------- | ----------- | ------ |
| 2025-09-22   | v0.1    | Initial Draft created from PRD Epic 2 Story 2.1 | Bob (SM) |
| 2025-09-22   | v0.2    | Address QA findings: orchestrator auth, concurrency limit enforcement, version ownership guard | James (Dev) |

## Dev Agent Record

### Agent Model Used

- Cascade

### Debug Log References

- .ai/debug-log.md

### Completion Notes

- 实现 `POST /api/v1/optimizations` 路由，加入鉴权、参数空间估算与并发/早停校验，并通过 in-memory/远端 orchestrator 客户端统一调度（apps/web/src/app/api/v1/optimizations/route.ts:1、apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:1、apps/web/src/app/api/v1/optimizations/paramSpace.ts:1）。
- 新增 Python Orchestrator 逻辑与 FastAPI 入口以记录父作业并生成子任务占位数据，包含可复用的调试接口（services/backtest/app/orchestrator.py:1、services/backtest/app/main.py:1）。
- 执行 `pnpm --filter web test` 与 `python3 -m pytest services/backtest/tests` 验证 API 集成测试及 Pytest 覆盖关键路径。
- 同步 `docs/schema.sql`，补充 `strategy_versions`、`result_summaries`、`optimization_jobs`、`optimization_tasks` 等表结构并扩展 `run_status` 枚举（docs/schema.sql:1）。
- 更新 Orchestrator 存储结构，记录父作业 `summary` 占位与子任务 `owner_id/version_id` 等字段，新增对应 Pytest 校验（services/backtest/app/orchestrator.py:1、services/backtest/tests/test_orchestrator.py:1）。
- 补充共享契约类型与文档：`packages/shared/src/optimization.ts`、`docs/architecture/04-data-models.md`、`docs/architecture/05-api-spec.md`，并运行 `pnpm --filter web test` 全量覆盖。
- 引入版本所有权校验模块，阻断跨租户提交并支持测试种子（apps/web/src/app/api/v1/optimizations/versionOwnership.ts:1、apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts:1）。
- 为远程 orchestrator 增加共享密钥鉴权、请求 ID 与指数退避重试，并在 FastAPI 入口校验密钥及 owner header，同时强制并发上限（apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:1、services/backtest/app/main.py:1、services/backtest/app/orchestrator.py:1）。
- 运行 `pnpm --filter web test` 与 `python3 -m pytest services/backtest/tests` 验证新增安全/可靠性测试（apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts:1、services/backtest/tests/test_main_internal_optimizations.py:1、services/backtest/tests/test_orchestrator.py:1）。

### File List

- apps/web/src/app/api/v1/optimizations/route.ts
- apps/web/src/app/api/v1/optimizations/orchestratorClient.ts
- apps/web/src/app/api/v1/optimizations/versionOwnership.ts
- apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts
- services/backtest/app/orchestrator.py
- services/backtest/app/main.py
- services/backtest/tests/test_orchestrator.py
- services/backtest/tests/test_main_internal_optimizations.py

## QA Results

- **Traceability Report**: `docs/qa/assessments/2.1-trace-20250922.md`
- **Coverage Summary**:
  - Total Requirements: 5
  - Fully Covered: 2
  - Partially Covered: 3
  - Not Covered: 0
- **Key Findings**:
  - AC1：集成用例验证成功路径能够记录 `ownerId`、并发与早停策略，在内存编排路径下保持一致（apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts:35）。
  - AC2：Python 单测覆盖参数空间上限与并发上限校验，超过限制时抛出 `E.PARAM_INVALID`（services/backtest/tests/test_orchestrator.py:62）。
  - AC3：远程编排错误统一被包装成 `E.DEP_UPSTREAM`，丢失 `E.PARAM_INVALID` 等业务错误码，违反 AC2/AC3 的统一错误格式要求（apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:103）。
  - AC5：未发现 UI 端到端提交流程用例，验收标准要求的 UI→API→状态查询闭环缺失。
- **Blocking Issues**:
  1. 远程 orchestrator 返回的 `E.PARAM_INVALID` 被转换为 `E.DEP_UPSTREAM`，客户端无法区分参数错误（apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:103）。
  2. 缺失 UI E2E 提交流程，无法验证核心用户路径（未检测到相关 Playwright/Cypress 用例）。
- **Recommended Actions**:
  - 在 `buildRemoteError` 中透传远程错误码并映射本地 `E.PARAM_INVALID`/`E.FORBIDDEN` 等语义，同时补充远程路径的集成测试。
  - 为 `/optimizations` 表单编写 UI E2E（提交成功、参数无效、鉴权失败）并在 CI 中运行。

### QA Review 2025-09-23 (Quinn)

- **Evidence**:
  - API 集成测试：`apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts`。
  - Orchestrator 单测：`services/backtest/tests/test_orchestrator.py`。
  - 内部 FastAPI 入口测试：`services/backtest/tests/test_main_internal_optimizations.py`。
- **Assessment Update**:
  - **AC1**：API 成功路径证据充分，但仅覆盖内存编排；远程路径缺测试。
  - **AC2**：参数空间/上限验证在当地通过，但远程路径错误码不符合规范。
  - **AC3**：早停策略在内存/后端落库，惟缺少远程交付验证，且错误码缺陷阻断。
  - **AC4**：鉴权/多租户校验在集成测试中覆盖 401/403 分支。
  - **AC5**：自动化闭环缺少 UI E2E，验收要求未满足。
- **Gate Decision**: FAIL
  - Rationale: 远程 orchestrator 错误码映射导致参数校验失效，且 UI 端到端验证缺席，无法确保核心场景可运行。
