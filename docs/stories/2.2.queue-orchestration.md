# Story 2.2: Queue Orchestration

## Status

Approved

## Story

**As a** 参数寻优编排服务维护者,
**I want** 将父级寻优作业拆分为受控并发的子任务并管理排队/重试/聚合流程,
**so that** 我们能够在资源可控的前提下持续执行大规模参数网格寻优并向用户提供实时进度与 Top-N 结果。

## Acceptance Criteria

1. 父作业拆分与子任务入队：将 `OptimizationJob` 的 `paramSpace` 归一化为子任务集合，并将任务入 Redis 队列或内部调度池，同时记录 `optimization_tasks`（含 `owner_id`、`params`、`status`）。
   [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
   [Source: architecture/04-data-models.md#OptimizationTask（子）]
2. 并发闸门与排队限制：Orchestrator 维护父作业的并发计数与排队阈值，确保激活的子任务数不超过 `concurrencyLimit`，并提供超限时的排队/延迟执行策略（含指标或诊断字段）。
   [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
   [Source: docs/qa/assessments/2.1-risk-20250922.md#Critical Risks Requiring Immediate Attention]
3. 重试与指数退避：对执行失败的子任务按错误类型（参数/上游/内部）应用指数退避重试并维护重试次数+最后错误信息，避免无限重试和资源放大。
   [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
   [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
4. 进度聚合与 Top-N：父作业 `summary` 字段实时维护 `total`、`finished`、`running`、`throttled`、`topN[{ taskId, score }]`，并在 `GET /api/v1/optimizations/{id}/status` 对外暴露。
   [Source: architecture/04-data-models.md#OptimizationJob（父）]
   [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
5. 测试与质量门：
   - 单测：Orchestrator 并发闸门/退避策略、Top-N 更新、状态聚合。
   - 集成：`POST /api/v1/optimizations` → Orchestrator → 任务入队/限流 → 状态查询的正反路径。
   - E2E：UI 通过提交寻优作业后在状态页看到进度/Top-N 的展示。
   [Source: architecture/11-testing-strategy.md#Test Organization]
   [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Dependencies & Flow Fit

- 前置：`Story 2.1 Opt Grid Submit` 已提供父作业提交、参数归一化与基本存储逻辑，本故事在此基础上实现真正的排队调度与进度聚合。
  [Source: docs/stories/2.1.opt-grid-submit.md#Tasks / Subtasks]
- 后续：`Story 2.3 Workers & Early Stop` 将消费子任务并处理早停/取消；`Story 2.4 Progress & Aggregation` 拓展 UI 汇总展示。
  [Source: docs/prd/epic-details.md#Epic 2: Grid Optimization & Queue Orchestration]
- 关联风险：OPS-201 指出并发限制若未生效将导致资源放大，本故事需闭环此风险。
  [Source: docs/qa/assessments/2.1-risk-20250922.md#OPS-201]

## Tasks / Subtasks

- [x] API（Next.js Routes）
  - [x] 扩展 `POST /api/v1/optimizations`：在响应中指示是否触发排队节流（如 `x-queue-throttled`），并调用新 orchestrator 方法传入 ownerId/concurrency 信息。
        [Source: architecture/08-backend-architecture.md#Service Architecture]
        [Source: architecture/13-error-handling.md#Backend Error Handling（TS，API 层）]
  - [x] 新增 `GET /api/v1/optimizations/{id}/status` 路由，聚合父作业 summary/子任务统计并返回。
        [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
        [Source: architecture/04-data-models.md#OptimizationJob（父）]
  - [x] 集成测试：验证成功路径、超限排队、未鉴权/跨租户拒绝。
        [Source: architecture/11-testing-strategy.md#Test Organization]

- [x] Orchestrator（Python FastAPI + 调度核心）
  - [x] 实现并发闸门：维护 active/queued 列表，超出 `concurrency_limit` 的任务排队待调度；提供 `dequeue_next()` 供 Worker 取任务。
        [Source: architecture/08-backend-architecture.md#传统服务（Python FastAPI：Backtest/Optimization 服务）]
        [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
  - [x] 引入重试控制：记录 `retries`、`nextRunAt`、最近错误码，应用指数退避（最大重试次数可配置）。
        [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
        [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
  - [x] 更新 `summary`：实时刷新 `finished`、`running`、`throttled`、Top-N，暴露内部调试端点（仅内网）。
        [Source: architecture/04-data-models.md#OptimizationJob（父）]
  - [x] Pytest：覆盖并发闸门、退避、Top-N 更新以及 owner 校验。
        [Source: architecture/11-testing-strategy.md#Test Organization]

- [ ] Workers（Python 执行层）
  - [ ] 新增消费入口：从 orchestrator 获取下一个任务，执行回测占位逻辑，回写结果/错误并触发聚合刷新。
        [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
  - [ ] 错误分类：根据异常类型转化为参数/上游/内部并推动退避策略。
        [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
  - [ ] 单测：模拟成功/失败/退避场景，断言状态与重试次数。
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]

- [ ] 数据与持久化
  - [ ] 若使用数据库：为 `optimization_tasks` 添加 `next_run_at`、`throttled`、`last_error` 字段；增设索引支持按 `status/next_run_at` 拉取。
        [Source: architecture/08-backend-architecture.md#Database Architecture]
  - [ ] 如暂用内存实现：对 `_STORE/_TASKS` 增加并发安全机制，并记录摘要字段。
        [Source: services/backtest/app/orchestrator.py]

- [ ] 可观测性与告警
  - [ ] 打点 `queue_wait_seconds`、`active_jobs`、`throttled_requests` 并输出结构化日志。
        [Source: architecture/14-monitoring-and-observability.md#指标基线（示例）]
        [Source: architecture/14-monitoring-and-observability.md#Monitoring Stack]
  - [ ] 指标/日志测试：验证指标开关下仍能记录并发/排队信息。
        [Source: architecture/11-testing-strategy.md#Test Organization]

## Dev Notes

### Previous Story Insights

- 当前 `create_optimization_job` 仅归一化参数并生成内存任务列表，未真正调度或限制并发；本实现需在此基础上扩展调度层。
  [Source: docs/stories/2.1.opt-grid-submit.md#Tasks / Subtasks]
  [Source: services/backtest/app/orchestrator.py]
- API 层已提供 `x-param-space-estimate` 与 `x-concurrency-limit`，可复用这些信息在响应中提示节流状态。
  [Source: apps/web/src/app/api/v1/optimizations/route.ts]

### Data & State Model

- `OptimizationJob.summary` 将在本故事填充 `total/finished/topN` 与 `throttled` 字段，确保结构与共享类型保持一致。
  [Source: architecture/04-data-models.md#OptimizationJob（父）]
- `OptimizationTask` 需要追加 `nextRunAt`/`lastError`/`score` 等字段用于退避与 Top-N 排序，可依据数据模型扩展。
  [Source: architecture/04-data-models.md#OptimizationTask（子）]

### Queue & Retry Strategy

- 队列调度遵循“父作业拆分 → 控制并发 → 重试/早停”流程；指数退避建议采用 2^n * base（例如 0.5s, 1s, 2s...）。
  [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
  [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
- 重试次数和分类需统一与 `ParamInvalid`/`UpstreamError` 等异常的错误码映射。
  [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]

### Project Structure Notes

- 逻辑位置建议：
  - `services/backtest/app/orchestrator.py`（调度核心、Top-N 聚合）
  - `services/backtest/app/main.py`（新增任务获取/状态查询内部端点）
  - `apps/web/src/app/api/v1/optimizations/[id]/status/route.ts`（父作业状态查询）
  - `apps/web/src/app/api/v1/optimizations/orchestratorClient.ts`（扩展远端调用、节流反馈）
  - `packages/shared/src/optimization.ts`（同步类型扩展）
  [Source: architecture/08-backend-architecture.md#Service Architecture]
  [Source: architecture/02-high-level-architecture.md#Repository Structure（建议）]

### Env & Config

- 新增/复用环境变量：`OPT_CONCURRENCY_LIMIT_MAX`、`OPT_QUEUE_THROTTLE`, `OPT_RETRY_MAX`, `OPT_RETRY_BASE_DELAY_MS`，并在 dev/staging 提供默认值。
  [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
  [Source: architecture/09-deployment-architecture.md#Deployment Strategy]

### Testing（Standards & Hooks）

- Pytest 覆盖：并发闸门、退避、Top-N 更新、owner 校验。
  [Source: architecture/11-testing-strategy.md#Test Organization]
- API 集成：提交→节流→状态查询→跨租户拒绝。
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]
- E2E：`/optimizations/{id}` 页面显示总任务/完成数与 Top-N；验证节流提示。
  [Source: architecture/07-frontend-architecture.md#Routing Architecture]
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Testing

- 单测：Orchestrator 并发调度、退避、Top-N 聚合；Worker 错误分类。
  [Source: architecture/11-testing-strategy.md#Test Organization]
- 集成：API 提交 → Orchestrator 内部 → 状态查询；验证节流与 owner 校验。
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]
- E2E：Dashboard 优化状态页显示排队/Top-N 信息并在节流时提示用户。
  [Source: architecture/07-frontend-architecture.md#Routing Architecture]

## Change Log

| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-09-23 | v0.1    | Draft story created (SM)    | Bob    |

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex（系统预设）

### Debug Log References

- `pnpm --filter web test`
- `python3 -m pytest services/backtest/tests`

### Completion Notes List

- 完成 API 节流响应与状态查询新路由，前端服务层同步扩展查询函数。
- Python 编排器引入并发闸门、指数退避与 Top-N 聚合，新增内部状态查询端点。
- 补充 Vitest 与 Pytest 覆盖，验证节流、跨租户权限及重试逻辑。

### File List

- apps/web/src/app/api/v1/optimizations/route.ts
- apps/web/src/app/api/v1/optimizations/[id]/status/route.ts
- apps/web/src/app/api/v1/optimizations/orchestratorClient.ts
- apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts
- apps/web/src/app/api/v1/optimizations/__tests__/status.route.int.test.ts
- apps/web/src/services/optimizations.ts
- packages/shared/src/optimization.ts
- services/backtest/app/orchestrator.py
- services/backtest/app/main.py
- services/backtest/tests/test_orchestrator.py
- services/backtest/tests/test_main_internal_optimizations.py

## QA Results

### 2025-09-23 风险评估

- 新建风险评估：`docs/qa/assessments/2.2-risk-20250923.md`
- 高风险项：TECH-301（并发闸门一致性）与 PERF-210（队列堆积吞吐）需在开发阶段闭环。
- 建议：上线前完成并发冲击测试、退避场景回放，并配置排队/节流指标与告警。

### 2025-09-23 测试设计

- 新建测试设计：`docs/qa/assessments/2.2-test-design-20250923.md`
- 场景总计 11（P0:6、P1:5），涵盖单元 4、集成 5、端到端 2，覆盖全部 AC 与主要风险。
- 重点执行顺序：先跑并发/退避相关 P0 单测与集成测试，再执行节流体验与 UI 端到端校验。
