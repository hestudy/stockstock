# Story 2.2: Queue Orchestration

## Status

Ready for Review

## Story

**As a** 参数寻优编排服务维护者,
**I want** 将父级寻优作业拆分为受控并发的子任务并管理排队/重试/聚合流程,
**so that** 我们能够在资源可控的前提下持续执行大规模参数网格寻优并向用户提供实时进度与 Top-N 结果。

## Acceptance Criteria

1. 父作业拆分与子任务入队：将 `OptimizationJob` 的 `paramSpace` 归一化为子任务集合，并将任务入 Redis 队列或内部调度池，同时记录 `optimization_tasks`（含 `owner_id`、`params`、`status`）。
   [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
   [Source: architecture/04-data-models.md#OptimizationTask（子）]
2. 并发闸门与排队限制：Orchestrator 维护父作业的并发计数与排队阈值，确保激活的子任务数不超过 `concurrencyLimit`，并提供超限时的排队/延迟执行策略（含指标或诊断字段）。
   [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
   [Source: docs/qa/assessments/2.1-risk-20250922.md#Critical Risks Requiring Immediate Attention]
3. 重试与指数退避：对执行失败的子任务按错误类型（参数/上游/内部）应用指数退避重试并维护重试次数+最后错误信息，避免无限重试和资源放大。
   [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
   [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
4. 进度聚合与 Top-N：父作业 `summary` 字段实时维护 `total`、`finished`、`running`、`throttled`、`topN[{ taskId, score }]`，并在 `GET /api/v1/optimizations/{id}/status` 对外暴露。
   [Source: architecture/04-data-models.md#OptimizationJob（父）]
   [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
5. 测试与质量门：
   - 单测：Orchestrator 并发闸门/退避策略、Top-N 更新、状态聚合。
   - 集成：`POST /api/v1/optimizations` → Orchestrator → 任务入队/限流 → 状态查询的正反路径。
   - E2E：UI 通过提交寻优作业后在状态页看到进度/Top-N 的展示。
   [Source: architecture/11-testing-strategy.md#Test Organization]
   [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Dependencies & Flow Fit

- 前置：`Story 2.1 Opt Grid Submit` 已提供父作业提交、参数归一化与基本存储逻辑，本故事在此基础上实现真正的排队调度与进度聚合。
  [Source: docs/stories/2.1.opt-grid-submit.md#Tasks / Subtasks]
- 后续：`Story 2.3 Workers & Early Stop` 将消费子任务并处理早停/取消；`Story 2.4 Progress & Aggregation` 拓展 UI 汇总展示。
  [Source: docs/prd/epic-details.md#Epic 2: Grid Optimization & Queue Orchestration]
- 关联风险：OPS-201 指出并发限制若未生效将导致资源放大，本故事需闭环此风险。
  [Source: docs/qa/assessments/2.1-risk-20250922.md#OPS-201]

## Tasks / Subtasks

- [x] API（Next.js Routes）
  - [x] 扩展 `POST /api/v1/optimizations`：在响应中指示是否触发排队节流（如 `x-queue-throttled`），并调用新 orchestrator 方法传入 ownerId/concurrency 信息。
        [Source: architecture/08-backend-architecture.md#Service Architecture]
        [Source: architecture/13-error-handling.md#Backend Error Handling（TS，API 层）]
  - [x] 新增 `GET /api/v1/optimizations/{id}/status` 路由，聚合父作业 summary/子任务统计并返回。
        [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
        [Source: architecture/04-data-models.md#OptimizationJob（父）]
  - [x] 集成测试：验证成功路径、超限排队、未鉴权/跨租户拒绝。
        [Source: architecture/11-testing-strategy.md#Test Organization]

- [x] Orchestrator（Python FastAPI + 调度核心）
  - [x] 实现并发闸门：维护 active/queued 列表，超出 `concurrency_limit` 的任务排队待调度；提供 `dequeue_next()` 供 Worker 取任务。
        [Source: architecture/08-backend-architecture.md#传统服务（Python FastAPI：Backtest/Optimization 服务）]
        [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
  - [x] 引入重试控制：记录 `retries`、`nextRunAt`、最近错误码，应用指数退避（最大重试次数可配置）。
        [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
        [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
  - [x] 更新 `summary`：实时刷新 `finished`、`running`、`throttled`、Top-N，暴露内部调试端点（仅内网）。
        [Source: architecture/04-data-models.md#OptimizationJob（父）]
  - [x] Pytest：覆盖并发闸门、退避、Top-N 更新以及 owner 校验。
        [Source: architecture/11-testing-strategy.md#Test Organization]

- [x] Workers（Python 执行层）
  - [x] 新增消费入口：从 orchestrator 获取下一个任务，执行回测占位逻辑，回写结果/错误并触发聚合刷新。
        [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
  - [x] 错误分类：根据异常类型转化为参数/上游/内部并推动退避策略。
        [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]
  - [x] 单测：模拟成功/失败/退避场景，断言状态与重试次数。
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]

- [x] 数据与持久化
  - [x] 若使用数据库：为 `optimization_tasks` 添加 `next_run_at`、`throttled`、`last_error` 字段；增设索引支持按 `status/next_run_at` 拉取。
        [Source: architecture/08-backend-architecture.md#Database Architecture]
  - [x] 如暂用内存实现：对 `_STORE/_TASKS` 增加并发安全机制，并记录摘要字段。
        [Source: services/backtest/app/orchestrator.py]

- [x] 可观测性与告警
  - [x] 打点 `queue_wait_seconds`、`active_jobs`、`throttled_requests` 并输出结构化日志。
        [Source: architecture/14-monitoring-and-observability.md#指标基线（示例）]
        [Source: architecture/14-monitoring-and-observability.md#Monitoring Stack]
  - [x] 指标/日志测试：验证指标开关下仍能记录并发/排队信息。
        [Source: architecture/11-testing-strategy.md#Test Organization]

## Dev Notes

### Previous Story Insights

- 当前 `create_optimization_job` 仅归一化参数并生成内存任务列表，未真正调度或限制并发；本实现需在此基础上扩展调度层。
  [Source: docs/stories/2.1.opt-grid-submit.md#Tasks / Subtasks]
  [Source: services/backtest/app/orchestrator.py]
- API 层已提供 `x-param-space-estimate` 与 `x-concurrency-limit`，可复用这些信息在响应中提示节流状态。
  [Source: apps/web/src/app/api/v1/optimizations/route.ts]

### Data & State Model

- `OptimizationJob.summary` 将在本故事填充 `total/finished/topN` 与 `throttled` 字段，确保结构与共享类型保持一致。
  [Source: architecture/04-data-models.md#OptimizationJob（父）]
- `OptimizationTask` 需要追加 `nextRunAt`/`lastError`/`score` 等字段用于退避与 Top-N 排序，可依据数据模型扩展。
  [Source: architecture/04-data-models.md#OptimizationTask（子）]

### Queue & Retry Strategy

- 队列调度遵循“父作业拆分 → 控制并发 → 重试/早停”流程；指数退避建议采用 2^n * base（例如 0.5s, 1s, 2s...）。
  [Source: architecture/06-components-and-workflows.md#寻优流程：Optimization Submit（含早停/Top-N 聚合）]
  [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
- 重试次数和分类需统一与 `ParamInvalid`/`UpstreamError` 等异常的错误码映射。
  [Source: architecture/13-error-handling.md#Workers Error Classification（Py，片段）]

### Project Structure Notes

- 逻辑位置建议：
  - `services/backtest/app/orchestrator.py`（调度核心、Top-N 聚合）
  - `services/backtest/app/main.py`（新增任务获取/状态查询内部端点）
  - `apps/web/src/app/api/v1/optimizations/[id]/status/route.ts`（父作业状态查询）
  - `apps/web/src/app/api/v1/optimizations/orchestratorClient.ts`（扩展远端调用、节流反馈）
  - `packages/shared/src/optimization.ts`（同步类型扩展）
  [Source: architecture/08-backend-architecture.md#Service Architecture]
  [Source: architecture/02-high-level-architecture.md#Repository Structure（建议）]

### Env & Config

- 新增/复用环境变量：`OPT_CONCURRENCY_LIMIT_MAX`、`OPT_QUEUE_THROTTLE`, `OPT_RETRY_MAX`, `OPT_RETRY_BASE_DELAY_MS`，并在 dev/staging 提供默认值。
  [Source: architecture/10-security-and-performance.md#Queue/Compute SLO]
  [Source: architecture/09-deployment-architecture.md#Deployment Strategy]

### Testing（Standards & Hooks）

- Pytest 覆盖：并发闸门、退避、Top-N 更新、owner 校验。
  [Source: architecture/11-testing-strategy.md#Test Organization]
- API 集成：提交→节流→状态查询→跨租户拒绝。
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]
- E2E：`/optimizations/{id}` 页面显示总任务/完成数与 Top-N；验证节流提示。
  [Source: architecture/07-frontend-architecture.md#Routing Architecture]
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Testing

- 单测：Orchestrator 并发调度、退避、Top-N 聚合；Worker 错误分类。
  [Source: architecture/11-testing-strategy.md#Test Organization]
- 集成：API 提交 → Orchestrator 内部 → 状态查询；验证节流与 owner 校验。
  [Source: architecture/11-testing-strategy.md#Testing Pyramid]
- E2E：Dashboard 优化状态页显示排队/Top-N 信息并在节流时提示用户。
  [Source: architecture/07-frontend-architecture.md#Routing Architecture]

## Change Log

| Date       | Version | Description                 | Author |
| ---------- | ------- | --------------------------- | ------ |
| 2025-09-24 | v0.2    | QA 修复：新增优化详情页与 SLO 覆盖 | James  |
| 2025-09-23 | v0.1    | Draft story created (SM)    | Bob    |

## Dev Agent Record

### Agent Model Used

- GPT-5 Codex（系统预设）

### Debug Log References

- `pnpm --filter web test`
- `pnpm python:test`（缺少 pytest 依赖，受限环境未能安装）
- `python -m pytest services/backtest/tests/test_queue_slo.py`（通过，存在 datetime.utcnow 弃用警告）
- `python -m pytest services/backtest/tests/test_orchestrator.py`
- `pnpm --filter web exec playwright test --project=chromium --grep "Optimizations Detail"`
- `pnpm --filter web test -- --coverage=false src/app/api/v1/optimizations/__tests__/status.route.int.test.ts`
- `pnpm --filter web test -- --coverage=false src/app/api/v1/optimizations/__tests__/status.route.int.test.ts src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx`

### Completion Notes List

- 新增 `/optimizations/{id}` 客户端页面，轮询展示作业状态、队列诊断与 Top-N 列表并提供节流提示。
- 扩展 Playwright 覆盖，验证节流 banner 与 Top-N 排序渲染，闭环 AC4 UI 缺口。
- 编写 `test_queue_slo.py` 负载用例捕获 `queue_wait_seconds` 指标并断言 P95 ≤ 120s。
- 将 Python Orchestrator 测试接入 CI 工作流与本地 `pnpm test`，确保 SLO 校验纳入质量门。
- 本地执行 Vitest 通过；受限网络未能拉取 pytest，需在具备依赖的环境重跑 `pnpm python:test`。
- 修复 orchestrator `create_optimization_job` 返回缺少 `totalTasks` 字段的问题，以恢复 Queue SLO pytest。
- 补充运行 Queue SLO pytest，确认通过并记录 datetime.utcnow 弃用警告待后续治理。
- 调整 orchestrator Top-N 排序依据 `EarlyStopPolicy.mode` 选择升/降序，并补充针对 `mode="min"` 的单测覆盖。
- 修复 Playwright 详情页拦截表达式，确认 stub 正常命中且端到端用例完成 Top-N/节流验证。
- 修复 Next.js 回退 orchestrator Top-N 在 `mode="min"` 时仍按降序的问题，并新增集成测试覆盖最小化排序路径。
- 修复 fallback orchestrator 在存在失败子任务时仍返回 `status="succeeded"` 的问题，并补充集成测试断言失败作业降级。
- 更新优化详情页 Top-N 文案为动态排序提示，并新增 `page.test.tsx` 覆盖升序/降序与回退路径。

### File List

- apps/web/src/app/api/v1/optimizations/route.ts
- apps/web/src/app/api/v1/optimizations/[id]/status/route.ts
- apps/web/src/app/api/v1/optimizations/orchestratorClient.ts
- apps/web/src/app/api/v1/optimizations/__tests__/route.int.test.ts
- apps/web/src/app/api/v1/optimizations/__tests__/status.route.int.test.ts
- apps/web/src/services/optimizations.ts
- packages/shared/src/optimization.ts
- services/backtest/app/orchestrator.py
- services/backtest/app/main.py
- services/backtest/app/observability.py
- services/backtest/app/worker.py
- services/backtest/tests/test_orchestrator.py
- services/backtest/tests/test_main_internal_optimizations.py
- services/backtest/tests/test_observability.py
- services/backtest/tests/test_worker.py
- services/backtest/tests/test_queue_slo.py
- apps/web/src/app/(dashboard)/optimizations/[id]/page.tsx
- apps/web/src/app/(dashboard)/optimizations/[id]/__tests__/page.test.tsx
- apps/web/e2e/optimizations-detail.spec.ts
- package.json
- .github/workflows/web-unit.yml

## QA Results

### 2025-09-23 风险评估

- 新建风险评估：`docs/qa/assessments/2.2-risk-20250923.md`
- 高风险项：TECH-301（并发闸门一致性）与 PERF-210（队列堆积吞吐）需在开发阶段闭环。
- 建议：上线前完成并发冲击测试、退避场景回放，并配置排队/节流指标与告警。

### 2025-09-23 NFR 评估

- 新建 NFR 评估：`docs/qa/assessments/2.2-nfr-20250923.md`
- 结论：可靠性/可观测性存在 Concern，性能缺失 Queue/Compute SLO 验证判定 Fail，安全性通过。
- 建议：引入队列压测与退避性能基线、完善 Redis 故障/并发混乱场景测试，并补齐监控告警回路。

### 2025-09-23 Gate 决议

- Gate 文件：`docs/qa/gates/2.2-queue-orchestration.yml`
- 结果：`CONCERNS`，主要因 AC4 UI Top-N 覆盖缺失与 AC5 Queue/Compute SLO 验证空缺。
- 后续：补充状态页端到端测试、建立 orchestrator 负载基线并将指标校验纳入 CI 后复审。

### 2025-09-23 测试设计

- 新建测试设计：`docs/qa/assessments/2.2-test-design-20250923.md`
- 场景总计 11（P0:6、P1:5），涵盖单元 4、集成 5、端到端 2，覆盖全部 AC 与主要风险。
- 重点执行顺序：先跑并发/退避相关 P0 单测与集成测试，再执行节流体验与 UI 端到端校验。

### 2025-09-23 需求追踪

- 新建追踪矩阵：`docs/qa/assessments/2.2-trace-20250923.md`
- 覆盖率：总计 5 项需求，完全覆盖 3，部分覆盖 1，未覆盖 1（缺少状态页 Playwright 验证与 CI 流水线钩子）。
- 建议：补充 `/optimizations/{id}` 端到端用例与 CI 中的 orchestrator Pytest 任务，闭环 Top-N UI 与质量门缺口。

### 2025-09-25 QA 复审

- Gate 结论：维持 **FAIL**。`services/backtest/app/orchestrator.py` 创建作业时未返回 `totalTasks` 字段，`services/backtest/tests/test_queue_slo.py` 在读取该字段时立即抛出 `KeyError`，导致 Queue/Compute SLO 校验无法执行，CI 将直接失败。
- AC 覆盖：AC1–AC4 通过单元/集成/E2E（`test_orchestrator.py`、`status.route.int.test.ts`、`optimizations-detail.spec.ts` 等）验证，AC5 因上述缺陷仍未闭环。
- 测试状态：Vitest 与 Playwright 用例逻辑正确；`python -m pytest services/backtest/tests/test_queue_slo.py` 现状失败，需先修复 orchestrator 响应再跑全套 Python 测试。
- 建议：补齐 `create_optimization_job` 的响应结构或调整测试依赖，确保 Queue SLO 度量落地后再回归 Gate。

### 2025-09-26 QA 复审

- Gate 结论：仍为 **FAIL**。虽已补齐 `totalTasks` 字段使 Queue SLO 测试能继续执行，但发现 Top-N 聚合在最小化指标场景下排序反转，直接违背 AC4，且 Playwright 覆盖因路由拦截正则写法错误导致始终命中真实 API，无法验证 UI 状态。
- 主要缺陷：
  - `services/backtest/app/orchestrator.py:474` 按得分降序固定排序 Top-N，未参考 `EarlyStopPolicy.mode`。当策略要求 `mode="min"` 时会把较差结果排在前列，UI/API 均返回错误 Top-N。
  - `apps/web/e2e/optimizations-detail.spec.ts:31` 拦截正则写成 `/...\${JOB_ID}.../`，模板字符串未展开，E2E 请求落到真实后端并返回 404，测试无法覆盖目标体验。
- 建议：按 `mode` 决定 Top-N 排序方向，并修正 Playwright 拦截为 `new RegExp(
  ... )` 或字符串匹配后重跑全套测试（含 Queue SLO、Playwright）。

### 2025-09-27 QA 复审

- Gate 结论：降为 **CONCERNS**。在 Next.js 本地编排器回退实现中，Top-N 始终按降序排序，忽略 `EarlyStopPolicy.mode="min"`，导致无远端 orchestrator 时（测试/本地默认配置）状态接口返回的最优列表顺序颠倒，违背 AC4。[apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:314]
- 覆盖观察：Python orchestrator 单测/队列 SLO/worker 测试保持绿色，Playwright 端到端仅验证 `mode="max"` 的降序场景，缺少最小化路径的覆盖。[apps/web/e2e/optimizations-detail.spec.ts:29]
- 建议：在回退实现中根据 `mode` 选择排序方向，同时新增最小化场景（含 UI 断言）的单测/端到端用例，避免回归；修订文案“根据得分降序展示”以匹配 min 模式的展示语义。

### 2025-09-24 QA 复检

- Gate 结论：降级为 **FAIL**。在 Python orchestrator 中，当作业的运行任务达到并发上限时，`summary.throttled`/`diagnostics.queueDepth` 会被错误地归零，无法反映仍在排队的子任务数量，直接违背 AC2/AC4 的排队可视化要求。[services/backtest/app/orchestrator.py:503]
- 复现：创建 `concurrencyLimit=2` 且包含 4 个子任务的作业，连续调用 `dequeue_next` 两次后再执行 `get_job_status`，返回的 `summary.throttled` 为 0 而 `_TASK_ORDER` 仍有 2 个排队任务；脚本验证见 `python - <<'PY' ...`（调试日志已附在 QA 记录）。
- 根因：`_activate_slots` 在计算空槽时未扣除“已就绪但尚未出队”的任务，提前将所有排队任务 `throttled=False`，导致队列深度指标直接丢失。[services/backtest/app/orchestrator.py:504-517]
- 建议：修正 `_activate_slots` 的容量计算（例如仅在缺少非节流队列项时才释放排队任务，或基于 `running + ready_non_throttled` 计算剩余槽位），并补充单元测试覆盖“并发已满时 throttled 仍统计排队任务”的断言，防止同类回归；同步检查 Next.js 回退实现是否需要一致性修补。

### 2025-09-24 QA 复检（晚间）

- 回归验证：在修复 `_activate_slots` 后重跑 `python -m pytest services/backtest/tests/test_orchestrator.py::test_queue_depth_reflects_throttled_when_capacity_full` 与 `python -m pytest services/backtest/tests/test_queue_slo.py`，均通过，确认并发饱和时 `summary.throttled` 与 Queue SLO 基线恢复正常。
- 重大缺陷：本地 fallback orchestrator 在所有任务完成但包含失败结果时仍将作业状态标记为 `succeeded`，未对 `failed`/`canceled` 结果做降级，UI 将出现“成功”假象。[apps/web/src/app/api/v1/optimizations/orchestratorClient.ts:334] 建议：在 `refreshSummary` 中复制 Python 实现的逻辑（检测 `tasks` 中是否存在 `failed` 等终止状态并优先返回 `failed`），并补充针对 fallback 场景的单测。
- 文案风险：Top-N 区块固定显示“根据得分降序展示”，当 `EarlyStopPolicy.mode="min"` 时顺序已按升序排列，提示文案与实际排序矛盾。[apps/web/src/app/(dashboard)/optimizations/[id]/page.tsx:133] 建议：根据 `summary.topN` 序列或追加 `mode` 元数据动态调整提示，或改为中性描述。
- 建议 Gate：**FAIL**。需先修复 fallback 状态错判并补齐验证；文案问题可在同一迭代内一并处理。
