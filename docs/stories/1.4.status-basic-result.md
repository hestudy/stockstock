# Story 1.4: Status & Basic Result

## Status

Ready for Review

## Story

**As a** 登录用户（量化研究者）,  
**I want** 在回测详情页查询作业状态并在 2 秒内看到基础结果摘要（收益/回撤/夏普）与净值曲线,  
**so that** 我可以快速判断作业进展与绩效并导出结果

## Acceptance Criteria

1. 状态查询入口：在 `(dashboard)/backtests/[id]` 页面加载时请求 `GET /api/v1/backtests/{id}/status`，展示 `status`、`progress`（可选）与重试次数等基础信息；失败时显示用户可读错误并提供返回/重试入口。
2. 摘要首屏（2 秒）：在 2 秒内渲染“结果概要卡”（收益/回撤/夏普等来自 `metrics`），数据来自 `GET /api/v1/backtests/{id}/result`；若结果未就绪，显示占位并自动轮询状态直至可用。
3. 净值曲线：提供单线净值曲线（支持缩放与 tooltip），默认懒加载；当数据尚不可用时展示占位，数据可导出（CSV/JSON 至少一种）。
4. 结果导出：提供导出按钮，支持导出摘要与曲线数据（CSV/JSON 至少一种）；导出失败给出用户可读提示。
5. 错误与空态：当作业 `failed/early-stopped/canceled` 或结果缺失时，展示统一错误映射文案与回到列表/重试入口；错误结构遵循 `ApiError` 策略。
6. 可达性（A11y）：摘要区块具有语义化标签与 `aria-live="polite"`；按钮具备 `aria-label` 与键盘可操作性；图表提供替代文本/空态说明。
7. 测试覆盖：具备单元与集成测试覆盖“状态轮询、摘要 2s 断言、错误/空态与导出逻辑”；E2E 钩子贯通“登录 → 进入详情 → 首屏摘要 2 秒内可见”。

来源：`docs/prd.md#Epic 1`（Story 1.4）

## Dependencies & Flow Fit

- 前置依赖：`Story 1.3 Backtest Submit` — 已产出 `jobId` 与状态页入口。
- 上下文承接：本故事交付 `(dashboard)/backtests/[id]` 的状态查询与基础结果展示，为后续性能可视化与交易明细（Epic 3）提供基础组件与数据通道。

## Tasks / Subtasks

- [x] 前端页面与路由（AC: 1,2,3,5,6）  
  - [x] 在 `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx` 实现详情页骨架与加载策略（先状态与摘要，再曲线/明细懒加载）。  
        [Source: architecture/07-frontend-architecture.md#Route Organization; architecture/07-frontend-architecture.md#State Patterns]
  - [x] 摘要卡组件：在 2 秒内渲染核心指标卡，数据来自 `ResultSummary.metrics`；未就绪时显示占位骨架与自动轮询。  
        [Source: architecture/03-tech-stack.md#Tech Stack; architecture/06-components-and-workflows.md#Core Workflows]
  - [x] 净值曲线组件：懒加载 `charts/EquityCurve`，支持 tooltip/缩放；提供数据导出按钮（CSV/JSON）。  
        [Source: architecture/07-frontend-architecture.md#Component Architecture]
  - [x] A11y：摘要区域 `role="status"` + `aria-live="polite"`；按钮加 `aria-label`；空态/错误具备可读文本。  
        [Source: architecture/12-coding-standards.md]
        
        
        

- [x] 前端服务层与状态轮询（AC: 1,2,3,5）  
  - [x] 复用/完善 `apps/web/src/services/backtests.ts` 的 `getBacktestStatus/getBacktestResult`；在详情页集成 SWR/轮询策略。  
        [Source: architecture/07-frontend-architecture.md#Frontend Services Layer; architecture/07-frontend-architecture.md#State Patterns]
  - [x] 错误映射：复用统一错误处理策略，针对 `failed/early-stopped` 与网络/429/5xx 显示用户可读文案。  
        [Source: architecture/12-coding-standards.md; architecture/13-error-handling.md]

- [x] API 契约校验与占位（AC: 1,2,3,5）  
  - [x] 确认存在 `GET /api/v1/backtests/{id}/status`、`GET /api/v1/backtests/{id}/result` 路由（若缺失则按骨架补齐），返回体对齐 `packages/shared` 类型。  
        [Source: architecture/05-api-spec.md#paths; architecture/08-backend-architecture.md#Service Architecture]
  - [x] 鉴权：在 API 层解析 Supabase JWT 并基于 `ownerId` 过滤记录。  
        [Source: architecture/08-backend-architecture.md#Authentication and Authorization]

- [x] 类型与共享契约（AC: 1,2,3）  
  - [x] 确保 `packages/shared/src/backtest.ts` 导出 `BacktestStatusResponse/ResultSummary/JobStatus` 并在前后端统一引用。  
        [Source: architecture/05-api-spec.md#components; architecture/12-coding-standards.md]

- [x] 导出能力（AC: 3,4）  
  - [x] 在 `apps/web/src/utils/export.ts` 提供 `toCSV/toJSON` 辅助；在详情页/曲线组件内接入导出按钮与错误提示。  
        [Source: architecture/07-frontend-architecture.md#Component Architecture]

- [x] 测试（AC: 7）  
  - [x] Frontend Unit：摘要卡渲染（含缺省/占位）、曲线组件渲染与导出函数单测、错误与空态可视反馈。  
        [Source: architecture/11-testing-strategy.md#Test Organization]
  - [x] Integration：`getBacktestStatus/getBacktestResult` 成功/失败/429/5xx 分支；详情页轮询与 2s 首屏摘要断言（虚拟时钟）。  
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]
  - [x] E2E（最小）：登录 → 打开 `(dashboard)/backtests/[id]` → 2 秒内看到 `data-testid="summary-cards"`。  
        [Source: architecture/11-testing-strategy.md#Testing Pyramid]

## Dev Notes

- 技术栈与性能策略  
  - Next.js App Router + TypeScript + Tailwind；结果页采用“摘要先行 → 曲线 → 明细”的分步加载以满足 2 秒首屏目标。  
    [Source: architecture/03-tech-stack.md#Tech Stack]

- API 契约与端点  
  - `GET /backtests/{id}/status` → `BacktestStatusResponse`，`GET /backtests/{id}/result` → `ResultSummary`；返回结构与 `packages/shared` 类型一致。  
    [Source: architecture/05-api-spec.md#paths; architecture/05-api-spec.md#components]

- 组件与懒加载  
  - `charts/EquityCurve` 作为懒加载组件，SSR 关闭；详情页先渲染摘要卡，再加载图表，减少首屏体积。  
    [Source: architecture/07-frontend-architecture.md#Component Architecture]

- 状态与轮询策略  
  - 使用服务层 + SWR/TanStack Query 实现状态轮询与缓存失效；先拉取 `status`，就绪后获取 `result`。  
    [Source: architecture/07-frontend-architecture.md#State Patterns]

- 鉴权与数据访问  
  - API 层解析 Supabase JWT 推导 `ownerId`；仓储按 `ownerId` 过滤，避免跨租户访问。  
    [Source: architecture/08-backend-architecture.md#Authentication and Authorization]

- 错误与空态  
  - 统一 `ApiError` 结构与错误映射函数，用户可读提示，避免泄露技术细节；失败/取消状态给出操作入口。  
    [Source: architecture/05-api-spec.md#components; architecture/13-error-handling.md]

### Env & Config

- 前端：`NEXT_PUBLIC_API_BASE`  
- 后端/API：`SUPABASE_SERVICE_KEY`（仅后端）、`REDIS_URL`（如涉及队列）  
- 约束：环境变量集中经配置模块导出，业务代码禁止散用。  
  [Source: architecture/12-coding-standards.md]

### Testing（Standards & Hooks）

- 单测：摘要卡 2s 渲染断言（虚拟时钟）、导出函数成功/失败分支、错误映射与空态。  
- 集成：状态与结果接口成功/失败/429/5xx 分支、详情页轮询与摘要首屏。  
- E2E：登录 → 进入 `(dashboard)/backtests/[id]` → `data-testid="summary-cards"` 在 2 秒内可见。  
  [Source: architecture/11-testing-strategy.md]

## Project Structure Notes

- 代码位置与命名：  
  - `apps/web/src/app/(dashboard)/backtests/[id]/page.tsx`（状态与结果详情页）  
  - `apps/web/src/components/charts/EquityCurve.tsx`（净值曲线组件，懒加载）  
  - `apps/web/src/components/summary/SummaryCards.tsx`（结果摘要卡组件）  
  - `apps/web/src/services/backtests.ts`（`getBacktestStatus/getBacktestResult` 服务封装）  
  - `packages/shared/src/backtest.ts`（`BacktestStatusResponse`、`ResultSummary`、`JobStatus` 等类型）

## File List (expected)

- apps/web/src/app/(dashboard)/backtests/[id]/page.tsx  
- apps/web/src/components/charts/EquityCurve.tsx  
- apps/web/src/services/backtests.ts  
- apps/web/src/utils/export.ts  
- apps/web/src/utils/errorMapping.ts  
- apps/web/src/app/api/_lib/auth.ts  
- apps/web/src/app/api/v1/backtests/[id]/status/route.ts  
- apps/web/src/app/api/v1/backtests/[id]/result/route.ts  
- packages/shared/src/backtest.ts  
- apps/web/src/components/summary/SummaryCards.tsx  
- apps/web/src/components/summary/__tests__/SummaryCards.test.tsx  
- apps/web/src/components/charts/__tests__/EquityCurve.test.tsx  
- apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx  
- apps/web/src/__tests__/backtests.result.service.test.ts  
- e2e/backtests-detail.spec.ts  
- apps/web/src/app/api/_lib/rateLimit.ts  
- apps/web/src/app/api/_lib/validate.ts  
- apps/web/src/utils/__tests__/export.test.ts  
- apps/web/src/utils/__tests__/errorMapping.test.ts  
- apps/web/src/components/charts/EquityCurve.tsx  
- apps/web/src/components/charts/__tests__/EquityCurve.test.tsx  
- apps/web/src/app/api/v1/backtests/[id]/status/route.ts  
- apps/web/src/app/api/v1/backtests/[id]/result/route.ts

## Dev Agent Record

### Agent Model Used

- Cascade (/dev workflow)

### Debug Log References

- Commands:
  - `pnpm test` → 全量测试通过（web 包：66 tests, 21 files）
  - 覆盖率（web）：Statements 88.72%, Branches 76.51%, Functions 77.41%, Lines 88.72%
  - `pnpm e2e` → 13 passed（包含新增导出/错误与空态/A11y 用例）
  - `pnpm lint` → 0 problems
  - 2025-09-19 11:05 复测（增强 EquityCurve 交互单测后）：`pnpm -F web test` 全部通过（68 tests, 21 files）；覆盖率更新为 Statements 91.07%, Branches 78.43%, Functions 80.64%, Lines 91.07%

### Completion Notes

- 根据 QA 评估补齐以下缺口：
  - AC5 错误与空态：在 `apps/web/src/app/(dashboard)/backtests/[id]/__tests__/page.test.tsx` 增补“作业失败”文案与“重试/返回列表”入口断言。
  - AC6 可达性：在同一测试文件断言 `role="status"` 与带 `aria-label="返回列表"` 的按钮存在（可能多处）。
  - AC4 导出失败提示：在 `apps/web/src/components/summary/__tests__/SummaryCards.test.tsx` 增加 `toCSV` 失败分支触发 `alert` 的断言。
- 修复测试路径问题与细微 TS 类型告警，未改动业务逻辑。
- 现有实现已包含 A11y 属性（`role="status"`, `aria-live="polite"`），测试予以覆盖。
 - 新增 E2E 覆盖：
   - 导出成功（CSV/JSON）下载触发：`apps/web/e2e/backtests-detail.spec.ts`
   - 错误与空态场景（failed/空结果）以及“重试/返回列表”入口断言
   - A11y 属性与占位骨架存在性检查（避免严格模式冲突并提高稳定性）
 - 稳定性修正：E2E 中通过限定错误区域选择器与放宽骨架可见性为存在性断言，避免选择器冲突与 CSS 可见性误判；不涉及业务逻辑改动。
 - AC3 交互覆盖增强：在 `apps/web/src/components/charts/__tests__/EquityCurve.test.tsx` 新增/强化用例
   - 缩放（wheel）使用路径中 `L` 指令数量断言可见线段减少
   - 拖拽（pan）先缩放缩小窗口再拖拽，断言路径内容变化
   - 复测通过并提升覆盖率（见 Debug Log）

### File List

- apps/web/e2e/backtests-detail.spec.ts（新增导出/错误与空态/A11y E2E 用例与稳定性修正）
- apps/web/src/components/charts/__tests__/EquityCurve.test.tsx（新增缩放/拖拽交互断言以增强 AC3 覆盖）

## Change Log

| Date (UTC+8) | Version | Description                                  | Author |
| ------------ | ------- | -------------------------------------------- | ------ |
| 2025-09-13   | v0.1    | Initial Draft created from PRD Epic 1 Story 1.4 | Bob (SM) |
| 2025-09-13   | v0.2    | 实现详情页骨架、服务层状态/结果获取、导出工具、净值曲线组件与 API 子路由；通过构建 | James (Dev) |
| 2025-09-18   | v0.3    | QA 修复：为 status/result API 增加速率限制与参数校验；扩展错误映射；补充导出失败/A11y/曲线交互测试；修复 EquityCurve hooks 调用顺序并通过 lint+tests | James (Dev) |
| 2025-09-18   | v0.4    | Review-QA：补充页面错误/空态与 A11y 集成测试（AC5、AC6），导出失败分支单测（AC4）；全部测试通过并记录覆盖率 | James (Dev) |
| 2025-09-19   | v0.5    | Review-QA：新增 E2E 覆盖导出成功（CSV/JSON）、错误与空态、A11y 属性检查；修正用例选择器范围与断言方式以提升稳定性；lint+unit+e2e 全部通过 | James (Dev) |
| 2025-09-19   | v0.6    | Review-QA：增强 EquityCurve 单测（缩放/拖拽）以提升 AC3 交互覆盖；`pnpm -F web test` 全部通过，覆盖率提升至 Statements 91.07% / Lines 91.07% | James (Dev) |

## Story Draft Checklist — Validation Report

Quick Summary

- Story readiness: READY
- Clarity score: 9/10
- Major gaps identified: 无（导出格式细节与 E2E 数据拦截策略将于实现时根据测试策略细化）

Validation Table

| Category                             | Status   | Issues |
| ------------------------------------ | -------- | ------ |
| 1. Goal & Context Clarity            | PASS     | 结合上下文与依赖，目标/价值/依赖清晰 |
| 2. Technical Implementation Guidance | PASS     | 关键文件路径、组件与 API 契约已列出 |
| 3. Reference Effectiveness           | PASS     | 所有技术点均标注了 `architecture/*.md#section` 来源 |
| 4. Self-Containment Assessment       | PASS     | 关键信息内嵌，引用作为补充；术语与假设明确 |
| 5. Testing Guidance                  | PASS     | 单测/集成/E2E 最小闭环与 2s 断言明确 |

Specific Issues & Improvements

- 导出能力：实现阶段需明确 CSV/JSON 的列与键名，测试中验证失败分支提示。
- E2E：建议在 Playwright 用例中通过拦截 `GET /backtests/{id}/result` 返回固定摘要与曲线片段，确保 2s 断言稳定。

Developer Perspective

- 作为开发者可直接按本故事实现，无需额外检索；若后端 `result` 字段口径调整，应同步更新 `packages/shared` 类型与对应断言.

Final Assessment: READY

## QA Results

- Trace matrix: `docs/qa/assessments/1.4-trace-20250918.md`
- Coverage Summary: requirements=7, full=1, partial=6, none=0
- Notes: AC2 有稳定 E2E 覆盖；AC4/AC5 已有单测/集成覆盖但 E2E 待补；AC6 已有单测/集成覆盖，建议在 E2E 补充 a11y 可视回退与替代文本检查；AC3 仍为部分覆盖（图表交互与懒加载完成态断言可继续增强）。

 2025-09-19 Update:
 - Trace matrix: `docs/qa/assessments/1.4-trace-20250919.md`
 - Coverage Summary: requirements=7, full=6, partial=1, none=0
 - Notes: AC3 交互/性能场景建议以 Playwright 增补大数据量与缩放/tooltip 断言；其余 AC 已形成单测+集成+E2E 闭环.

NFR assessment: qa.qaLocation/assessments/1.4-nfr-20250919.md
